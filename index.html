<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OBAMA DASH">
<meta name="theme-color" content="#00ff41">
<meta name="description" content="Obama Dash — live BTC HTF/LTF confluence dashboard">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>OBAMA DASH // DASHBOARD</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap');
  :root {
    --green:#00ff41;--green-dim:#00aa2a;--green-dark:#003a0f;
    --red:#ff3131;--amber:#ffb300;--cyan:#00ffff;--magenta:#ff00ff;
    --bg:#020c02;--panel:#040f04;--border:#0a2a0a;--text:#00cc33;--text-dim:#008820;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:14px;min-height:100vh;overflow-x:hidden;cursor:crosshair;}
  body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px);pointer-events:none;z-index:9999;}
  body::after{content:'';position:fixed;inset:0;background:rgba(0,255,65,0.015);pointer-events:none;z-index:9998;animation:flicker 0.15s infinite;}
  @keyframes flicker{0%,94%,100%{opacity:1}93%{opacity:0.85}96%{opacity:0.9}}

.header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(–border);background:var(–panel);}
.header-title{font-family:‘VT323’,monospace;font-size:28px;color:var(–green);text-shadow:0 0 10px var(–green),0 0 20px var(–green-dim);letter-spacing:3px;}
.header-title span{color:var(–text-dim);}
.header-meta{display:flex;gap:24px;align-items:center;}
.meta-item{text-align:right;}
.meta-label{color:var(–text-dim);font-size:10px;letter-spacing:2px;text-transform:uppercase;}
.meta-value{color:var(–green);font-size:13px;text-shadow:0 0 6px var(–green-dim);}
.status-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(–green);box-shadow:0 0 8px var(–green);animation:pulse 2s infinite;margin-right:5px;}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 8px var(–green);}50%{opacity:0.4;box-shadow:0 0 2px var(–green-dim);}}

.ticker{overflow:hidden;border-bottom:1px solid var(–border);background:var(–green-dark);padding:4px 0;}
.ticker-inner{display:flex;gap:40px;animation:scroll 40s linear infinite;white-space:nowrap;}
@keyframes scroll{from{transform:translateX(0);}to{transform:translateX(-50%);}}
.ticker-item{font-size:12px;letter-spacing:1px;color:var(–text-dim);}
.ticker-item span{color:var(–green);margin:0 4px;}
.ticker-item .up{color:var(–green);}
.ticker-item .dn{color:var(–red);}

.main-layout{display:grid;grid-template-columns:1fr 320px;grid-template-rows:auto auto;gap:1px;background:var(–border);border:1px solid var(–border);margin:1px;}
.panel{background:var(–panel);}
.panel-chart{grid-row:1/3;display:flex;flex-direction:column;}
.panel-full{grid-column:1/3;}

.panel-header{display:flex;justify-content:space-between;align-items:center;padding:7px 12px;border-bottom:1px solid var(–border);background:var(–green-dark);flex-shrink:0;}
.panel-title{font-family:‘VT323’,monospace;font-size:17px;letter-spacing:3px;color:var(–green);text-shadow:0 0 8px var(–green-dim);}
.panel-tag{font-size:10px;color:var(–text-dim);letter-spacing:2px;}

.chart-controls{display:flex;align-items:center;gap:0;border-bottom:1px solid var(–border);flex-shrink:0;}
.tf-btn{background:var(–panel);border:none;border-right:1px solid var(–border);color:var(–text-dim);font-family:‘Share Tech Mono’,monospace;font-size:10px;padding:5px 14px;cursor:pointer;letter-spacing:2px;transition:all 0.15s;}
.tf-btn:hover{background:var(–green-dark);color:var(–green);}
.tf-btn.active{background:var(–green-dark);color:var(–green);border-bottom:2px solid var(–green);}
.chart-toggle{display:flex;align-items:center;gap:5px;padding:0 10px;font-size:9px;color:var(–text-dim);cursor:pointer;letter-spacing:1px;border-right:1px solid var(–border);height:100%;}
.chart-toggle input{accent-color:var(–green);cursor:pointer;}

.chart-body{flex:1;position:relative;min-height:400px;}
#chart-container{width:100%;height:100%;}

/* CONFLUENCE */
.conf-section{border-bottom:1px solid var(–border);}
.conf-section-hdr{padding:5px 12px;font-size:9px;letter-spacing:3px;color:var(–text-dim);background:rgba(0,0,0,0.3);}
.conf-section-hdr.both{color:var(–amber);border-left:2px solid var(–amber);}
.conf-section-hdr.ratio{color:var(–cyan);border-left:2px solid var(–cyan);}
.conf-section-hdr.htf{color:var(–green);border-left:2px solid var(–green);}

.alert-row{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid var(–border);animation:alertIn 0.3s ease;}
@keyframes alertIn{from{opacity:0;transform:translateX(-6px);}to{opacity:1;transform:translateX(0);}}
.alert-badge{font-size:13px;padding:2px 8px;border-radius:2px;font-family:‘VT323’,monospace;}
.badge-hot{background:rgba(255,49,49,0.15);border:1px solid var(–red);color:var(–red);}
.badge-warm{background:rgba(255,179,0,0.1);border:1px solid var(–amber);color:var(–amber);}
.badge-watch{background:rgba(0,255,65,0.06);border:1px solid var(–green-dim);color:var(–text-dim);}
.badge-both{background:rgba(255,179,0,0.15);border:1px solid var(–amber);color:var(–amber);}
.badge-ratio{background:rgba(0,255,255,0.1);border:1px solid var(–cyan);color:var(–cyan);}
.alert-info{flex:1;}
.alert-levels{font-size:12px;color:var(–green);}
.alert-detail{font-size:10px;color:var(–text-dim);margin-top:2px;}
.alert-price{font-size:12px;color:var(–green);text-align:right;}
.alert-dist{font-size:9px;color:var(–text-dim);text-align:right;}
.no-alerts{padding:18px 12px;color:var(–text-dim);font-size:10px;letter-spacing:2px;text-align:center;}

.lvl-eq{color:#fff;text-shadow:0 0 6px #fff;}
.lvl-pos{color:var(–green);text-shadow:0 0 6px var(–green-dim);}
.lvl-neg{color:var(–red);text-shadow:0 0 4px rgba(255,49,49,0.5);}
.lvl-extreme{color:var(–amber);text-shadow:0 0 6px rgba(255,179,0,0.5);}

/* TRADE TRACKER */
.trade-card{margin:8px 12px;border:1px solid var(–border);border-radius:2px;overflow:hidden;}
.trade-card-header{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:rgba(0,255,65,0.04);border-bottom:1px solid var(–border);}
.trade-dir{font-family:‘VT323’,monospace;font-size:17px;padding:1px 9px;border-radius:2px;}
.dir-long{background:rgba(0,255,65,0.12);border:1px solid var(–green);color:var(–green);}
.dir-short{background:rgba(255,49,49,0.12);border:1px solid var(–red);color:var(–red);}
.trade-body{display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:var(–border);}
.trade-stat{background:var(–panel);padding:7px 10px;}
.stat-label{font-size:8px;color:var(–text-dim);letter-spacing:2px;text-transform:uppercase;}
.stat-value{font-size:13px;color:var(–green);margin-top:2px;}
.stat-pnl-pos{color:var(–green);text-shadow:0 0 6px var(–green-dim);}
.stat-pnl-neg{color:var(–red);}
.progress-bar{height:3px;background:var(–border);margin-top:5px;border-radius:1px;overflow:hidden;}
.progress-fill{height:100%;background:var(–green);box-shadow:0 0 4px var(–green-dim);border-radius:1px;transition:width 0.5s;}
.no-trades{padding:20px 12px;color:var(–text-dim);text-align:center;letter-spacing:2px;font-size:10px;}

.footer{display:flex;justify-content:space-between;align-items:center;padding:7px 16px;border-top:1px solid var(–border);background:var(–panel);}
.footer-left{color:var(–text-dim);font-size:10px;letter-spacing:2px;}
.btn-refresh{background:transparent;border:1px solid var(–green-dim);color:var(–text-dim);font-family:‘Share Tech Mono’,monospace;font-size:10px;padding:4px 12px;letter-spacing:2px;cursor:pointer;transition:all 0.2s;}
.btn-refresh:hover{border-color:var(–green);color:var(–green);background:rgba(0,255,65,0.05);box-shadow:0 0 8px rgba(0,255,65,0.2);}
.countdown{font-size:10px;color:var(–text-dim);letter-spacing:1px;}

/* DRAWING TOOLBAR — TradingView style vertical left bar */
.chart-body{position:relative;}
.tv-toolbar{position:absolute;left:8px;top:12px;z-index:20;display:flex;flex-direction:column;gap:2px;
background:#1a2a1a;border:1px solid #1e3a1e;border-radius:4px;padding:4px;box-shadow:0 4px 16px rgba(0,0,0,0.6);}
.tv-btn{width:32px;height:32px;background:transparent;border:none;border-radius:3px;
display:flex;align-items:center;justify-content:center;cursor:pointer;
color:#6a9a6a;transition:all 0.12s;position:relative;}
.tv-btn:hover{background:#0a2a0a;color:#00ff41;}
.tv-btn.active{background:#0d3a0d;color:#00ff41;box-shadow:inset 0 0 0 1px #00ff4144;}
.tv-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:1.5;stroke-linecap:round;stroke-linejoin:round;}
.tv-btn .tv-tip{position:absolute;left:42px;top:50%;transform:translateY(-50%);
background:#1a2a1a;border:1px solid #1e3a1e;color:#00cc33;
font-family:‘Share Tech Mono’,monospace;font-size:10px;letter-spacing:1px;
padding:3px 8px;border-radius:3px;white-space:nowrap;pointer-events:none;
opacity:0;transition:opacity 0.15s;z-index:30;}
.tv-btn:hover .tv-tip{opacity:1;}
.tv-sep{height:1px;background:#1e3a1e;margin:2px 0;}
#draw-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:10;}
#draw-overlay.drawing{pointer-events:all;}
#draw-overlay.tool-hline{cursor:crosshair;}
#draw-overlay.tool-trend{cursor:crosshair;}
#draw-overlay.tool-rect{cursor:crosshair;}
#draw-overlay.tool-none{cursor:default;}

</style>
</head>
<body>

<div class="header">
  <div class="header-title">OBAMA<span> // </span>DASH <span style="font-size:14px;letter-spacing:2px">// TERMINAL</span></div>
  <nav style="display:flex;gap:12px;align-items:center"><a href="index.html" style="color:var(--green);text-decoration:none;font-size:11px;letter-spacing:2px;border:1px solid var(--green-dim);padding:3px 10px">BTC</a><a href="mnq.html" style="color:var(--text-dim);text-decoration:none;font-size:11px;letter-spacing:2px;border:1px solid var(--border);padding:3px 10px">MNQ</a></nav>
  <div class="header-meta">
    <div class="meta-item"><div class="meta-label">Asset</div><div class="meta-value" id="hdr-symbol">BTCUSDT</div></div>
    <div class="meta-item"><div class="meta-label">Last Price</div><div class="meta-value" id="hdr-price">—</div></div>
    <div class="meta-item"><div class="meta-label">HTF Anchor</div><div class="meta-value" id="hdr-htf-anchor">—</div></div>
    <div class="meta-item"><div class="meta-label">LTF Anchor</div><div class="meta-value" id="hdr-ltf-anchor">—</div></div>
    <div class="meta-item"><div class="meta-label">Status</div><div class="meta-value"><span class="status-dot"></span><span id="hdr-status">LIVE</span></div></div>
  </div>
</div>

<div class="ticker"><div class="ticker-inner" id="ticker-inner"></div></div>

<div class="main-layout">

  <!-- COL 1: LIVE CHART -->

  <div class="panel panel-chart">
    <div class="panel-header">
      <span class="panel-title">LIVE CHART</span>
      <span class="panel-tag" id="chart-mode-tag">HTF // H1 // BINANCE</span>
    </div>
    <div class="chart-controls">
      <button class="tf-btn active" id="btn-htf"       onclick="switchChartMode('HTF')">HTF // H1</button>
      <button class="tf-btn"        id="btn-ltf"       onclick="switchChartMode('LTF')">LTF // M1</button>
      <button class="tf-btn"        id="btn-htf-ratio" onclick="switchChartMode('HTF_RATIO')">HTF // RATIO</button>
      <button class="tf-btn"        id="btn-ratio-m1"  onclick="switchChartMode('RATIO_M1')">RATIO // M1</button>
      <button class="tf-btn"        id="btn-both"      onclick="switchChartMode('BOTH')">M1 // BOTH</button>
      <label class="chart-toggle"><input type="checkbox" id="show-htf-lvl" checked onchange="reloadChartLevels()"> HTF</label>
      <label class="chart-toggle"><input type="checkbox" id="show-ltf-lvl" checked onchange="reloadChartLevels()"> LTF</label>
    </div>

```
<div class="chart-body">
  <div id="chart-container"></div>
  <svg id="draw-overlay"></svg>
  <!-- TradingView-style vertical toolbar -->
  <div class="tv-toolbar">
    <!-- Cursor -->
    <button class="tv-btn active" id="draw-none" onclick="setDrawTool('none')">
      <svg viewBox="0 0 24 24"><path d="M5 3l14 9-7 1-4 7z"/></svg>
      <span class="tv-tip">Cursor</span>
    </button>
    <div class="tv-sep"></div>
    <!-- Trend line -->
    <button class="tv-btn" id="draw-trend" onclick="setDrawTool('trend')">
      <svg viewBox="0 0 24 24"><line x1="4" y1="20" x2="20" y2="4"/><circle cx="4" cy="20" r="1.5" fill="currentColor" stroke="none"/><circle cx="20" cy="4" r="1.5" fill="currentColor" stroke="none"/></svg>
      <span class="tv-tip">Trend Line</span>
    </button>
    <!-- Horizontal line -->
    <button class="tv-btn" id="draw-hline" onclick="setDrawTool('hline')">
      <svg viewBox="0 0 24 24"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="8" x2="21" y2="8" stroke-opacity="0.3"/><line x1="3" y1="16" x2="21" y2="16" stroke-opacity="0.3"/></svg>
      <span class="tv-tip">Horizontal Line</span>
    </button>
    <!-- Vertical line -->
    <button class="tv-btn" id="draw-vline" onclick="setDrawTool('vline')">
      <svg viewBox="0 0 24 24"><line x1="12" y1="3" x2="12" y2="21"/><line x1="8" y1="3" x2="8" y2="21" stroke-opacity="0.3"/><line x1="16" y1="3" x2="16" y2="21" stroke-opacity="0.3"/></svg>
      <span class="tv-tip">Vertical Line</span>
    </button>
    <div class="tv-sep"></div>
    <!-- Rectangle -->
    <button class="tv-btn" id="draw-rect" onclick="setDrawTool('rect')">
      <svg viewBox="0 0 24 24"><rect x="4" y="7" width="16" height="10" rx="1"/></svg>
      <span class="tv-tip">Rectangle</span>
    </button>
    <div class="tv-sep"></div>
    <!-- Undo -->
    <button class="tv-btn" id="draw-undo" onclick="undoDraw()" style="color:#cc8800">
      <svg viewBox="0 0 24 24"><path d="M9 14L4 9l5-5"/><path d="M4 9h11a6 6 0 010 12h-1"/></svg>
      <span class="tv-tip">Undo</span>
    </button>
    <!-- Clear all -->
    <button class="tv-btn" id="draw-clear" onclick="clearDrawings()" style="color:#cc3333">
      <svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      <span class="tv-tip">Clear All</span>
    </button>
  </div>
</div>
```

  </div>

  <!-- COL 2: CONFLUENCE ALERTS -->

  <div class="panel">
    <div class="panel-header">
      <span class="panel-title">CONFLUENCE</span>
      <span class="panel-tag">M1 ∩ HTF // TOL 0.30%</span>
    </div>
    <div id="confluence-panel"></div>
  </div>

  <!-- FULL WIDTH: ACTIVE TRADES -->

  <div class="panel panel-full">
    <div class="panel-header">
      <span class="panel-title">ACTIVE POSITIONS</span>
      <span class="panel-tag">REAL-TIME TRACKING</span>
    </div>
    <div id="trades-panel"></div>
  </div>

</div>

<div class="footer">
  <div class="footer-left">LAST UPDATE: <span id="last-update">—</span> &nbsp;|&nbsp; NEXT REFRESH: <span class="countdown" id="countdown">60s</span></div>
  <div style="display:flex;gap:10px;align-items:center">
    <span style="font-size:10px;color:var(--text-dim)" id="data-status">FETCHING DATA...</span>
    <button id="install-btn" onclick="installApp()" class="btn-refresh" style="display:none;border-color:var(--amber);color:var(--amber)">[ + ADD TO HOME SCREEN ]</button>
    <button class="btn-refresh" onclick="refreshAll()">[ REFRESH ]</button>
  </div>
</div>

<script>
const CONFIG = {
  symbol:'BTCUSDT', htfRatio:73.3458,
  angles:[27,45,60,72,78], tolerance:0.0030, refreshSec:60
};

const ACTIVE_TRADES = [];

// ── CHART STATE ───────────────────────────────────────
let lwChart, candleSeries, chartLevels={}, chartMode='HTF', chartCandles=[];
let htfAnchorTs, ltfAnchorTs, htfAnchorOpen, ltfAnchorOpen;

// ── MATH ──────────────────────────────────────────────
function anglePrice(anchor,bars,deg,ratio){
  return anchor + bars*(ratio||1)*Math.tan(deg*Math.PI/180);
}
function getAllLevels(anchor,bars,ratio){
  const lvls=[{label:'EQ',price:anchor,degree:0}];
  for(const a of CONFIG.angles){
    lvls.push({label:`+${a}`,price:anglePrice(anchor,bars, a,ratio),degree: a});
    lvls.push({label:`-${a}`,price:anglePrice(anchor,bars,-a,ratio),degree:-a});
  }
  return lvls.sort((a,b)=>b.price-a.price);
}

// ── ANCHORS ───────────────────────────────────────────
function getSunday2300(){
  const n=new Date(),d=n.getUTCDay();
  const s=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()-(d===0?0:d),23,0,0));
  if(s>n) s.setUTCDate(s.getUTCDate()-7);
  return s;
}
function getToday0900(){
  const n=new Date();
  return new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),9,0,0));
}

// ── FETCH ─────────────────────────────────────────────
async function fetchCurrentPrice(){
  try{const r=await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${CONFIG.symbol}`);
  const d=await r.json();return parseFloat(d.price);}catch(e){return null;}
}
async function fetchAnchorOpen(interval,ts){
  try{const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=${interval}&startTime=${ts.getTime()}&limit=1`);
  const d=await r.json();return d.length?parseFloat(d[0][1]):null;}catch(e){return null;}
}
async function fetch24hChange(){
  try{const r=await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${CONFIG.symbol}`);
  const d=await r.json();return{change:parseFloat(d.priceChangePercent),high:parseFloat(d.highPrice),low:parseFloat(d.lowPrice),vol:parseFloat(d.volume)};}
  catch(e){return null;}
}
async function fetchCandles(interval,limit){
  try{const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=${interval}&limit=${limit}`);
  const d=await r.json();
  return d.map(k=>({time:k[0]/1000,open:parseFloat(k[1]),high:parseFloat(k[2]),low:parseFloat(k[3]),close:parseFloat(k[4])}));}
  catch(e){return[];}
}

// ── HELPERS ───────────────────────────────────────────
function levelClass(lbl){
  if(lbl==='EQ') return 'lvl-eq';
  const d=Math.abs(parseInt(lbl.slice(1)));
  if(d>=72) return 'lvl-extreme';
  return lbl.startsWith('+')? 'lvl-pos':'lvl-neg';
}
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:1,maximumFractionDigits:1});}

// ── CHART LEVEL COLOURS ───────────────────────────────
function getLevelDefs(type){
  const isRatio = type==='HTF_R';
  // HTF Ratio fan: bright cyan positive, bright magenta negative, white EQ
  if(isRatio) return [
    {label:'EQ',  deg:0,   color:'#ffffff', width:1},
    {label:'+27', deg:27,  color:'#00ffff', width:1},
    {label:'-27', deg:-27, color:'#ff00ff', width:1},
    {label:'+45', deg:45,  color:'#00ffff', width:1},
    {label:'-45', deg:-45, color:'#ff00ff', width:1},
    {label:'+60', deg:60,  color:'#00ffff', width:1},
    {label:'-60', deg:-60, color:'#ff00ff', width:1},
    {label:'+72', deg:72,  color:'#ffdd00', width:2},
    {label:'-72', deg:-72, color:'#ffdd00', width:2},
    {label:'+78', deg:78,  color:'#ffdd00', width:2},
    {label:'-78', deg:-78, color:'#ffdd00', width:2},
  ];
  const h = type==='HTF';
  return [
    {label:'EQ',  deg:0,   color:h?'#ffffff':'#aaaaaa', width:1},
    {label:'+27', deg:27,  color:h?'#00ff41':'#00cc33', width:1},
    {label:'-27', deg:-27, color:h?'#ff3131':'#cc2222', width:1},
    {label:'+45', deg:45,  color:h?'#00ff41':'#00cc33', width:1},
    {label:'-45', deg:-45, color:h?'#ff3131':'#cc2222', width:1},
    {label:'+60', deg:60,  color:h?'#00ff41':'#00cc33', width:1},
    {label:'-60', deg:-60, color:h?'#ff3131':'#cc2222', width:1},
    {label:'+72', deg:72,  color:h?'#ffb300':'#dd9900', width:1},
    {label:'-72', deg:-72, color:h?'#ffb300':'#dd9900', width:1},
    {label:'+78', deg:78,  color:h?'#ffb300':'#dd9900', width:1},
    {label:'-78', deg:-78, color:h?'#ffb300':'#dd9900', width:1},
  ];
}

// ── CHART BUILD ───────────────────────────────────────
function buildChart(){
  const container=document.getElementById('chart-container');
  const body=container.parentElement;
  const h=Math.max(400,window.innerHeight*0.55);
  body.style.height=h+'px'; container.style.height=h+'px';
  lwChart=LightweightCharts.createChart(container,{
    width:container.clientWidth, height:h,
    layout:{background:{color:'#020c02'},textColor:'#00cc33'},
    grid:{vertLines:{color:'#0a2a0a'},horzLines:{color:'#0a2a0a'}},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal,
      vertLine:{color:'#00ff4144',labelBackgroundColor:'#003a0f'},
      horzLine:{color:'#00ff4144',labelBackgroundColor:'#003a0f'}},
    rightPriceScale:{borderColor:'#0a2a0a',scaleMargins:{top:0.08,bottom:0.08}},
    timeScale:{borderColor:'#0a2a0a',timeVisible:true,secondsVisible:false},
  });
  candleSeries=lwChart.addCandlestickSeries({
    upColor:'#00ff41',downColor:'#ff3131',
    borderUpColor:'#00ff41',borderDownColor:'#ff3131',
    wickUpColor:'#00aa2a',wickDownColor:'#aa1111',
  });
  window.addEventListener('resize',()=>{
    const nh=Math.max(400,window.innerHeight*0.55);
    body.style.height=nh+'px'; container.style.height=nh+'px';
    lwChart.applyOptions({width:container.clientWidth,height:nh});
  });
}

function clearChartLevels(){
  for(const s of Object.values(chartLevels)){try{lwChart.removeSeries(s);}catch(e){}}
  chartLevels={};
}

function drawChartLevelSet(candles,anchorTs,anchorOpen,type,ratio){
  if(!anchorOpen||!candles.length) return;
  const defs=getLevelDefs(type);
  const anchorSec=anchorTs.getTime()/1000;
  const secPerBar=(type==='HTF'||type==='HTF_R')?3600:60;
  const filtered=candles.filter(c=>c.time>=anchorSec);
  if(filtered.length<2) return;
  for(const def of defs){
    const data=filtered.map(c=>({
      time:c.time,
      value:anglePrice(anchorOpen,Math.round((c.time-anchorSec)/secPerBar),def.deg,ratio||1)
    }));
    const s=lwChart.addLineSeries({
      color:def.color, lineWidth:def.width,
      lineStyle:(type==='LTF')?2:0,
      priceLineVisible:false, lastValueVisible:true,
      title:`${type==='HTF_R'?'R':type+' '}${def.label}`,
      crosshairMarkerVisible:false,
    });
    s.setData(data);
    chartLevels[`${type}_${def.label}`]=s;
  }
}

function reloadChartLevels(){
  clearChartLevels();
  const m=chartMode;
  const showHTF=document.getElementById('show-htf-lvl').checked;
  const showLTF=document.getElementById('show-ltf-lvl').checked;
  if(m==='BOTH'){
    if(htfAnchorOpen){
      if(showHTF){
        drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF',1);
        drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF_R',CONFIG.htfRatio);
      }
    }
    if(showLTF&&ltfAnchorOpen) drawChartLevelSet(chartCandles,ltfAnchorTs,ltfAnchorOpen,'LTF');
  } else {
    const useRatio=m==='HTF_RATIO'||m==='RATIO_M1';
    if(showHTF&&htfAnchorOpen)
      drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,useRatio?'HTF_R':'HTF',useRatio?CONFIG.htfRatio:1);
    if(showLTF&&ltfAnchorOpen)
      drawChartLevelSet(chartCandles,ltfAnchorTs,ltfAnchorOpen,'LTF');
  }
}

async function loadChartMode(mode){
  const useH1=mode==='HTF'||mode==='HTF_RATIO';
  chartCandles=await fetchCandles(useH1?'1h':'1m',useH1?336:480);
  if(!chartCandles.length) return;
  candleSeries.setData(chartCandles);
  reloadChartLevels();
  lwChart.timeScale().fitContent();
  const tags={
    'HTF':'HTF // H1','HTF_RATIO':'HTF // H1 // RATIO',
    'LTF':'LTF // M1','RATIO_M1':'HTF RATIO // M1','BOTH':'M1 // BOTH HTF'
  };
  document.getElementById('chart-mode-tag').textContent=tags[mode]||mode;
}

function switchChartMode(mode){
  chartMode=mode;
  ['htf','ltf','htf-ratio','ratio-m1','both'].forEach(id=>{
    document.getElementById('btn-'+id).classList.remove('active');
  });
  const map={'HTF':'htf','LTF':'ltf','HTF_RATIO':'htf-ratio','RATIO_M1':'ratio-m1','BOTH':'both'};
  if(map[mode]) document.getElementById('btn-'+map[mode]).classList.add('active');
  loadChartMode(mode);
}

// ── CONFLUENCE ────────────────────────────────────────
function renderConfluence(htfLevels, htfRatioLevels, ltfLevels, cp){
  const panel=document.getElementById('confluence-panel');
  const tol=CONFIG.tolerance;

  const bothAlerts=[], ratioAlerts=[], htfAlerts=[];

  for(const l of ltfLevels){
    const ld=Math.abs(cp-l.price)/cp;
    if(ld>tol*6) continue;
    const htfMatch   = htfLevels.find(h=>Math.abs(l.price-h.price)/h.price<=tol*2);
    const ratioMatch = htfRatioLevels.find(h=>Math.abs(l.price-h.price)/h.price<=tol*2);
    if(htfMatch && ratioMatch) bothAlerts.push({ltf:l,htf:htfMatch,ratio:ratioMatch,priceDist:ld});
    else if(ratioMatch)        ratioAlerts.push({ltf:l,ratio:ratioMatch,priceDist:ld});
    else if(htfMatch)          htfAlerts.push({ltf:l,htf:htfMatch,priceDist:ld});
  }

  bothAlerts.sort((a,b)=>a.priceDist-b.priceDist);
  ratioAlerts.sort((a,b)=>a.priceDist-b.priceDist);
  htfAlerts.sort((a,b)=>a.priceDist-b.priceDist);

  const total=bothAlerts.length+ratioAlerts.length+htfAlerts.length;
  if(!total){
    panel.innerHTML=`<div class="no-alerts">[ NO ACTIVE CONFLUENCES ]<br><span style="font-size:9px;margin-top:4px;display:block">MONITORING // TOL ${(tol*100).toFixed(2)}%</span></div>`;
    return;
  }

  // Strength bar: 0% away = full bar, tol*6 away = empty
  function strengthBar(dist){
    const maxDist = tol*6;
    const pct = Math.max(0, Math.min(100, (1 - dist/maxDist)*100));
    const col = pct>75?'#00ff41':pct>50?'#aaff00':pct>30?'#ffb300':'#ff3131';
    const label = pct>75?'STRONG':pct>50?'GOOD':pct>30?'WEAK':'DISTANT';
    return `<div style="display:flex;align-items:center;gap:6px;margin-top:4px">
      <div style="flex:1;height:5px;background:rgba(0,40,0,0.6);border-radius:2px;overflow:hidden">
        <div style="width:${pct.toFixed(0)}%;height:100%;background:${col};border-radius:2px;box-shadow:0 0 4px ${col}66;transition:width 0.4s"></div>
      </div>
      <span style="font-size:9px;color:${col};letter-spacing:1px;width:52px;text-align:right">${label}</span>
    </div>`;
  }

  function signalScore(type, dist){
    // Score 0-100: BOTH=max, then penalise by distance
    const base = type==='BOTH'?100:type==='RATIO'?75:55;
    const maxDist=tol*6;
    const distPenalty = (dist/maxDist)*40;
    return Math.max(0, base-distPenalty);
  }

  // Build all alerts into one sorted list
  const all = [
    ...bothAlerts.slice(0,4).map(a=>({...a,type:'BOTH',  score:signalScore('BOTH', a.priceDist)})),
    ...ratioAlerts.slice(0,4).map(a=>({...a,type:'RATIO', score:signalScore('RATIO',a.priceDist)})),
    ...htfAlerts.slice(0,4).map(a=>({...a,type:'HTF',   score:signalScore('HTF',  a.priceDist)})),
  ].sort((a,b)=>b.score-a.score);

  const typeColour = {BOTH:'#ffb300', RATIO:'#00ffff', HTF:'#00ff41'};
  const typeBorder = {BOTH:'rgba(255,179,0,0.15)', RATIO:'rgba(0,255,255,0.08)', HTF:'rgba(0,255,65,0.06)'};

  let html='';
  for(const a of all){
    const col=typeColour[a.type];
    const bg=typeBorder[a.type];
    const dist=(a.priceDist*100).toFixed(3);
    const lvlStr = a.type==='BOTH'
      ? `M1 <span class="${levelClass(a.ltf.label)}">${a.ltf.label}</span> ∩ HTF <span class="${levelClass(a.htf.label)}">${a.htf.label}</span> ∩ R<span class="${levelClass(a.ratio.label)}">${a.ratio.label}</span>`
      : a.type==='RATIO'
      ? `M1 <span class="${levelClass(a.ltf.label)}">${a.ltf.label}</span> ∩ R<span class="${levelClass(a.ratio.label)}">${a.ratio.label}</span>`
      : `M1 <span class="${levelClass(a.ltf.label)}">${a.ltf.label}</span> ∩ HTF <span class="${levelClass(a.htf.label)}">${a.htf.label}</span>`;

    html+=`<div style="padding:10px 12px;border-bottom:1px solid var(--border);background:${bg};animation:alertIn 0.3s ease">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <span style="font-family:'VT323',monospace;font-size:14px;color:${col};letter-spacing:2px;text-shadow:0 0 6px ${col}88">${a.type}</span>
          <span style="font-size:9px;color:var(--text-dim);margin-left:8px;letter-spacing:1px">${dist}% AWAY</span>
        </div>
        <div style="text-align:right;font-size:13px;color:var(--green);letter-spacing:1px">${fmt(a.ltf.price)}</div>
      </div>
      <div style="font-size:12px;color:var(--green);margin-top:4px;letter-spacing:1px">${lvlStr}</div>
      ${strengthBar(a.priceDist)}
    </div>`;
  }

  panel.innerHTML=html;
}

// ── TRADES ────────────────────────────────────────────
function renderTrades(cp){
  const panel=document.getElementById('trades-panel');
  if(!ACTIVE_TRADES.length){
    panel.innerHTML=`<div class="no-trades">[ NO ACTIVE POSITIONS ]<br><span style="font-size:9px;margin-top:4px;display:block">ADD TRADES TO ACTIVE_TRADES ARRAY IN SCRIPT</span></div>`;
    return;
  }
  panel.innerHTML='';
  for(const t of ACTIVE_TRADES){
    const c=cp||t.entry;
    const pnl=t.direction==='LONG'?((c-t.entry)/t.entry*100):((t.entry-c)/t.entry*100);
    const pc=pnl>=0?'stat-pnl-pos':'stat-pnl-neg';
    const dc=t.direction==='LONG'?'dir-long':'dir-short';
    const range=Math.abs(t.target-t.entry);
    const prog=range>0?Math.min(100,Math.max(0,Math.abs(c-t.entry)/range*100)):0;
    panel.innerHTML+=`<div class="trade-card">
      <div class="trade-card-header">
        <div style="display:flex;align-items:center;gap:10px">
          <span class="trade-dir ${dc}">${t.direction}</span>
          <span style="font-size:12px;color:var(--green);letter-spacing:2px">${t.symbol}</span>
          <span style="font-size:10px;color:var(--text-dim)">LTF <span class="${levelClass(t.ltfLevel)}">${t.ltfLevel}</span> ∩ HTF <span class="${levelClass(t.htfLevel)}">${t.htfLevel}</span></span>
        </div>
        <span style="font-size:9px;color:var(--text-dim)">${t.entryTime}</span>
      </div>
      <div class="trade-body">
        <div class="trade-stat"><div class="stat-label">Entry</div><div class="stat-value">${fmt(t.entry)}</div></div>
        <div class="trade-stat"><div class="stat-label">Current</div><div class="stat-value">${fmt(c)}</div>
          <div class="progress-bar"><div class="progress-fill" style="width:${prog}%"></div></div></div>
        <div class="trade-stat"><div class="stat-label">Target</div><div class="stat-value lvl-pos">${fmt(t.target)}</div></div>
        <div class="trade-stat"><div class="stat-label">P&L</div><div class="stat-value ${pc}">${pnl>=0?'+':''}${pnl.toFixed(3)}%</div></div>
      </div></div>`;
  }
}

// ── TICKER ────────────────────────────────────────────
function buildTicker(price,stats){
  const items=[
    `BTCUSDT <span>${price?fmt(price):'—'}</span>`,
    stats?`24H <span class="${stats.change>=0?'up':'dn'}">${stats.change>=0?'+':''}${stats.change.toFixed(2)}%</span>`:'',
    stats?`HIGH <span>${fmt(stats.high)}</span>`:'',
    stats?`LOW <span>${fmt(stats.low)}</span>`:'',
    stats?`VOL <span>${(stats.vol/1000).toFixed(1)}K BTC</span>`:'',
    `TOLERANCE <span>${(CONFIG.tolerance*100).toFixed(2)}%</span>`,
    `LEVELS <span>±27 ±45 ±60 ±72 ±78 EQ</span>`,
  ].filter(Boolean).map(i=>`<span class="ticker-item">${i}</span>`).join('');
  document.getElementById('ticker-inner').innerHTML=items+items;
}

// ── MAIN REFRESH ──────────────────────────────────────
let cdVal=CONFIG.refreshSec, cdTimer;

async function refreshAll(){
  document.getElementById('data-status').textContent='FETCHING...';
  htfAnchorTs=getSunday2300();
  ltfAnchorTs=getToday0900();
  const now=new Date();
  const htfBars=Math.floor((now-htfAnchorTs)/3600000);
  const ltfBars=Math.floor((now-ltfAnchorTs)/60000);

  const [price,htfOpen,ltfOpen,stats]=await Promise.all([
    fetchCurrentPrice(), fetchAnchorOpen('1h',htfAnchorTs),
    fetchAnchorOpen('1m',ltfAnchorTs), fetch24hChange()
  ]);

  const cp=price||95000;
  htfAnchorOpen=htfOpen||cp;
  ltfAnchorOpen=ltfOpen||cp;

  const htfLevels      = getAllLevels(htfAnchorOpen, htfBars, 1);
  const htfRatioLevels = getAllLevels(htfAnchorOpen, htfBars, CONFIG.htfRatio);
  const ltfLevels      = getAllLevels(ltfAnchorOpen, ltfBars, 1);

  document.getElementById('hdr-price').textContent      = price?fmt(price):'—';
  document.getElementById('hdr-htf-anchor').textContent = htfAnchorTs.toUTCString().slice(5,11)+' 23:00';
  document.getElementById('hdr-ltf-anchor').textContent = ltfAnchorTs.toUTCString().slice(5,11)+' 09:00';

  reloadChartLevels();
  renderConfluence(htfLevels, htfRatioLevels, ltfLevels, cp);
  renderTrades(cp);
  buildTicker(price,stats);

  document.getElementById('last-update').textContent = new Date().toUTCString().slice(17,25)+' UTC';
  document.getElementById('data-status').textContent = price?'LIVE DATA // BINANCE':'OFFLINE MODE';

  clearInterval(cdTimer);
  cdVal=CONFIG.refreshSec;
  cdTimer=setInterval(()=>{
    cdVal--;
    document.getElementById('countdown').textContent=cdVal+'s';
    if(cdVal<=0){clearInterval(cdTimer);refreshAll();}
  },1000);
}

// ── PWA ───────────────────────────────────────────────
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault(); deferredPrompt=e;
  const btn=document.getElementById('install-btn');
  if(btn) btn.style.display='flex';
});
function installApp(){
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(()=>{deferredPrompt=null;document.getElementById('install-btn').style.display='none';});
}

// ── BOOT ──────────────────────────────────────────────
window.addEventListener('load',async()=>{
  buildChart();
  htfAnchorTs=getSunday2300();
  ltfAnchorTs=getToday0900();
  const [htfOpen,ltfOpen]=await Promise.all([
    fetchAnchorOpen('1h',htfAnchorTs), fetchAnchorOpen('1m',ltfAnchorTs)
  ]);
  htfAnchorOpen=htfOpen;
  ltfAnchorOpen=ltfOpen;
  await loadChartMode('HTF');
  await refreshAll();
  setInterval(()=>loadChartMode(chartMode),300000);
});

// ══════════════════════════════════════════════════════
// DRAWING TOOLS
// ══════════════════════════════════════════════════════
let drawTool  = 'none';
let drawings  = [];
let drawState = null;

const overlay  = document.getElementById('draw-overlay');
const DC_GREEN = '#00ff41';
const DC_AMBER = '#ffb300';

function setDrawTool(tool){
  drawTool = tool;
  ['none','hline','trend','rect','vline'].forEach(t=>{
    const b=document.getElementById('draw-'+t);
    if(b) b.classList.toggle('active',t===tool);
  });
  overlay.className = tool==='none'?'tool-none':'drawing tool-'+tool;
}

function getSVGCoords(e){
  const r=overlay.getBoundingClientRect();
  return {x:e.clientX-r.left, y:e.clientY-r.top};
}

function svgEl(tag,attrs){
  const el=document.createElementNS('http://www.w3.org/2000/svg',tag);
  for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
  overlay.appendChild(el);
  return el;
}

function getPriceLabel(y){
  try{
    const h=overlay.getBoundingClientRect().height;
    const pct=y/h;
    // Estimate from candle data visible range
    if(!chartCandles.length) return '';
    const prices=chartCandles.map(c=>c.close);
    const mn=Math.min(...prices), mx=Math.max(...prices);
    const p=mx-pct*(mx-mn);
    return p.toLocaleString('en-US',{minimumFractionDigits:1,maximumFractionDigits:1});
  }catch(e){return '';}
}

overlay.addEventListener('mousedown',e=>{
  if(drawTool==='none') return;
  const {x,y}=getSVGCoords(e);

  if(drawTool==='hline'){
    const line=svgEl('line',{x1:0,y1:y,x2:'100%',y2:y,stroke:DC_GREEN,'stroke-width':1,'stroke-dasharray':'6,3',opacity:0.85});
    const lbl=svgEl('text',{x:8,y:y-4,fill:DC_GREEN,'font-family':'Share Tech Mono,monospace','font-size':10,opacity:0.9});
    lbl.textContent=getPriceLabel(y);
    drawings.push({els:[line,lbl]});

  } else if(drawTool==='vline'){
    const line=svgEl('line',{x1:x,y1:0,x2:x,y2:'100%',stroke:'#ffb300','stroke-width':1,'stroke-dasharray':'6,3',opacity:0.85});
    drawings.push({els:[line]});

  } else if(drawTool==='trend'){
    if(!drawState){
      const line=svgEl('line',{x1:x,y1:y,x2:x,y2:y,stroke:DC_AMBER,'stroke-width':1.5,opacity:0.9});
      const dot=svgEl('circle',{cx:x,cy:y,r:3,fill:DC_AMBER,opacity:0.9});
      drawState={x1:x,y1:y,line,dot};
    } else {
      drawState.line.setAttribute('x2',x);
      drawState.line.setAttribute('y2',y);
      const dot2=svgEl('circle',{cx:x,cy:y,r:3,fill:DC_AMBER,opacity:0.9});
      drawings.push({els:[drawState.line,drawState.dot,dot2]});
      drawState=null;
    }

  } else if(drawTool==='rect'){
    const rect=svgEl('rect',{x,y,width:0,height:0,fill:'rgba(0,255,65,0.05)',stroke:DC_GREEN,'stroke-width':1,opacity:0.85});
    drawState={x0:x,y0:y,rect};
  }
});

overlay.addEventListener('mousemove',e=>{
  if(!drawState) return;
  const {x,y}=getSVGCoords(e);
  if(drawTool==='trend'&&drawState.line){
    drawState.line.setAttribute('x2',x);
    drawState.line.setAttribute('y2',y);
  } else if(drawTool==='rect'&&drawState.rect){
    drawState.rect.setAttribute('x',Math.min(x,drawState.x0));
    drawState.rect.setAttribute('y',Math.min(y,drawState.y0));
    drawState.rect.setAttribute('width',Math.abs(x-drawState.x0));
    drawState.rect.setAttribute('height',Math.abs(y-drawState.y0));
  }
});

overlay.addEventListener('mouseup',e=>{
  if(drawTool==='rect'&&drawState){
    drawings.push({els:[drawState.rect]});
    drawState=null;
  }
});

// Touch support (iPad)
function touchToMouse(type,touch){
  overlay.dispatchEvent(new MouseEvent(type,{clientX:touch.clientX,clientY:touch.clientY,bubbles:true}));
}
overlay.addEventListener('touchstart',e=>{e.preventDefault();touchToMouse('mousedown',e.touches[0]);},{passive:false});
overlay.addEventListener('touchmove', e=>{e.preventDefault();touchToMouse('mousemove',e.touches[0]);},{passive:false});
overlay.addEventListener('touchend',  e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  touchToMouse('mouseup',t);
  if(drawTool==='hline'||drawTool==='trend') touchToMouse('mousedown',t);
},{passive:false});

function undoDraw(){
  if(drawState){
    ['line','dot','rect'].forEach(k=>{if(drawState[k]) drawState[k].remove();});
    drawState=null; return;
  }
  const last=drawings.pop();
  if(last) last.els.forEach(el=>el.remove());
}

function clearDrawings(){
  drawings.forEach(d=>d.els.forEach(el=>el.remove()));
  drawings=[];
  if(drawState){
    ['line','dot','rect'].forEach(k=>{if(drawState[k]) drawState[k].remove();});
    drawState=null;
  }
}

</script>

</body>
</html>