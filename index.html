<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="OBAMA DASH">
<meta name="theme-color" content="#00ff41">
<meta name="description" content="Obama Dash — live BTC HTF/LTF confluence dashboard">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<title>OBAMA DASH // DASHBOARD</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap');

:root {
–bg:         #050f05;
–panel:      #070d07;
–border:     #0f2a0f;
–green:      #00ff41;
–green-dim:  #00882a;
–red:        #ff3131;
–amber:      #ffb300;
–text:       #00cc33;
–text-dim:   #006618;
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

html, body {
width:100%;
height: 100dvh;
height: -webkit-fill-available;
overflow:hidden;
background:var(–bg);
color:var(–text);
font-family:‘Share Tech Mono’, monospace;
font-size:12px;
cursor:crosshair;
}

body::before {
content:’’; position:fixed; inset:0; z-index:9999; pointer-events:none;
background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,0.10) 3px,rgba(0,0,0,0.10) 4px);
}

#app {
display:flex; flex-direction:column;
height: 100dvh;
height: -webkit-fill-available;
overflow:hidden;
}

/* ── TITLE BAR ── */
.titlebar {
flex-shrink:0;
display:flex; align-items:center; justify-content:space-between;
padding:4px 12px;
background:var(–panel);
border-bottom:1px solid var(–border);
height:32px;
}
.titlebar-name {
font-family:‘VT323’, monospace;
font-size:22px; letter-spacing:4px;
color:var(–green);
text-shadow:0 0 8px var(–green-dim);
white-space:nowrap;
}
.titlebar-name span { color:var(–text-dim); }
.titlebar-right {
display:flex; align-items:center; gap:8px;
}
.price-display {
font-size:13px; color:var(–green);
letter-spacing:1px;
}
.status-dot {
width:6px; height:6px; border-radius:50%;
background:var(–green);
animation:pulse 2s infinite;
flex-shrink:0;
}
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

/* ── CHART SHELL ── */
.chart-shell {
flex:1; min-height:0;
display:flex; flex-direction:column;
}

/* ── CONTROLS ── */
.chart-controls {
flex-shrink:0;
display:flex; align-items:stretch;
height:26px;
background:var(–panel);
border-bottom:1px solid var(–border);
position:relative;
}
.tf-btn {
background:none; border:none; border-right:1px solid var(–border);
color:var(–text-dim);
font-family:‘Share Tech Mono’, monospace;
font-size:10px; letter-spacing:2px;
padding:0 14px; cursor:pointer;
transition:color 0.1s, background 0.1s;
position:relative;
}
.tf-btn:hover  { color:var(–green); background:rgba(0,255,65,0.04); }
.tf-btn.active { color:var(–green); background:rgba(0,255,65,0.07); }
.tf-btn.active::after {
content:’’; position:absolute;
bottom:0; left:20%; right:20%;
height:2px; background:var(–green);
}
.kl-btn {
margin-left:auto;
background:none; border:none; border-left:1px solid var(–border);
color:var(–text-dim);
font-family:‘Share Tech Mono’, monospace;
font-size:10px; letter-spacing:2px;
padding:0 12px; cursor:pointer;
transition:color 0.1s;
}
.kl-btn:hover { color:var(–green); }

/* ── KEY LEVELS PANEL ── */
.kl-panel {
position:absolute; top:27px; right:0;
width:240px; z-index:50;
background:#030a03;
border:1px solid var(–border);
border-top:none;
display:none;
}
.kl-panel.open { display:block; }
.kl-group      { border-bottom:1px solid #0a1a0a; }
.kl-group-hdr  {
display:flex; flex-direction:column; gap:4px;
padding:5px 10px;
font-size:10px; letter-spacing:2px;
}
.kl-group-hdr:hover { background:rgba(0,255,65,0.02); }
.kl-row { display:flex; gap:12px; flex-wrap:wrap; }
.kl-row label {
display:flex; align-items:center; gap:4px;
font-size:9px; color:var(–text-dim);
letter-spacing:1px; cursor:pointer;
}
.kl-row input[type=checkbox] { accent-color:var(–green); cursor:pointer; }

/* ── CHART BODY ── */
.chart-body { flex:1; position:relative; min-height:0; overflow:hidden; }
#chart-container { width:100%; height:100%; }

/* ── LEVEL CLASSES ── */
.lvl-eq      { color:#fff; }
.lvl-pos     { color:var(–green); }
.lvl-neg     { color:var(–red); }
.lvl-extreme { color:var(–amber); }

</style>
</head>
<body>
<div id="app">

  <!-- TITLE BAR -->

  <div class="titlebar">
    <div class="titlebar-name">OBAMA<span> // </span>DASH</div>
    <div class="titlebar-right">
      <span class="price-display" id="hdr-price">—</span>
      <div class="status-dot"></div>
    </div>
  </div>

  <!-- CHART SHELL -->

  <div class="chart-shell">
    <div class="chart-controls" style="position:relative">
      <button class="tf-btn active" id="btn-ltf-ratio" onclick="switchChartMode('LTF_RATIO')">M1 // RATIO</button>
      <button class="tf-btn"        id="btn-ltf-both"  onclick="switchChartMode('LTF_BOTH')">M1 // BOTH</button>
      <button class="kl-btn" id="kl-toggle-btn" onclick="toggleKLPanel()">⊞ KEY LEVELS</button>
      <div class="kl-panel" id="kl-panel">
        <div class="kl-group">
          <div class="kl-group-hdr" style="color:#08bcd4">
            <span>DAILY</span>
            <div class="kl-row">
              <label><input type="checkbox" id="kl-daily-open" checked onchange="redrawKL()"> OPEN</label>
              <label><input type="checkbox" id="kl-daily-hl"        onchange="redrawKL()"> PREV H/L</label>
            </div>
          </div>
        </div>
        <div class="kl-group">
          <div class="kl-group-hdr" style="color:#fffcbc">
            <span>WEEKLY</span>
            <div class="kl-row">
              <label><input type="checkbox" id="kl-weekly-open" checked onchange="redrawKL()"> OPEN</label>
              <label><input type="checkbox" id="kl-weekly-hl"   checked onchange="redrawKL()"> H/L</label>
              <label><input type="checkbox" id="kl-weekly-mid"  checked onchange="redrawKL()"> MID</label>
            </div>
          </div>
        </div>
        <div class="kl-group">
          <div class="kl-group-hdr" style="color:#08d48c">
            <span>MONTHLY</span>
            <div class="kl-row">
              <label><input type="checkbox" id="kl-monthly-open" checked onchange="redrawKL()"> OPEN</label>
              <label><input type="checkbox" id="kl-monthly-hl"         onchange="redrawKL()"> H/L</label>
              <label><input type="checkbox" id="kl-monthly-mid"        onchange="redrawKL()"> MID</label>
            </div>
          </div>
        </div>
        <div class="kl-group">
          <div class="kl-group-hdr" style="color:#ff6666">
            <span>QUARTERLY</span>
            <div class="kl-row">
              <label><input type="checkbox" id="kl-quarterly-open" onchange="redrawKL()"> OPEN</label>
            </div>
          </div>
        </div>
        <div class="kl-group">
          <div class="kl-group-hdr" style="color:#ff3131">
            <span>YEARLY</span>
            <div class="kl-row">
              <label><input type="checkbox" id="kl-yearly-open" checked onchange="redrawKL()"> OPEN</label>
              <label><input type="checkbox" id="kl-yearly-hl"         onchange="redrawKL()"> H/L</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="chart-body">
      <div id="chart-container"></div>
    </div>
  </div>

</div>

<script>
const CONFIG = {
  symbol:'BTCUSDT', htfRatio:73.3458,
  angles:[27,45,60,72,78], tolerance:0.0030, refreshSec:60
};


// ── CHART STATE ───────────────────────────────────────
let lwChart, candleSeries, chartLevels={}, chartMode='LTF_RATIO', chartCandles=[];
let htfAnchorTs, ltfAnchorTs, htfAnchorOpen, ltfAnchorOpen;

// ── MATH ──────────────────────────────────────────────
function anglePrice(anchor,bars,deg,ratio){
  return anchor + bars*(ratio||1)*Math.tan(deg*Math.PI/180);
}


// ── ANCHORS ───────────────────────────────────────────
function getSunday2300(){
  const n=new Date(),d=n.getUTCDay();
  const s=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()-(d===0?0:d),23,0,0));
  if(s>n) s.setUTCDate(s.getUTCDate()-7);
  return s;
}
function getToday0900(){
  const n=new Date();
  return new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),9,0,0));
}

// ── FETCH ─────────────────────────────────────────────
async function fetchCurrentPrice(){
  try{const r=await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${CONFIG.symbol}`);
  const d=await r.json();return parseFloat(d.price);}catch(e){return null;}
}
async function fetchAnchorOpen(interval,ts){
  try{const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=${interval}&startTime=${ts.getTime()}&limit=1`);
  const d=await r.json();return d.length?parseFloat(d[0][1]):null;}catch(e){return null;}
}
async function fetchCandles(interval,limit){
  try{const r=await fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=${interval}&limit=${limit}`);
  const d=await r.json();
  return d.map(k=>({time:k[0]/1000,open:parseFloat(k[1]),high:parseFloat(k[2]),low:parseFloat(k[3]),close:parseFloat(k[4])}));}
  catch(e){return[];}
}

// ── HELPERS ───────────────────────────────────────────
function levelClass(lbl){
  if(lbl==='EQ') return 'lvl-eq';
  const d=Math.abs(parseInt(lbl.slice(1)));
  if(d>=72) return 'lvl-extreme';
  return lbl.startsWith('+')? 'lvl-pos':'lvl-neg';
}
function fmt(n){return n.toLocaleString('en-US',{minimumFractionDigits:1,maximumFractionDigits:1});}

// ── CHART LEVEL COLOURS ───────────────────────────────
function getLevelDefs(type){
  const isRatio = type==='HTF_R';
  // HTF Ratio fan: bright cyan positive, bright magenta negative, white EQ
  if(isRatio) return [
    {label:'EQ',  deg:0,   color:'#ffffff', width:1},
    {label:'+27', deg:27,  color:'#ffb300', width:1},
    {label:'-27', deg:-27, color:'#ff00ff', width:1},
    {label:'+45', deg:45,  color:'#ffb300', width:1},
    {label:'-45', deg:-45, color:'#ff00ff', width:1},
    {label:'+60', deg:60,  color:'#ffb300', width:1},
    {label:'-60', deg:-60, color:'#ff00ff', width:1},
    {label:'+72', deg:72,  color:'#ffdd00', width:2},
    {label:'-72', deg:-72, color:'#ffdd00', width:2},
    {label:'+78', deg:78,  color:'#ffdd00', width:2},
    {label:'-78', deg:-78, color:'#ffdd00', width:2},
  ];
  const h = type==='HTF';
  return [
    {label:'EQ',  deg:0,   color:h?'#ffffff':'#aaaaaa', width:1},
    {label:'+27', deg:27,  color:h?'#00ff41':'#00cc33', width:1},
    {label:'-27', deg:-27, color:h?'#ff3131':'#cc2222', width:1},
    {label:'+45', deg:45,  color:h?'#00ff41':'#00cc33', width:1},
    {label:'-45', deg:-45, color:h?'#ff3131':'#cc2222', width:1},
    {label:'+60', deg:60,  color:h?'#00ff41':'#00cc33', width:1},
    {label:'-60', deg:-60, color:h?'#ff3131':'#cc2222', width:1},
    {label:'+72', deg:72,  color:h?'#ffb300':'#dd9900', width:1},
    {label:'-72', deg:-72, color:h?'#ffb300':'#dd9900', width:1},
    {label:'+78', deg:78,  color:h?'#ffb300':'#dd9900', width:1},
    {label:'-78', deg:-78, color:h?'#ffb300':'#dd9900', width:1},
  ];
}

// ── CHART BUILD ───────────────────────────────────────
function buildChart(){
  const container=document.getElementById('chart-container');
  const body=container.parentElement;
  function getH(){ return body.getBoundingClientRect().height||window.innerHeight-58; }
  const h=getH();
  lwChart=LightweightCharts.createChart(container,{
    width:container.clientWidth, height:h,
    layout:{background:{color:'#050f05'},textColor:'#008822'},
    grid:{vertLines:{color:'#0a1a0a'},horzLines:{color:'#0a1a0a'}},
    crosshair:{mode:LightweightCharts.CrosshairMode.Normal,
      vertLine:{color:'#00ff4144',labelBackgroundColor:'#001a06'},
      horzLine:{color:'#00ff4144',labelBackgroundColor:'#001a06'}},
    rightPriceScale:{borderColor:'#0a2a0a',scaleMargins:{top:0.08,bottom:0.08}},
    timeScale:{
      borderColor:'#0a2a0a',
      timeVisible:true,
      secondsVisible:false,
    },
  });
  candleSeries=lwChart.addCandlestickSeries({
    upColor:'#00ff41',downColor:'#ff3131',
    borderUpColor:'#00ff41',borderDownColor:'#ff3131',
    wickUpColor:'#00aa2a',wickDownColor:'#aa1111',
  });
  function resize(){
    const nh=getH();
    lwChart.applyOptions({width:container.clientWidth,height:nh});
  }
  let _rt;
  function dResize(){ clearTimeout(_rt); _rt=setTimeout(resize,80); }
  window.addEventListener('resize', dResize);
  if(window.visualViewport) window.visualViewport.addEventListener('resize', dResize);
}

function clearChartLevels(){
  for(const s of Object.values(chartLevels)){try{lwChart.removeSeries(s);}catch(e){}}
  chartLevels={};
}

function drawChartLevelSet(candles,anchorTs,anchorOpen,type,ratio){
  if(!anchorOpen||!candles.length) return;
  const defs=getLevelDefs(type);
  const anchorSec=anchorTs.getTime()/1000;
  const secPerBar=(type==='HTF'||type==='HTF_R')?3600:60;
  const filtered=candles.filter(c=>c.time>=anchorSec);
  if(filtered.length<2) return;
  for(const def of defs){
    const data=filtered.map(c=>({
      time:c.time,
      value:anglePrice(anchorOpen,Math.round((c.time-anchorSec)/secPerBar),def.deg,ratio||1)
    }));
    const shortType = type==='HTF_R'?'R':type==='HTF'?'H':type==='LTF'?'L':'';
    const s=lwChart.addLineSeries({
      color:def.color, lineWidth:def.width,
      lineStyle:(type==='LTF')?2:0,
      priceLineVisible:false, lastValueVisible:true,
      title: shortType+def.label,
      crosshairMarkerVisible:false,
    });
    s.setData(data);
    chartLevels[`${type}_${def.label}`]=s;
  }
}

function reloadChartLevels(){
  clearChartLevels();
  const m = chartMode;
  if(m==='HTF'){
    // H1 candles — draw both HTF fans + LTF overlay
    if(htfAnchorOpen){
      drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF',1);
      drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF_R',CONFIG.htfRatio);
    }
    if(ltfAnchorOpen)
      drawChartLevelSet(chartCandles,ltfAnchorTs,ltfAnchorOpen,'LTF');
  } else if(m==='LTF_STD'){
    // M1 candles — standard HTF fan only
    if(htfAnchorOpen)
      drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF',1);
    if(ltfAnchorOpen)
      drawChartLevelSet(chartCandles,ltfAnchorTs,ltfAnchorOpen,'LTF');
  } else if(m==='LTF_RATIO'){
    // M1 candles — ratio HTF fan only
    if(htfAnchorOpen)
      drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF_R',CONFIG.htfRatio);
    if(ltfAnchorOpen)
      drawChartLevelSet(chartCandles,ltfAnchorTs,ltfAnchorOpen,'LTF');
  } else if(m==='LTF_BOTH'){
    // M1 candles — both HTF fans
    if(htfAnchorOpen){
      drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF',1);
      drawChartLevelSet(chartCandles,htfAnchorTs,htfAnchorOpen,'HTF_R',CONFIG.htfRatio);
    }
    if(ltfAnchorOpen)
      drawChartLevelSet(chartCandles,ltfAnchorTs,ltfAnchorOpen,'LTF');
  }
}

async function loadChartMode(mode){
  const useH1 = false; // M1 only
  chartCandles = await fetchCandles(useH1?'1h':'1m', useH1?336:1000);
  if(!chartCandles.length) return;
  candleSeries.setData(chartCandles);
  reloadChartLevels();
  lwChart.timeScale().fitContent();

}

function switchChartMode(mode){
  chartMode=mode;
  ['ltf-ratio','ltf-both'].forEach(id=>{
    const el=document.getElementById('btn-'+id);
    if(el) el.classList.remove('active');
  });
  if(mode==='LTF_RATIO') document.getElementById('btn-ltf-ratio')?.classList.add('active');
  if(mode==='LTF_BOTH')  document.getElementById('btn-ltf-both')?.classList.add('active');
  loadChartMode(mode);
  startLiveCandle();
}

// ── TICKER ────────────────────────────────────────────

// ── MAIN REFRESH ──────────────────────────────────────
let cdVal=CONFIG.refreshSec, cdTimer, liveTimer=null;

async function refreshAll(){
  htfAnchorTs=getSunday2300();
  ltfAnchorTs=getToday0900();
  const now=new Date();
  const [price,htfOpen,ltfOpen]=await Promise.all([
    fetchCurrentPrice(), fetchAnchorOpen('1h',htfAnchorTs),
    fetchAnchorOpen('1m',ltfAnchorTs)
  ]);

  const cp=price||95000;

  document.getElementById('hdr-price').textContent = price?fmt(price):'—';

  const htfChanged = htfOpen !== htfAnchorOpen;
  const ltfChanged = ltfOpen !== ltfAnchorOpen;
  htfAnchorOpen = htfOpen || cp;
  ltfAnchorOpen = ltfOpen || cp;
  if(htfChanged || ltfChanged) reloadChartLevels();


  clearInterval(cdTimer);
  cdVal=CONFIG.refreshSec;
  cdTimer=setInterval(()=>{
    cdVal--;
      if(cdVal<=0){clearInterval(cdTimer);refreshAll();}
  },1000);
}


// ── LIVE M1 CANDLE UPDATE (BTC — Binance, ~1s) ────────
async function fetchLastCandle(){
  try{
    const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=1m&limit=2`);
    const d = await r.json();
    if(!d||!d.length) return null;
    const k = d[d.length-1];
    return {time:k[0]/1000, open:parseFloat(k[1]), high:parseFloat(k[2]), low:parseFloat(k[3]), close:parseFloat(k[4])};
  }catch(e){return null;}
}
function startLiveCandle(){
  stopLiveCandle();
  liveTimer = setInterval(async ()=>{
    const candle = await fetchLastCandle();
    if(!candle || !candleSeries) return;
    // Update or append last candle
    try{ candleSeries.update(candle); }catch(e){}
    // Keep chartCandles in sync
    if(chartCandles.length && chartCandles[chartCandles.length-1].time === candle.time){
      chartCandles[chartCandles.length-1] = candle;
    } else if(candle.time > (chartCandles[chartCandles.length-1]?.time||0)){
      chartCandles.push(candle);
    }
  }, 1000);
}

function stopLiveCandle(){
  if(liveTimer){ clearInterval(liveTimer); liveTimer=null; }
}


// ── KEY LEVELS FETCH (Binance) ─────────────────────────
async function fetchKLData(){
  try{
    const [d1, w1, m1, m13] = await Promise.all([
      fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=1d&limit=3`).then(r=>r.json()),
      fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=1w&limit=3`).then(r=>r.json()),
      fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=1M&limit=3`).then(r=>r.json()),
      fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=3M&limit=3`).then(r=>r.json()),
    ]);
    const parse = (k,i=0)=>({open:parseFloat(k[k.length-1-i][1]),high:parseFloat(k[k.length-1-i][2]),low:parseFloat(k[k.length-1-i][3]),close:parseFloat(k[k.length-1-i][4])});
    // Also get yearly: use 12M candles
    const y1 = await fetch(`https://api.binance.com/api/v3/klines?symbol=${CONFIG.symbol}&interval=1M&limit=14`).then(r=>r.json());
    const nowDate = new Date();
    const yearStart = new Date(Date.UTC(nowDate.getUTCFullYear(),0,1)).getTime()/1000;
    let yearOpen=null,yearHigh=null,yearLow=null;
    for(const k of y1){
      const ts=k[0]/1000;
      if(ts>=yearStart){
        if(yearOpen===null) yearOpen=parseFloat(k[1]);
        const h=parseFloat(k[2]),l=parseFloat(k[3]);
        if(yearHigh===null||h>yearHigh) yearHigh=h;
        if(yearLow===null||l<yearLow) yearLow=l;
      }
    }
    return {
      daily:  { open:parse(d1,0).open },
      prevDay:{ high:parse(d1,1).high, low:parse(d1,1).low },
      weekly: { open:parse(w1,0).open },
      prevWeek:{ high:parse(w1,1).high, low:parse(w1,1).low },
      monthly:{ open:parse(m1,0).open },
      prevMonth:{ high:parse(m1,1).high, low:parse(m1,1).low },
      quarterly:{ open:parse(m13,0).open },
      yearly: { open:yearOpen, high:yearHigh, low:yearLow },
    };
  }catch(e){ console.error('KL fetch error',e); return null; }
}
// ── KEY LEVELS STATE & DRAW ────────────────────────────
let klData     = null;
let klLines    = [];   // price line objects on candleSeries
let klEnabled  = false;

function toggleKLPanel(){
  const panel = document.getElementById('kl-panel');
  const btn   = document.getElementById('kl-toggle-btn');
  const open  = panel.classList.toggle('open');
  btn.classList.toggle('active', open);
  klEnabled = open;
  if(open && !klData){ loadKL(); } else { redrawKL(); }
}
// Close panel if clicking outside
document.addEventListener('click', e=>{
  const panel=document.getElementById('kl-panel');
  const btn=document.getElementById('kl-toggle-btn');
  if(panel&&btn&&!panel.contains(e.target)&&!btn.contains(e.target)){
    panel.classList.remove('open');
    btn.classList.remove('active');
    klEnabled=false;
    clearKL();
  }
});

function chk(id){ const el=document.getElementById(id); return el&&el.checked; }

async function loadKL(){
  document.getElementById('kl-toggle-btn').textContent='⊞ LOADING...';
  klData = await fetchKLData();
  document.getElementById('kl-toggle-btn').textContent='⊞ KEY LEVELS';
  redrawKL();
}

function clearKL(){
  if(!candleSeries) return;
  for(const pl of klLines){ try{ candleSeries.removePriceLine(pl); }catch(e){} }
  klLines=[];
}

function makePL(price, title, color, dashed=false){
  if(!price||!candleSeries) return;
  const pl = candleSeries.createPriceLine({
    price, title,
    color,
    lineWidth: 1,
    lineStyle: dashed ? 2 : 0,
    axisLabelVisible: true,
    axisLabelColor: color,
  });
  klLines.push(pl);
}

function redrawKL(){
  clearKL();
  if(!klData||!klEnabled) return;
  const d=klData;

  // Daily — cyan
  if(chk('kl-daily-open'))   makePL(d.daily.open,   'DO',  '#08bcd4');
  if(chk('kl-daily-hl'))     makePL(d.prevDay.high, 'PDH', '#08bcd4', true);
  if(chk('kl-daily-hl'))     makePL(d.prevDay.low,  'PDL', '#08bcd4', true);

  // Weekly — yellow
  if(chk('kl-weekly-open'))  makePL(d.weekly.open,     'WO',  '#fffcbc');
  if(chk('kl-weekly-hl'))    makePL(d.prevWeek.high,   'PWH', '#fffcbc', true);
  if(chk('kl-weekly-hl'))    makePL(d.prevWeek.low,    'PWL', '#fffcbc', true);
  if(chk('kl-weekly-mid')&&d.prevWeek.high&&d.prevWeek.low)
    makePL((d.prevWeek.high+d.prevWeek.low)/2, 'PWM', '#fffcbc', true);

  // Monthly — green
  if(chk('kl-monthly-open')) makePL(d.monthly.open,    'MO',  '#08d48c');
  if(chk('kl-monthly-hl'))   makePL(d.prevMonth.high,  'PMH', '#08d48c', true);
  if(chk('kl-monthly-hl'))   makePL(d.prevMonth.low,   'PML', '#08d48c', true);
  if(chk('kl-monthly-mid')&&d.prevMonth.high&&d.prevMonth.low)
    makePL((d.prevMonth.high+d.prevMonth.low)/2,'PMM','#08d48c',true);

  // Quarterly — red
  if(chk('kl-quarterly-open')) makePL(d.quarterly.open, 'QO', '#ff6666');

  // Yearly — bright red
  if(chk('kl-yearly-open')) makePL(d.yearly.open,  'YO',  '#ff3131');
  if(chk('kl-yearly-hl'))   makePL(d.yearly.high,  'CYH', '#ff3131', true);
  if(chk('kl-yearly-hl'))   makePL(d.yearly.low,   'CYL', '#ff3131', true);
}

// ── PWA ───────────────────────────────────────────────
if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
let deferredPrompt=null;
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault(); deferredPrompt=e;
  const btn=document.getElementById('install-btn');
  if(btn) btn.style.display='flex';
});
function installApp(){
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.then(()=>{deferredPrompt=null;document.getElementById('install-btn').style.display='none';});
}

// ── BOOT ──────────────────────────────────────────────
window.addEventListener('load',async()=>{
  buildChart();
  // Force resize after layout settles — critical for iOS Safari
  requestAnimationFrame(()=>{ setTimeout(()=>window.dispatchEvent(new Event('resize')),150); });
  htfAnchorTs=getSunday2300();
  ltfAnchorTs=getToday0900();
  const [htfOpen,ltfOpen]=await Promise.all([
    fetchAnchorOpen('1h',htfAnchorTs), fetchAnchorOpen('1m',ltfAnchorTs)
  ]);
  htfAnchorOpen=htfOpen;
  ltfAnchorOpen=ltfOpen;
  await loadChartMode('LTF_RATIO');
  await refreshAll();
});



function getSVGCoords(e){
  const r=overlay.getBoundingClientRect();
  return {x:e.clientX-r.left, y:e.clientY-r.top};
}

function svgEl(tag,attrs){
  const el=document.createElementNS('http://www.w3.org/2000/svg',tag);
  for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
  overlay.appendChild(el);
  return el;
}

function getPriceLabel(y){
  try{
    const h=overlay.getBoundingClientRect().height;
    const pct=y/h;
    // Estimate from candle data visible range
    if(!chartCandles.length) return '';
    const prices=chartCandles.map(c=>c.close);
    const mn=Math.min(...prices), mx=Math.max(...prices);
    const p=mx-pct*(mx-mn);
    return p.toLocaleString('en-US',{minimumFractionDigits:1,maximumFractionDigits:1});
  }catch(e){return '';}
}

overlay.addEventListener('mousedown',e=>{
  if(drawTool==='none') return;
  const {x,y}=getSVGCoords(e);

  if(drawTool==='hline'){
    const line=svgEl('line',{x1:0,y1:y,x2:'100%',y2:y,stroke:DC_GREEN,'stroke-width':1,'stroke-dasharray':'6,3',opacity:0.85});
    const lbl=svgEl('text',{x:8,y:y-4,fill:DC_GREEN,'font-family':'Share Tech Mono,monospace','font-size':10,opacity:0.9});
    lbl.textContent=getPriceLabel(y);
    drawings.push({els:[line,lbl]});

  } else if(drawTool==='vline'){
    const line=svgEl('line',{x1:x,y1:0,x2:x,y2:'100%',stroke:'#ffb300','stroke-width':1,'stroke-dasharray':'6,3',opacity:0.85});
    drawings.push({els:[line]});

  } else if(drawTool==='trend'){
    if(!drawState){
      const line=svgEl('line',{x1:x,y1:y,x2:x,y2:y,stroke:DC_AMBER,'stroke-width':1.5,opacity:0.9});
      const dot=svgEl('circle',{cx:x,cy:y,r:3,fill:DC_AMBER,opacity:0.9});
      drawState={x1:x,y1:y,line,dot};
    } else {
      drawState.line.setAttribute('x2',x);
      drawState.line.setAttribute('y2',y);
      const dot2=svgEl('circle',{cx:x,cy:y,r:3,fill:DC_AMBER,opacity:0.9});
      drawings.push({els:[drawState.line,drawState.dot,dot2]});
      drawState=null;
    }

  } else if(drawTool==='rect'){
    const rect=svgEl('rect',{x,y,width:0,height:0,fill:'rgba(0,255,65,0.05)',stroke:DC_GREEN,'stroke-width':1,opacity:0.85});
    drawState={x0:x,y0:y,rect};
  }
});

overlay.addEventListener('mousemove',e=>{
  if(!drawState) return;
  const {x,y}=getSVGCoords(e);
  if(drawTool==='trend'&&drawState.line){
    drawState.line.setAttribute('x2',x);
    drawState.line.setAttribute('y2',y);
  } else if(drawTool==='rect'&&drawState.rect){
    drawState.rect.setAttribute('x',Math.min(x,drawState.x0));
    drawState.rect.setAttribute('y',Math.min(y,drawState.y0));
    drawState.rect.setAttribute('width',Math.abs(x-drawState.x0));
    drawState.rect.setAttribute('height',Math.abs(y-drawState.y0));
  }
});

overlay.addEventListener('mouseup',e=>{
  if(drawTool==='rect'&&drawState){
    drawings.push({els:[drawState.rect]});
    drawState=null;
  }
});

// Touch support (iPad)
function touchToMouse(type,touch){
  overlay.dispatchEvent(new MouseEvent(type,{clientX:touch.clientX,clientY:touch.clientY,bubbles:true}));
}
overlay.addEventListener('touchstart',e=>{e.preventDefault();touchToMouse('mousedown',e.touches[0]);},{passive:false});
overlay.addEventListener('touchmove', e=>{e.preventDefault();touchToMouse('mousemove',e.touches[0]);},{passive:false});
overlay.addEventListener('touchend',  e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  touchToMouse('mouseup',t);
  if(drawTool==='hline'||drawTool==='trend') touchToMouse('mousedown',t);
},{passive:false});

function undoDraw(){
  if(drawState){
    ['line','dot','rect'].forEach(k=>{if(drawState[k]) drawState[k].remove();});
    drawState=null; return;
  }
  const last=drawings.pop();
  if(last) last.els.forEach(el=>el.remove());
}

function clearDrawings(){
  drawings.forEach(d=>d.els.forEach(el=>el.remove()));
  drawings=[];
  if(drawState){
    ['line','dot','rect'].forEach(k=>{if(drawState[k]) drawState[k].remove();});
    drawState=null;
  }
}



</script>

</body>
</html>