<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MNQ">
<meta name="theme-color" content="#050a05">
<title>MNQ</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<style>
  *{
    margin:0;padding:0;box-sizing:border-box;
    -webkit-tap-highlight-color:transparent;
    -webkit-touch-callout:none;
    -webkit-user-select:none;
    user-select:none;
  }
  :root{
    --bg:#050a05;
    --panel:#080e08;
    --green:#00ff41;
    --green2:#00cc33;
    --green3:#007a1f;
    --red:#ff3131;
    --amber:#ffb300;
    --white:#ffffff;
    --border:#0f2a0f;
    --text-dim:#2a5a2a;
    --top: env(safe-area-inset-top, 59px);
    --bot: env(safe-area-inset-bottom, 34px);
    --left: env(safe-area-inset-left, 0px);
    --right: env(safe-area-inset-right, 0px);
  }
  html{
    height: 100%;
    overflow: hidden;
    -webkit-overflow-scrolling: touch;
  }
  body{
    width: 100%;
    height: 100%;
    height: 100dvh;
    background: var(--bg);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-family: -apple-system, 'SF Mono', ui-monospace, monospace;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  #topbar{
    flex-shrink: 0;
    padding-top: calc(var(--top) + 6px);
    padding-left: calc(var(--left) + 14px);
    padding-right: calc(var(--right) + 14px);
    padding-bottom: 8px;
    background: var(--bg);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  #topbar-left{ display:flex; flex-direction:column; gap:2px; }
  #sym{ font-size:13px; font-weight:600; color:var(--green); letter-spacing:3px; }
  #status{ font-size:9px; color:var(--text-dim); letter-spacing:2px; }
  #topbar-center{
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:1px;
  }
  #price{
    font-size:28px;
    font-weight:300;
    color:var(--white);
    letter-spacing:-0.5px;
    font-variant-numeric:tabular-nums;
    line-height:1;
  }
  #subprice{
    font-size:10px;
    color:var(--text-dim);
    letter-spacing:1px;
    display:flex;
    gap:8px;
  }
  #chg{
    font-size:12px;
    font-weight:500;
    letter-spacing:0.5px;
    padding:4px 10px;
    border-radius:6px;
    min-width:72px;
    text-align:center;
    font-variant-numeric:tabular-nums;
  }
  #chg.up{ color:var(--green); background:rgba(0,255,65,0.08); border:1px solid rgba(0,255,65,0.15); }
  #chg.dn{ color:var(--red);   background:rgba(255,49,49,0.08); border:1px solid rgba(255,49,49,0.15); }
  #chart-wrap{
    flex:1;
    position:relative;
    overflow:hidden;
    touch-action:none;
  }
  #lw{ width:100%; height:100%; }
  #loading{
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    color:var(--text-dim);
    font-size:10px;
    letter-spacing:4px;
    animation: pulse 1.5s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes pulse{
    0%,100%{ opacity:0.4; }
    50%{ opacity:1; }
  }
  #fan-panel{
    position:absolute;
    bottom:0; left:0; right:0;
    background:rgba(5,10,5,0.97);
    backdrop-filter:blur(20px);
    -webkit-backdrop-filter:blur(20px);
    border-top:1px solid var(--border);
    padding:14px 16px 8px;
    z-index:200;
    transform:translateY(100%);
    transition:transform 0.28s cubic-bezier(0.4,0,0.2,1);
    overflow-y:auto;
    max-height:70%;
  }
  #fan-panel.open{ transform:translateY(0); }
  .fp-section{ margin-bottom:12px; }
  .fp-label{
    font-size:9px; letter-spacing:2px; color:var(--text-dim);
    margin-bottom:8px; display:block;
  }
  .fp-row{ display:flex; flex-wrap:wrap; gap:8px; }
  .fp-chip{
    display:flex; align-items:center; gap:6px;
    background:rgba(255,255,255,0.04);
    border:1px solid var(--border);
    border-radius:6px;
    padding:6px 12px;
    cursor:pointer;
    transition:all 0.15s;
    font-size:11px;
    letter-spacing:1px;
    min-height:36px;
  }
  .fp-chip:active{ transform:scale(0.95); }
  .fp-chip input{ display:none; }
  .fp-chip.checked{ border-color:rgba(0,255,65,0.3); background:rgba(0,255,65,0.06); }
  .fp-chip.checked .fp-dot{ background:var(--green); box-shadow:0 0 6px var(--green); }
  .fp-dot{
    width:6px; height:6px; border-radius:50%;
    background:var(--text-dim);
    flex-shrink:0;
    transition:all 0.15s;
  }
  #toolbar{
    flex-shrink:0;
    display:flex;
    align-items:stretch;
    background:var(--panel);
    border-top:1px solid var(--border);
    padding-bottom: var(--bot);
    padding-left: var(--left);
    padding-right: var(--right);
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    scrollbar-width:none;
  }
  #toolbar::-webkit-scrollbar{ display:none; }
  .tb-btn{
    flex-shrink:0;
    background:none;
    border:none;
    border-right:1px solid var(--border);
    color:var(--text-dim);
    font-family:inherit;
    font-size:11px;
    font-weight:500;
    letter-spacing:1.5px;
    padding:0 18px;
    min-height:48px;
    min-width:56px;
    cursor:pointer;
    white-space:nowrap;
    position:relative;
    transition:color 0.12s;
    -webkit-tap-highlight-color:transparent;
  }
  .tb-btn:active{ background:rgba(0,255,65,0.05); color:var(--green); }
  .tb-btn.on{ color:var(--green); }
  .tb-btn.tf.on::after{
    content:'';
    position:absolute;
    bottom:0; left:20%; right:20%;
    height:2px;
    background:var(--green);
    border-radius:2px 2px 0 0;
  }
  .tb-btn.live-on{ color:var(--green); }
  .tb-btn.live-on .live-dot{
    display:inline-block;
    width:6px; height:6px;
    border-radius:50%;
    background:var(--green);
    margin-right:5px;
    animation:blink 1.2s ease-in-out infinite;
    vertical-align:middle;
    position:relative; top:-1px;
  }
  @keyframes blink{
    0%,100%{ opacity:1; box-shadow:0 0 4px var(--green); }
    50%{ opacity:0.3; box-shadow:none; }
  }
  .tb-btn:not(.live-on) .live-dot{
    display:inline-block;
    width:6px; height:6px;
    border-radius:50%;
    background:var(--text-dim);
    margin-right:5px;
    vertical-align:middle;
    position:relative; top:-1px;
  }
  .tb-sep{
    width:1px; flex-shrink:0;
    background:var(--border);
    align-self:stretch;
  }
</style>
</head>
<body>

<div id="topbar">
  <div id="topbar-left">
    <span id="sym">MNQ1!</span>
    <span id="status">LOADING</span>
  </div>
  <div id="topbar-center">
    <div id="price">—</div>
    <div id="subprice">
      <span id="hi">H —</span>
      <span id="lo">L —</span>
    </div>
  </div>
  <div id="chg" class="up">—</div>
</div>

<div id="chart-wrap">
  <div id="lw"></div>
  <div id="loading">LOADING</div>
  <div id="fan-panel">
    <div class="fp-section">
      <span class="fp-label">HTF FAN — SUNDAY 23:00 UTC</span>
      <div class="fp-row">
        <label class="fp-chip checked" id="chip-htf-std" onclick="toggleChip('f-htf-std','chip-htf-std')">
          <span class="fp-dot"></span>
          <input type="checkbox" id="f-htf-std" checked>
          <span style="color:#00ff41">STD</span>
        </label>
        <label class="fp-chip checked" id="chip-htf-ratio" onclick="toggleChip('f-htf-ratio','chip-htf-ratio')">
          <span class="fp-dot"></span>
          <input type="checkbox" id="f-htf-ratio" checked>
          <span style="color:#ff00ff">RATIO</span>
        </label>
      </div>
    </div>
    <div class="fp-section">
      <span class="fp-label">LTF FAN — DAILY 09:00 UTC</span>
      <div class="fp-row">
        <label class="fp-chip checked" id="chip-ltf" onclick="toggleChip('f-ltf','chip-ltf')">
          <span class="fp-dot"></span>
          <input type="checkbox" id="f-ltf" checked>
          <span style="color:#00cc33">LTF</span>
        </label>
      </div>
    </div>
    <div class="fp-section">
      <span class="fp-label">ANGLES</span>
      <div class="fp-row">
        <label class="fp-chip checked" id="chip-eq" onclick="toggleChip('f-eq','chip-eq')">
          <span class="fp-dot"></span><input type="checkbox" id="f-eq" checked>
          <span style="color:#fff">EQ</span>
        </label>
        <label class="fp-chip checked" id="chip-27" onclick="toggleChip('f-27','chip-27')">
          <span class="fp-dot"></span><input type="checkbox" id="f-27" checked>
          <span style="color:#aaa">±27</span>
        </label>
        <label class="fp-chip checked" id="chip-45" onclick="toggleChip('f-45','chip-45')">
          <span class="fp-dot"></span><input type="checkbox" id="f-45" checked>
          <span style="color:#aaa">±45</span>
        </label>
        <label class="fp-chip checked" id="chip-60" onclick="toggleChip('f-60','chip-60')">
          <span class="fp-dot"></span><input type="checkbox" id="f-60" checked>
          <span style="color:#aaa">±60</span>
        </label>
        <label class="fp-chip checked" id="chip-72" onclick="toggleChip('f-72','chip-72')">
          <span class="fp-dot"></span><input type="checkbox" id="f-72" checked>
          <span style="color:#ffb300">±72</span>
        </label>
        <label class="fp-chip checked" id="chip-78" onclick="toggleChip('f-78','chip-78')">
          <span class="fp-dot"></span><input type="checkbox" id="f-78" checked>
          <span style="color:#ffb300">±78</span>
        </label>
      </div>
    </div>
    <div class="fp-section">
      <span class="fp-label">KEY LEVELS</span>
      <div class="fp-row">
        <label class="fp-chip" id="chip-kl" onclick="toggleKL()">
          <span class="fp-dot"></span>
          <span style="color:#aaa">LOAD LEVELS</span>
        </label>
      </div>
      <div id="kl-chips" style="display:none;margin-top:8px">
        <div class="fp-row" style="margin-bottom:6px">
          <label class="fp-chip checked" id="chip-kl-daily" onclick="toggleChipKL('f-kl-daily','chip-kl-daily')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-daily" checked><span style="color:#08bcd4">DAILY</span></label>
          <label class="fp-chip checked" id="chip-kl-weekly" onclick="toggleChipKL('f-kl-weekly','chip-kl-weekly')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-weekly" checked><span style="color:#fffcbc">WEEKLY</span></label>
          <label class="fp-chip checked" id="chip-kl-monthly" onclick="toggleChipKL('f-kl-monthly','chip-kl-monthly')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-monthly" checked><span style="color:#08d48c">MONTHLY</span></label>
          <label class="fp-chip" id="chip-kl-qtr" onclick="toggleChipKL('f-kl-qtr','chip-kl-qtr')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-qtr"><span style="color:#ff6666">QTR</span></label>
          <label class="fp-chip checked" id="chip-kl-yearly" onclick="toggleChipKL('f-kl-yearly','chip-kl-yearly')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-yearly" checked><span style="color:#ff3131">YEARLY</span></label>
        </div>
        <div class="fp-row">
          <label class="fp-chip checked" id="chip-kl-open" onclick="toggleChipKL('f-kl-open','chip-kl-open')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-open" checked><span style="color:#aaa">OPEN</span></label>
          <label class="fp-chip checked" id="chip-kl-hl" onclick="toggleChipKL('f-kl-hl','chip-kl-hl')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-hl" checked><span style="color:#aaa">H/L</span></label>
          <label class="fp-chip" id="chip-kl-mid" onclick="toggleChipKL('f-kl-mid','chip-kl-mid')"><span class="fp-dot"></span><input type="checkbox" id="f-kl-mid"><span style="color:#aaa">MID</span></label>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toolbar">
  <button class="tb-btn tf on" id="btn-m1"  onclick="setTF('m1')">M1</button>
  <button class="tb-btn tf"    id="btn-m5"  onclick="setTF('m5')">M5</button>
  <button class="tb-btn tf"    id="btn-m15" onclick="setTF('m15')">M15</button>
  <button class="tb-btn tf"    id="btn-h1"  onclick="setTF('h1')">H1</button>
  <div class="tb-sep"></div>
  <button class="tb-btn on" id="btn-fans" onclick="toggleFanPanel()">FANS</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" id="btn-fit" onclick="fitChart()">FIT</button>
  <button class="tb-btn live-on" id="btn-live" onclick="toggleLive()">
    <span class="live-dot"></span>LIVE
  </button>
</div>

<script>
const HTF_RATIO  = 73.3458;
const YF_SYM     = 'NQ=F';
const PROXIES    = [
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://corsproxy.io/?url=${encodeURIComponent(u)}`,
  u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
];
const TF_SECONDS = {m1:60,m5:300,m15:900,h1:3600};
const TF_YF      = {m1:'1m',m5:'5m',m15:'15m',h1:'60m'};
const TF_RANGE   = {m1:'2d',m5:'5d',m15:'7d',h1:'30d'};
const TF_LIVE_MS = {m1:2000,m5:5000,m15:10000,h1:30000};

let lwChart, candleSeries, fanSeries={}, liveTimer;
let allCandles=[], currentTF='m1', liveOn=true;
let htfAnchorTs, ltfAnchorTs, htfAnchorOpen, ltfAnchorOpen;
let fanPanelOpen=false;

function initChart(){
  const el=document.getElementById('lw');
  lwChart=LightweightCharts.createChart(el,{
    width:el.clientWidth, height:el.clientHeight,
    layout:{background:{type:'solid',color:'#050a05'},textColor:'#2a6a2a',fontSize:11},
    grid:{vertLines:{color:'#0a1a0a'},horzLines:{color:'#0a1a0a'}},
    crosshair:{
      mode:LightweightCharts.CrosshairMode.Normal,
      vertLine:{color:'#00ff4122',width:1,labelBackgroundColor:'#0a2a0a'},
      horzLine:{color:'#00ff4122',width:1,labelBackgroundColor:'#0a2a0a'},
    },
    rightPriceScale:{borderColor:'#0f2a0f',scaleMargins:{top:0.05,bottom:0.05},minimumWidth:70},
    timeScale:{borderColor:'#0f2a0f',timeVisible:true,secondsVisible:false,rightOffset:10,barSpacing:6,minBarSpacing:1},
    handleScroll:{mouseWheel:true,pressedMouseMove:true,horzTouchDrag:true,vertTouchDrag:false},
    handleScale:{mouseWheel:true,pinch:true,axisPressedMouseMove:true},
  });
  candleSeries=lwChart.addCandlestickSeries({
    upColor:'#00ff41',downColor:'#ff3131',
    borderUpColor:'#00ff41',borderDownColor:'#ff3131',
    wickUpColor:'#00882a',wickDownColor:'#881111',
    priceLineVisible:false,
  });
  lwChart.subscribeCrosshairMove(p=>{
    if(p.seriesData?.size){
      const d=p.seriesData.get(candleSeries);
      if(d) setPrice(d.close||d.value,d.high,d.low);
    }
  });
  new ResizeObserver(()=>{
    lwChart.applyOptions({width:el.clientWidth,height:el.clientHeight});
  }).observe(el);
}

async function yfFetch(params){
  const url=`https://query1.finance.yahoo.com/v8/finance/chart/${YF_SYM}?${params}`;
  for(const px of PROXIES){
    try{
      const r=await fetch(px(url),{signal:AbortSignal.timeout(9000)});
      if(!r.ok) continue;
      const d=JSON.parse(await r.text());
      if(d?.chart?.result?.[0]) return d;
    }catch{ continue; }
  }
  return null;
}

async function loadCandles(tf){
  stat('FETCHING');
  const d=await yfFetch(`interval=${TF_YF[tf]}&range=${TF_RANGE[tf]}`);
  if(!d){ stat('FAILED'); return []; }
  const q=d.chart.result[0],ts=q.timestamp,ohlc=q.indicators.quote[0],out=[];
  for(let i=0;i<ts.length;i++){
    if(ohlc.close[i]==null) continue;
    out.push({time:ts[i],open:ohlc.open[i],high:ohlc.high[i],low:ohlc.low[i],close:ohlc.close[i]});
  }
  return out;
}

async function loadLastCandle(tf){
  const d=await yfFetch(`interval=${TF_YF[tf]}&range=1d`);
  if(!d) return null;
  const q=d.chart.result[0],ts=q.timestamp,ohlc=q.indicators.quote[0];
  for(let i=ts.length-1;i>=0;i--){
    if(ohlc.close[i]!=null)
      return {time:ts[i],open:ohlc.open[i],high:ohlc.high[i],low:ohlc.low[i],close:ohlc.close[i]};
  }
  return null;
}

async function loadDayStats(){
  const d=await yfFetch('interval=1d&range=5d');
  if(!d) return null;
  const q=d.chart.result[0],ohlc=q.indicators.quote[0],i=ohlc.close.length-1;
  return {price:ohlc.close[i],open:ohlc.open[i],high:ohlc.high[i],low:ohlc.low[i],prevClose:ohlc.close[i-1]};
}

function getSunday2300(){
  const n=new Date(),d=n.getUTCDay();
  const s=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate()-(d===0?0:d),23,0,0));
  if(s>n) s.setUTCDate(s.getUTCDate()-7);
  return s;
}
function getToday0900(){
  const n=new Date();
  return new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),9,0,0));
}
function anchorOpenFromCandles(candles,ts){
  const s=ts.getTime()/1000;
  const c=candles.find(c=>c.time>=s);
  return c?c.open:candles[0]?.open??null;
}

function chk(id){ return document.getElementById(id)?.checked; }

function fanDefs(type){
  const r=type==='HTF_R',h=type==='HTF';
  if(r) return [
    {l:'EQ', d:0,   c:'#ffffff',w:1,s:()=>chk('f-eq')},
    {l:'+27',d:27,  c:'#ffb300',w:1,s:()=>chk('f-27')},
    {l:'-27',d:-27, c:'#ff00ff',w:1,s:()=>chk('f-27')},
    {l:'+45',d:45,  c:'#ffb300',w:1,s:()=>chk('f-45')},
    {l:'-45',d:-45, c:'#ff00ff',w:1,s:()=>chk('f-45')},
    {l:'+60',d:60,  c:'#ffb300',w:1,s:()=>chk('f-60')},
    {l:'-60',d:-60, c:'#ff00ff',w:1,s:()=>chk('f-60')},
    {l:'+72',d:72,  c:'#ffdd00',w:2,s:()=>chk('f-72')},
    {l:'-72',d:-72, c:'#ffdd00',w:2,s:()=>chk('f-72')},
    {l:'+78',d:78,  c:'#ffdd00',w:2,s:()=>chk('f-78')},
    {l:'-78',d:-78, c:'#ffdd00',w:2,s:()=>chk('f-78')},
  ];
  return [
    {l:'EQ', d:0,   c:h?'#ffffff':'#888888',w:1,s:()=>chk('f-eq')},
    {l:'+27',d:27,  c:h?'#00ff41':'#00aa2a',w:1,s:()=>chk('f-27')},
    {l:'-27',d:-27, c:h?'#ff3131':'#aa1111',w:1,s:()=>chk('f-27')},
    {l:'+45',d:45,  c:h?'#00ff41':'#00aa2a',w:1,s:()=>chk('f-45')},
    {l:'-45',d:-45, c:h?'#ff3131':'#aa1111',w:1,s:()=>chk('f-45')},
    {l:'+60',d:60,  c:h?'#00ff41':'#00aa2a',w:1,s:()=>chk('f-60')},
    {l:'-60',d:-60, c:h?'#ff3131':'#aa1111',w:1,s:()=>chk('f-60')},
    {l:'+72',d:72,  c:h?'#ffb300':'#cc8800',w:2,s:()=>chk('f-72')},
    {l:'-72',d:-72, c:h?'#ffb300':'#cc8800',w:2,s:()=>chk('f-72')},
    {l:'+78',d:78,  c:h?'#ffb300':'#cc8800',w:2,s:()=>chk('f-78')},
    {l:'-78',d:-78, c:h?'#ffb300':'#cc8800',w:2,s:()=>chk('f-78')},
  ];
}

function clearFans(){
  for(const s of Object.values(fanSeries)){try{lwChart.removeSeries(s);}catch{}}
  fanSeries={};
}

function drawFan(type,anchorTs,anchorOpen,ratio){
  if(!anchorOpen||!allCandles.length) return;
  const defs=fanDefs(type);
  const anchorSec=anchorTs.getTime()/1000;
  const spb=TF_SECONDS[currentTF];
  const slice=allCandles.filter(c=>c.time>=anchorSec);
  if(slice.length<2) return;
  const isLTF=type==='LTF';
  for(const def of defs){
    if(!def.s()) continue;
    const data=slice.map(c=>({
      time:c.time,
      value:anchorOpen+Math.round((c.time-anchorSec)/spb)*(ratio||1)*Math.tan(def.d*Math.PI/180)
    }));
    const s=lwChart.addLineSeries({
      color:def.c,lineWidth:def.w,lineStyle:isLTF?2:0,
      priceLineVisible:false,lastValueVisible:true,
      title:def.l,crosshairMarkerVisible:false,
    });
    s.setData(data);
    fanSeries[`${type}_${def.l}`]=s;
  }
}

function applyFans(){
  clearFans();
  if(chk('f-htf-std'))   drawFan('HTF',  htfAnchorTs,htfAnchorOpen,1);
  if(chk('f-htf-ratio')) drawFan('HTF_R',htfAnchorTs,htfAnchorOpen,HTF_RATIO);
  if(chk('f-ltf'))       drawFan('LTF',  ltfAnchorTs,ltfAnchorOpen,1);
}

async function load(tf){
  stopLive();
  currentTF=tf;
  document.querySelectorAll('.tb-btn.tf').forEach(b=>b.classList.remove('on'));
  document.getElementById('btn-'+tf)?.classList.add('on');
  allCandles=await loadCandles(tf);
  if(!allCandles.length){ stat('NO DATA'); return; }
  htfAnchorTs  =getSunday2300();
  ltfAnchorTs  =getToday0900();
  htfAnchorOpen=anchorOpenFromCandles(allCandles,htfAnchorTs);
  ltfAnchorOpen=anchorOpenFromCandles(allCandles,ltfAnchorTs);
  candleSeries.setData(allCandles);
  applyFans();
  lwChart.timeScale().fitContent();
  const last=allCandles[allCandles.length-1];
  if(last) setPrice(last.close,last.high,last.low);
  document.getElementById('loading').style.display='none';
  stat('LIVE');
  if(liveOn) startLive();
}

function startLive(){
  stopLive();
  liveTimer=setInterval(async()=>{
    const c=await loadLastCandle(currentTF);
    if(!c) return;
    try{ candleSeries.update(c); }catch{}
    const last=allCandles[allCandles.length-1];
    if(last&&last.time===c.time) allCandles[allCandles.length-1]=c;
    else if(!last||c.time>last.time) allCandles.push(c);
    setPrice(c.close,c.high,c.low);
  },TF_LIVE_MS[currentTF]);
}
function stopLive(){ if(liveTimer){clearInterval(liveTimer);liveTimer=null;} }

function toggleLive(){
  liveOn=!liveOn;
  const b=document.getElementById('btn-live');
  b.className='tb-btn'+(liveOn?' live-on':'');
  b.innerHTML=`<span class="live-dot"></span>LIVE`;
  if(liveOn) startLive(); else stopLive();
}

function setTF(tf){ if(tf!==currentTF) load(tf); }
function fitChart(){ lwChart.timeScale().fitContent(); }

function toggleFanPanel(){
  fanPanelOpen=!fanPanelOpen;
  document.getElementById('fan-panel').classList.toggle('open',fanPanelOpen);
  document.getElementById('btn-fans').classList.toggle('on',fanPanelOpen);
}

function toggleChip(inputId,chipId){
  const inp=document.getElementById(inputId);
  const chip=document.getElementById(chipId);
  inp.checked=!inp.checked;
  chip.classList.toggle('checked',inp.checked);
  applyFans();
  return false;
}

function stat(s){ document.getElementById('status').textContent=s; }
function fmt(n){ if(n==null) return '—'; return n.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function setPrice(price,high,low){
  document.getElementById('price').textContent=fmt(price);
  if(high!=null) document.getElementById('hi').textContent='H '+fmt(high);
  if(low!=null)  document.getElementById('lo').textContent='L '+fmt(low);
}

async function updateDayStats(){
  const d=await loadDayStats();
  if(!d) return;
  setPrice(d.price,d.high,d.low);
  if(d.prevClose){
    const chg=((d.price-d.prevClose)/d.prevClose)*100;
    const el=document.getElementById('chg');
    el.textContent=(chg>=0?'+':'')+chg.toFixed(2)+'%';
    el.className='chg '+(chg>=0?'up':'dn');
  }
}

document.getElementById('fan-panel').addEventListener('touchmove',e=>e.stopPropagation(),{passive:true});

// ── KEY LEVELS ────────────────────────────────────────
let klData=null, klLines=[], klLoaded=false, klOn=false;

async function fetchKLData(){
  try{
    const [dData,wData,mData]=await Promise.all([
      yfFetch('interval=1d&range=10d'),
      yfFetch('interval=1wk&range=3mo'),
      yfFetch('interval=1mo&range=2y'),
    ]);
    function parseYF(d,i=0){
      const q=d.chart.result[0],qt=q.indicators.quote[0],n=qt.close.length-1-i;
      return {open:qt.open[n],high:qt.high[n],low:qt.low[n],close:qt.close[n]};
    }
    const nowYear=new Date().getUTCFullYear();
    const mq=mData.chart.result[0],mts=mq.timestamp,mqt=mq.indicators.quote[0];
    let yOpen=null,yHigh=null,yLow=null;
    for(let i=0;i<mts.length;i++){
      if(new Date(mts[i]*1000).getUTCFullYear()===nowYear){
        if(yOpen===null) yOpen=mqt.open[i];
        if(mqt.high[i]!=null&&(yHigh===null||mqt.high[i]>yHigh)) yHigh=mqt.high[i];
        if(mqt.low[i]!=null&&(yLow===null||mqt.low[i]<yLow)) yLow=mqt.low[i];
      }
    }
    const qm=Math.floor(new Date().getUTCMonth()/3)*3;
    let qOpen=null;
    for(let i=0;i<mts.length;i++){
      const d2=new Date(mts[i]*1000);
      if(d2.getUTCFullYear()===nowYear&&d2.getUTCMonth()===qm){qOpen=mqt.open[i];break;}
    }
    return {
      daily:    {open:parseYF(dData,0).open},
      prevDay:  {high:parseYF(dData,1).high,low:parseYF(dData,1).low},
      weekly:   {open:parseYF(wData,0).open},
      prevWeek: {high:parseYF(wData,1).high,low:parseYF(wData,1).low},
      monthly:  {open:parseYF(mData,0).open},
      prevMonth:{high:parseYF(mData,1).high,low:parseYF(mData,1).low},
      quarterly:{open:qOpen},
      yearly:   {open:yOpen,high:yHigh,low:yLow},
    };
  }catch(e){ console.error('KL fetch',e); return null; }
}

function klMakeLine(price,title,color,dashed=false){
  if(!price||!candleSeries) return;
  const pl=candleSeries.createPriceLine({
    price,title,color,lineWidth:1,
    lineStyle:dashed?2:0,
    axisLabelVisible:true,
    axisLabelColor:color,
  });
  klLines.push(pl);
}

function clearKL(){
  for(const pl of klLines){try{candleSeries.removePriceLine(pl);}catch{}}
  klLines=[];
}

function redrawKL(){
  clearKL();
  if(!klData||!klOn) return;
  const d=klData;
  const showOpen=chk('f-kl-open'),showHL=chk('f-kl-hl'),showMid=chk('f-kl-mid');
  if(chk('f-kl-daily')){
    if(showOpen) klMakeLine(d.daily.open,  'DO',  '#08bcd4');
    if(showHL)   klMakeLine(d.prevDay.high,'PDH', '#08bcd4',true);
    if(showHL)   klMakeLine(d.prevDay.low, 'PDL', '#08bcd4',true);
    if(showMid&&d.prevDay.high&&d.prevDay.low)
      klMakeLine((d.prevDay.high+d.prevDay.low)/2,'PDM','#08bcd4',true);
  }
  if(chk('f-kl-weekly')){
    if(showOpen) klMakeLine(d.weekly.open,   'WO',  '#fffcbc');
    if(showHL)   klMakeLine(d.prevWeek.high, 'PWH', '#fffcbc',true);
    if(showHL)   klMakeLine(d.prevWeek.low,  'PWL', '#fffcbc',true);
    if(showMid&&d.prevWeek.high&&d.prevWeek.low)
      klMakeLine((d.prevWeek.high+d.prevWeek.low)/2,'PWM','#fffcbc',true);
  }
  if(chk('f-kl-monthly')){
    if(showOpen) klMakeLine(d.monthly.open,   'MO',  '#08d48c');
    if(showHL)   klMakeLine(d.prevMonth.high, 'PMH', '#08d48c',true);
    if(showHL)   klMakeLine(d.prevMonth.low,  'PML', '#08d48c',true);
    if(showMid&&d.prevMonth.high&&d.prevMonth.low)
      klMakeLine((d.prevMonth.high+d.prevMonth.low)/2,'PMM','#08d48c',true);
  }
  if(chk('f-kl-qtr')&&showOpen)
    klMakeLine(d.quarterly.open,'QO','#ff6666');
  if(chk('f-kl-yearly')){
    if(showOpen) klMakeLine(d.yearly.open, 'YO',  '#ff3131');
    if(showHL)   klMakeLine(d.yearly.high, 'CYH', '#ff3131',true);
    if(showHL)   klMakeLine(d.yearly.low,  'CYL', '#ff3131',true);
    if(showMid&&d.yearly.high&&d.yearly.low)
      klMakeLine((d.yearly.high+d.yearly.low)/2,'CYM','#ff3131',true);
  }
}

function toggleChipKL(inputId,chipId){
  const inp=document.getElementById(inputId);
  const chip=document.getElementById(chipId);
  inp.checked=!inp.checked;
  chip.classList.toggle('checked',inp.checked);
  redrawKL();
  return false;
}

async function toggleKL(){
  const chip=document.getElementById('chip-kl');
  const chips=document.getElementById('kl-chips');
  if(!klLoaded){
    chip.querySelector('span:last-child').textContent='LOADING...';
    klData=await fetchKLData();
    klLoaded=true;
    chip.querySelector('span:last-child').textContent='KEY LEVELS';
  }
  klOn=!klOn;
  chip.classList.toggle('checked',klOn);
  chips.style.display=klOn?'block':'none';
  redrawKL();
}

// ── BOOT ──────────────────────────────────────────────
window.addEventListener('load',async()=>{
  initChart();
  load('m1');
  updateDayStats();
  setInterval(updateDayStats,60000);
});
</script>
</body>
</html>
