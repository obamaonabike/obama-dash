<!DOCTYPE html>

<html lang="en" style="background:#050f05">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#070d07">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ObamaDash - WX Backtest</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { background:#050f05; }
body { width:100%; min-height:100dvh; background:#050f05; color:#00cc33; font-family:"Share Tech Mono",monospace; font-size:11px; letter-spacing:0.5px; -webkit-text-size-adjust:100%; }
#app { display:flex; flex-direction:column; min-height:100dvh; }
.bar { flex-shrink:0; display:flex; align-items:center; justify-content:space-between; padding:0 10px; height:24px; background:#070d07; color:#006618; font-size:10px; letter-spacing:2px; text-transform:uppercase; }
.bar-top { border-bottom:1px solid #0f2a0f; padding-top:env(safe-area-inset-top); height:calc(24px + env(safe-area-inset-top)); }
.bar-bottom { border-top:1px solid #0f2a0f; padding-top:5px; padding-bottom:calc(env(safe-area-inset-bottom)+5px); height:auto; min-height:24px; align-items:flex-start; }
.bar-title { font-size:11px; letter-spacing:4px; color:#00cc33; }
.nav-link { color:#004a14; font-family:"Share Tech Mono",monospace; font-size:9px; letter-spacing:2px; text-decoration:none; margin-left:8px; }
.content { flex:1; padding:10px; overflow-y:auto; }
.cfg-row { display:flex; align-items:center; gap:8px; margin-bottom:6px; flex-wrap:wrap; }
.cfg-label { font-size:9px; color:#006618; letter-spacing:1px; min-width:160px; }
.cfg-input { background:#030803; border:1px solid #0f2a0f; color:#00cc33; font-family:"Share Tech Mono",monospace; font-size:10px; padding:4px 6px; width:80px; }
.cfg-input:focus { border-color:#00cc33; outline:none; }
.run-btn { background:#030803; border:1px solid #00cc33; color:#00cc33; font-family:"Share Tech Mono",monospace; font-size:10px; letter-spacing:2px; padding:7px 20px; cursor:pointer; margin-top:8px; }
.run-btn:active { background:#001a06; }
.run-btn:disabled { border-color:#0f2a0f; color:#006618; cursor:not-allowed; }
.summary-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:4px; margin:10px 0; }
.sum-card { background:#070d07; border:1px solid #0f2a0f; padding:8px; }
.sum-label { font-size:8px; color:#006618; letter-spacing:2px; text-transform:uppercase; margin-bottom:4px; }
.sum-val { font-size:15px; color:#00cc33; letter-spacing:1px; }
.sum-sub { font-size:8px; color:#004a14; margin-top:2px; }
.section-title { font-size:9px; color:#006618; letter-spacing:3px; text-transform:uppercase; padding:8px 0 4px; border-bottom:1px solid #0f2a0f; margin-bottom:6px; }
table { width:100%; border-collapse:collapse; margin-bottom:12px; font-size:9px; }
th { color:#004a14; letter-spacing:2px; padding:4px; border-bottom:1px solid #0f2a0f; text-align:left; font-size:8px; }
td { color:#00cc33; padding:4px; border-bottom:1px solid #050f05; }
td.dim { color:#006618; } td.hi { color:#00ff41; } td.lo { color:#ff4444; }
.day-row { border-bottom:1px solid #0a1a0a; padding:6px 0; }
.day-date { color:#006618; font-size:9px; letter-spacing:1px; }
.day-detail { color:#004a14; font-size:8px; margin-top:2px; letter-spacing:0.5px; }
.ok { color:#00cc33; } .no { color:#333; }
.progress-wrap { background:#0a1a0a; border:1px solid #0f2a0f; height:6px; margin:8px 0; }
.progress-bar { background:#00cc33; height:100%; width:0%; transition:width 0.2s; }
</style>
</head>
<body>
<div id="app">
  <div class="bar bar-top">
    <span class="bar-title">WX BACKTEST</span>
    <div>
      <a href="index.html" class="nav-link">BTC</a>
      <a href="backtest.html" class="nav-link">BT</a>
      <a href="weather.html" class="nav-link">WX</a>
    </div>
  </div>
  <div class="content">
    <div class="cfg-row"><span class="cfg-label">DAYS (MAX 7)</span><input class="cfg-input" id="cfg-days" type="number" value="7" min="1" max="7"></div>
    <div class="cfg-row"><span class="cfg-label">TOLERANCE (C)</span><input class="cfg-input" id="cfg-tol" type="number" value="0.3" step="0.05" min="0.05"></div>
    <div class="cfg-row"><span class="cfg-label">ANCHOR HOUR UTC</span><input class="cfg-input" id="cfg-anchor" type="number" value="9" min="0" max="23"></div>
    <div class="cfg-row"><span class="cfg-label">HTF RATIO</span><input class="cfg-input" id="cfg-ratio" type="number" value="60" step="1" min="1"></div>
    <button class="run-btn" id="run-btn" onclick="runBacktest()">RUN BACKTEST</button>
    <div class="progress-wrap" id="pwrap" style="display:none"><div class="progress-bar" id="pbar"></div></div>
    <div id="status-line" style="font-size:9px;color:#006618;margin:4px 0;letter-spacing:1px;min-height:14px"></div>
    <div id="results" style="display:none">
      <div class="section-title">// SUMMARY</div>
      <div class="summary-grid">
        <div class="sum-card"><div class="sum-label">DAYS TESTED</div><div class="sum-val" id="s-days">--</div><div class="sum-sub">15MIN RESOLUTION</div></div>
        <div class="sum-card"><div class="sum-label">HIGH HIT RATE</div><div class="sum-val" id="s-hi">--</div><div class="sum-sub">DAILY HIGH ON FAN</div></div>
        <div class="sum-card"><div class="sum-label">LOW HIT RATE</div><div class="sum-val" id="s-lo">--</div><div class="sum-sub">DAILY LOW ON FAN</div></div>
        <div class="sum-card"><div class="sum-label">BOTH HIT</div><div class="sum-val" id="s-both">--</div><div class="sum-sub">HIGH + LOW SAME DAY</div></div>
        <div class="sum-card"><div class="sum-label">AVG DIST HIGH</div><div class="sum-val" id="s-hdist">--</div><div class="sum-sub">NEAREST LEVEL</div></div>
        <div class="sum-card"><div class="sum-label">AVG DIST LOW</div><div class="sum-val" id="s-ldist">--</div><div class="sum-sub">NEAREST LEVEL</div></div>
      </div>
      <div class="section-title">// BY LEVEL</div>
      <table><thead><tr><th>LEVEL</th><th>HIGH HITS</th><th>LOW HITS</th><th>TOTAL</th><th>RATE</th></tr></thead><tbody id="lvl-table"></tbody></table>
      <div class="section-title">// DAY LOG</div>
      <div id="day-log"></div>
    </div>
  </div>
  <div class="bar bar-bottom">
    <span id="bar-status">READY</span>
    <span id="bar-time" style="font-size:9px;color:#004a14"></span>
  </div>
</div>
<script>
var LAT = 51.5048, LON = 0.0495;
var ANGLES = [27,-27,45,-45,60,-60,72,-72,78,-78];

function fanTemp(aT, hrs, deg, ratio) {
return aT + hrs * (ratio||1) * Math.tan(deg * Math.PI / 180);
}
function setStatus(s) {
document.getElementById(“bar-status”).textContent = s;
document.getElementById(“status-line”).textContent = s;
}
function setProgress(p) { document.getElementById(“pbar”).style.width = p + “%”; }
function pct(h, t) { return t > 0 ? (h/t*100).toFixed(0) + “%” : “–”; }

// Open-Meteo: fetch last N days of 15min + hourly data
// Returns one call covering the whole range
function fetchOpenMeteo(days) {
var now = new Date();
var start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()-days-1));
var end   = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
var startStr = start.toISOString().slice(0,10);
var endStr   = end.toISOString().slice(0,10);
var url = “https://api.open-meteo.com/v1/forecast?latitude=” + LAT + “&longitude=” + LON +
“&minutely_15=temperature_2m&hourly=temperature_2m&temperature_unit=celsius&timezone=UTC” +
“&start_date=” + startStr + “&end_date=” + endStr;
return fetch(url).then(function(r) {
if (!r.ok) throw new Error(“Open-Meteo “ + r.status);
return r.json();
});
}

function runBacktest() {
var days = Math.min(parseInt(document.getElementById(“cfg-days”).value)||7, 7);
var tol  = parseFloat(document.getElementById(“cfg-tol”).value)||0.3;
var anchorHour = parseInt(document.getElementById(“cfg-anchor”).value)||9;
var ratio = parseFloat(document.getElementById(“cfg-ratio”).value)||60;

document.getElementById(“run-btn”).disabled = true;
document.getElementById(“results”).style.display = “none”;
document.getElementById(“pwrap”).style.display = “block”;
setProgress(5); setStatus(“Fetching data from Open-Meteo (free, no key)…”);

fetchOpenMeteo(days).then(function(d) {
setProgress(40); setStatus(“Parsing…”);

```
// Parse 15min data
var m15times = d.minutely_15 && d.minutely_15.time || [];
var m15temps = d.minutely_15 && d.minutely_15.temperature_2m || [];
var m15rows = [];
for (var i = 0; i < m15times.length; i++) {
  if (m15temps[i] === null || m15temps[i] === undefined) continue;
  m15rows.push({ time: new Date(m15times[i] + ":00Z"), temp: m15temps[i] });
}

// Parse hourly data
var htimes = d.hourly && d.hourly.time || [];
var htemps = d.hourly && d.hourly.temperature_2m || [];
var hrows = [];
for (var i = 0; i < htimes.length; i++) {
  if (htemps[i] === null || htemps[i] === undefined) continue;
  hrows.push({ time: new Date(htimes[i] + ":00Z"), temp: htemps[i] });
}

setProgress(55); setStatus("Analysing days...");

// Build date list: last N days excluding today
var now = new Date();
var dates = [];
for (var i = days; i >= 1; i--) {
  var d2 = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()-i));
  dates.push(d2);
}

var dayResults = [];
var levelHits = {};
ANGLES.forEach(function(deg) { levelHits[deg] = {hi:0, lo:0, days:0}; });

dates.forEach(function(date) {
  var dateStr = date.toISOString().slice(0,10);
  var anchorTime = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), anchorHour, 0, 0));
  var dayEnd     = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), 23, 59, 0));

  // Anchor temp from hourly
  var anchorEntry = null;
  for (var i = 0; i < hrows.length; i++) {
    if (Math.abs(hrows[i].time.getTime() - anchorTime.getTime()) < 1800000) { anchorEntry = hrows[i]; break; }
  }
  if (!anchorEntry) return;
  var aT = anchorEntry.temp;

  // 15min readings for this day after anchor
  var mins = m15rows.filter(function(m) { return m.time >= anchorTime && m.time <= dayEnd; });
  if (mins.length < 4) return;

  var dayHigh = -Infinity, dayLow = Infinity;
  var highEntry = null, lowEntry = null;
  mins.forEach(function(m) {
    if (m.temp > dayHigh) { dayHigh = m.temp; highEntry = m; }
    if (m.temp < dayLow)  { dayLow  = m.temp; lowEntry  = m; }
  });

  var bestHiDist = Infinity, bestHiDeg = null;
  var bestLoDist = Infinity, bestLoDeg = null;

  ANGLES.forEach(function(deg) {
    if (highEntry) {
      var hrs = (highEntry.time.getTime() - anchorTime.getTime()) / 3600000;
      [fanTemp(aT, hrs, deg), fanTemp(aT, hrs/ratio, deg)].forEach(function(v) {
        var dist = Math.abs(dayHigh - v);
        if (dist < bestHiDist) { bestHiDist = dist; bestHiDeg = deg; }
        if (dist <= tol) levelHits[deg].hi++;
      });
    }
    if (lowEntry) {
      var hrs = (lowEntry.time.getTime() - anchorTime.getTime()) / 3600000;
      [fanTemp(aT, hrs, deg), fanTemp(aT, hrs/ratio, deg)].forEach(function(v) {
        var dist = Math.abs(dayLow - v);
        if (dist < bestLoDist) { bestLoDist = dist; bestLoDeg = deg; }
        if (dist <= tol) levelHits[deg].lo++;
      });
    }
    levelHits[deg].days++;
  });

  dayResults.push({
    dateStr:dateStr, aT:aT, dayHigh:dayHigh, dayLow:dayLow,
    highHit:bestHiDist<=tol, lowHit:bestLoDist<=tol,
    bestHiDist:bestHiDist, bestHiDeg:bestHiDeg,
    bestLoDist:bestLoDist, bestLoDeg:bestLoDeg,
    highTime:highEntry ? highEntry.time : null,
    lowTime:lowEntry   ? lowEntry.time  : null
  });
});

setProgress(100);
renderResults(dayResults, levelHits);
```

}).catch(function(e) {
setStatus(“ERROR: “ + e.message);
console.error(e);
document.getElementById(“run-btn”).disabled = false;
});
}

function renderResults(dayResults, levelHits) {
document.getElementById(“run-btn”).disabled = false;
if (!dayResults.length) { setStatus(“No data returned”); return; }
var n = dayResults.length;
var hiHits   = dayResults.filter(function(d) { return d.highHit; }).length;
var loHits   = dayResults.filter(function(d) { return d.lowHit; }).length;
var bothHits = dayResults.filter(function(d) { return d.highHit && d.lowHit; }).length;

document.getElementById(“s-days”).textContent  = n;
document.getElementById(“s-hi”).textContent    = pct(hiHits, n);
document.getElementById(“s-lo”).textContent    = pct(loHits, n);
document.getElementById(“s-both”).textContent  = pct(bothHits, n);
document.getElementById(“s-hdist”).textContent = (dayResults.reduce(function(a,d){return a+d.bestHiDist;},0)/n).toFixed(2)+“C”;
document.getElementById(“s-ldist”).textContent = (dayResults.reduce(function(a,d){return a+d.bestLoDist;},0)/n).toFixed(2)+“C”;

var tbody = document.getElementById(“lvl-table”);
tbody.innerHTML = “”;
var sorted = ANGLES.slice().sort(function(a,b) {
return (levelHits[b].hi+levelHits[b].lo) - (levelHits[a].hi+levelHits[a].lo);
});
sorted.forEach(function(deg) {
var lv = levelHits[deg];
var total = lv.hi + lv.lo;
var rate = lv.days > 0 ? (total/(lv.days*2)*100).toFixed(0)+”%” : “–”;
var tr = document.createElement(“tr”);
tr.innerHTML = “<td>”+(deg>0?“L+”:“L”)+deg+”</td>” +
“<td class="”+(lv.hi>0?“hi”:“dim”)+”">”+lv.hi+”</td>” +
“<td class="”+(lv.lo>0?“lo”:“dim”)+”">”+lv.lo+”</td>” +
“<td>”+total+”</td>” +
“<td class="”+(total>lv.days?“hi”:total>0?””:“dim”)+”">”+rate+”</td>”;
tbody.appendChild(tr);
});

var log = document.getElementById(“day-log”);
log.innerHTML = “”;
dayResults.slice().reverse().forEach(function(d) {
var ht = d.highTime ? d.highTime.toUTCString().slice(17,22)+“UTC” : “–”;
var lt = d.lowTime  ? d.lowTime.toUTCString().slice(17,22)+“UTC”  : “–”;
var div = document.createElement(“div”);
div.className = “day-row”;
div.innerHTML =
“<div class="day-date">”+d.dateStr+” – ANCHOR “+d.aT.toFixed(1)+“C</div>” +
“<div class="day-detail">HIGH “+d.dayHigh.toFixed(1)+“C @ “+ht+” <span class="”+(d.highHit?“ok”:“no”)+”">”+(d.highHit?“HIT”:“MISS”)+” (L”+(d.bestHiDeg>0?”+”:””)+d.bestHiDeg+”: “+d.bestHiDist.toFixed(2)+“C)</span></div>” +
“<div class="day-detail">LOW  “+d.dayLow.toFixed(1)+“C @ “+lt+” <span class="”+(d.lowHit?“ok”:“no”)+”">”+(d.lowHit?“HIT”:“MISS”)+” (L”+(d.bestLoDeg>0?”+”:””)+d.bestLoDeg+”: “+d.bestLoDist.toFixed(2)+“C)</span></div>”;
log.appendChild(div);
});

document.getElementById(“results”).style.display = “block”;
setStatus(“DONE – “ + n + “ days tested (Open-Meteo, 15min resolution)”);
}

setInterval(function() {
document.getElementById(“bar-time”).textContent = new Date().toUTCString().slice(5,22).toUpperCase()+” UTC”;
}, 1000);
</script>

</body>
</html>