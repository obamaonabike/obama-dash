<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>WX Backtest</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#050f05;color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:11px;min-height:100dvh;-webkit-text-size-adjust:100%}
.bar{display:flex;align-items:center;justify-content:space-between;padding:0 10px;height:24px;background:#070d07;font-size:10px;letter-spacing:2px;text-transform:uppercase;border-bottom:1px solid #0f2a0f}
.bar.bot{border-top:1px solid #0f2a0f;border-bottom:none;padding-bottom:env(safe-area-inset-bottom)}
a{color:#004a14;font-size:9px;letter-spacing:2px;text-decoration:none;margin-left:8px}
.content{padding:10px;overflow-y:auto}
.row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.lbl{font-size:9px;color:#006618;letter-spacing:1px;min-width:160px}
input{background:#030803;border:1px solid #0f2a0f;color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:10px;padding:4px 6px;width:80px}
button{background:#030803;border:1px solid #00cc33;color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:10px;letter-spacing:2px;padding:7px 20px;cursor:pointer;margin-top:8px;-webkit-appearance:none}
button:disabled{border-color:#0f2a0f;color:#006618}
#msg{font-size:9px;margin:6px 0;min-height:14px;letter-spacing:1px;word-break:break-all}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin:10px 0}
.card{background:#070d07;border:1px solid #0f2a0f;padding:8px}
.clbl{font-size:8px;color:#006618;letter-spacing:2px;margin-bottom:4px}
.cval{font-size:15px}
.sec{font-size:9px;color:#006618;letter-spacing:3px;padding:8px 0 4px;border-bottom:1px solid #0f2a0f;margin-bottom:6px}
table{width:100%;border-collapse:collapse;margin-bottom:12px;font-size:9px}
th{color:#004a14;padding:4px;border-bottom:1px solid #0f2a0f;text-align:left;font-size:8px;letter-spacing:1px}
td{padding:4px;border-bottom:1px solid #050f05}
.hi{color:#00ff41}.lo{color:#ff4444}.dim{color:#006618}
.drow{border-bottom:1px solid #0a1a0a;padding:6px 0}
.ddate{color:#006618;font-size:9px}
.dline{font-size:8px;margin-top:2px;color:#004a14}
.ok{color:#00cc33}.no{color:#444}
</style>
</head>
<body>
<div class="bar">
  <span style="letter-spacing:4px;color:#00cc33">WX BACKTEST</span>
  <div><a href="index.html">BTC</a><a href="backtest.html">BT</a><a href="weather.html">WX</a></div>
</div>
<div class="content">
  <div class="row"><span class="lbl">DAYS (MAX 7)</span><input id="i-days" type="number" value="5" min="1" max="7"></div>
  <div class="row"><span class="lbl">TOLERANCE (C)</span><input id="i-tol" type="number" value="0.3" step="0.05" min="0.05"></div>
  <div class="row"><span class="lbl">ANCHOR HOUR UTC</span><input id="i-anc" type="number" value="9" min="0" max="23"></div>
  <div class="row"><span class="lbl">HTF RATIO</span><input id="i-rat" type="number" value="60" step="1" min="1"></div>
  <button id="btn" onclick="run()">RUN BACKTEST</button>
  <div id="msg" style="color:#006618">READY</div>
  <div id="results" style="display:none">
    <div class="sec">// SUMMARY</div>
    <div class="grid">
      <div class="card"><div class="clbl">DAYS</div><div class="cval" id="s-n">-</div></div>
      <div class="card"><div class="clbl">HIGH HIT</div><div class="cval" id="s-hi">-</div></div>
      <div class="card"><div class="clbl">LOW HIT</div><div class="cval" id="s-lo">-</div></div>
      <div class="card"><div class="clbl">BOTH HIT</div><div class="cval" id="s-bo">-</div></div>
      <div class="card"><div class="clbl">AVG DIST HI</div><div class="cval" id="s-hd">-</div></div>
      <div class="card"><div class="clbl">AVG DIST LO</div><div class="cval" id="s-ld">-</div></div>
    </div>
    <div class="sec">// BY LEVEL</div>
    <table><thead><tr><th>LEVEL</th><th>HI HITS</th><th>LO HITS</th><th>TOTAL</th><th>RATE</th></tr></thead><tbody id="ltbl"></tbody></table>
    <div class="sec">// DAY LOG</div>
    <div id="dlog"></div>
  </div>
</div>
<div class="bar bot"><span id="bst">READY</span></div>

<script type="text/javascript">
var ANGLES = [27,-27,45,-45,60,-60,72,-72,78,-78];

// Safari-safe ISO parser: "2026-02-26T00:00" -> add seconds before Z
function parseT(s) {
  if (!s) return new Date(NaN);
  // Already has seconds (16+ chars with colon at pos 13)
  if (s.length > 16) return new Date(s);
  // "2026-02-26T00:00" -> "2026-02-26T00:00:00Z"
  return new Date(s + ":00Z");
}

function fan(aT, hrs, deg, ratio) {
  return aT + hrs * ratio * Math.tan(deg * Math.PI / 180);
}

function setMsg(s, col) {
  document.getElementById("msg").textContent = s;
  document.getElementById("msg").style.color = col || "#006618";
  document.getElementById("bst").textContent = s;
}

function pct(a, b) { return b > 0 ? (a/b*100).toFixed(0)+"%" : "--"; }

function run() {
  var days = Math.min(parseInt(document.getElementById("i-days").value) || 5, 7);
  var tol  = parseFloat(document.getElementById("i-tol").value) || 0.3;
  var anc  = parseInt(document.getElementById("i-anc").value) || 9;
  var ratio = parseFloat(document.getElementById("i-rat").value) || 60;

  document.getElementById("btn").disabled = true;
  document.getElementById("results").style.display = "none";
  setMsg("Fetching Open-Meteo...", "#006618");

  var url = "https://api.open-meteo.com/v1/forecast"
    + "?latitude=51.5048&longitude=0.0495"
    + "&minutely_15=temperature_2m&hourly=temperature_2m"
    + "&temperature_unit=celsius&timezone=UTC"
    + "&past_days=" + (days + 1) + "&forecast_days=0";

  fetch(url)
    .then(function(r) {
      if (!r.ok) throw new Error("HTTP " + r.status);
      return r.json();
    })
    .then(function(d) {
      setMsg("Parsing data...");

      var m15t = (d.minutely_15 && d.minutely_15.time) || [];
      var m15v = (d.minutely_15 && d.minutely_15.temperature_2m) || [];
      var ht   = (d.hourly && d.hourly.time) || [];
      var hv   = (d.hourly && d.hourly.temperature_2m) || [];

      if (m15t.length === 0) throw new Error("No 15min data returned (rows=0)");

      // Build arrays
      var m15 = [], hr = [];
      for (var i = 0; i < m15t.length; i++) {
        if (m15v[i] == null) continue;
        m15.push({ t: parseT(m15t[i]), v: m15v[i] });
      }
      for (var i = 0; i < ht.length; i++) {
        if (hv[i] == null) continue;
        hr.push({ t: parseT(ht[i]), v: hv[i] });
      }

      // Check parsing worked
      if (isNaN(m15[0].t.getTime())) throw new Error("Date parse failed: " + m15t[0]);

      setMsg("Analysing " + days + " days...");

      var now = new Date();
      var dates = [];
      for (var i = days; i >= 1; i--) {
        dates.push(new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate() - i)));
      }

      var results = [];
      var hits = {};
      ANGLES.forEach(function(deg) { hits[deg] = {hi:0, lo:0, n:0}; });

      dates.forEach(function(date) {
        var ds = date.toISOString().slice(0, 10);
        var ancTime = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), anc));
        var dayEnd  = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), 23, 59));

        var ae = null;
        for (var i = 0; i < hr.length; i++) {
          if (Math.abs(hr[i].t - ancTime) < 1800000) { ae = hr[i]; break; }
        }
        if (!ae) return;
        var aT = ae.v;

        var mins = m15.filter(function(m) { return m.t >= ancTime && m.t <= dayEnd; });
        if (mins.length < 4) return;

        var dHi = -Infinity, dLo = Infinity, hiE = null, loE = null;
        mins.forEach(function(m) {
          if (m.v > dHi) { dHi = m.v; hiE = m; }
          if (m.v < dLo) { dLo = m.v; loE = m; }
        });

        var bHiD = Infinity, bHiDeg = null, bLoD = Infinity, bLoDeg = null;
        ANGLES.forEach(function(deg) {
          if (hiE) {
            var hrs = (hiE.t - ancTime) / 3600000;
            [fan(aT, hrs, deg, 1), fan(aT, hrs, deg, ratio)].forEach(function(v) {
              var dist = Math.abs(dHi - v);
              if (dist < bHiD) { bHiD = dist; bHiDeg = deg; }
              if (dist <= tol) hits[deg].hi++;
            });
          }
          if (loE) {
            var hrs = (loE.t - ancTime) / 3600000;
            [fan(aT, hrs, deg, 1), fan(aT, hrs, deg, ratio)].forEach(function(v) {
              var dist = Math.abs(dLo - v);
              if (dist < bLoD) { bLoD = dist; bLoDeg = deg; }
              if (dist <= tol) hits[deg].lo++;
            });
          }
          hits[deg].n++;
        });

        results.push({ ds:ds, aT:aT, dHi:dHi, dLo:dLo,
          hiHit:bHiD<=tol, loHit:bLoD<=tol,
          bHiD:bHiD, bHiDeg:bHiDeg, bLoD:bLoD, bLoDeg:bLoDeg,
          hiT:hiE?hiE.t:null, loT:loE?loE.t:null });
      });

      render(results, hits);
      document.getElementById("btn").disabled = false;
    })
    .catch(function(e) {
      setMsg("ERROR: " + e.message, "#ff4444");
      document.getElementById("btn").disabled = false;
    });
}

function render(results, hits) {
  if (!results.length) { setMsg("No data for selected days", "#ff4444"); return; }
  var n = results.length;
  var hi = results.filter(function(r){return r.hiHit;}).length;
  var lo = results.filter(function(r){return r.loHit;}).length;
  var bo = results.filter(function(r){return r.hiHit&&r.loHit;}).length;

  document.getElementById("s-n").textContent  = n;
  document.getElementById("s-hi").textContent = pct(hi,n);
  document.getElementById("s-lo").textContent = pct(lo,n);
  document.getElementById("s-bo").textContent = pct(bo,n);
  document.getElementById("s-hd").textContent = (results.reduce(function(a,r){return a+r.bHiD;},0)/n).toFixed(2)+"C";
  document.getElementById("s-ld").textContent = (results.reduce(function(a,r){return a+r.bLoD;},0)/n).toFixed(2)+"C";

  var tb = document.getElementById("ltbl"); tb.innerHTML = "";
  ANGLES.slice().sort(function(a,b){return(hits[b].hi+hits[b].lo)-(hits[a].hi+hits[a].lo);}).forEach(function(deg){
    var h=hits[deg],tot=h.hi+h.lo,rate=h.n>0?(tot/(h.n*2)*100).toFixed(0)+"%":"--";
    var tr=document.createElement("tr");
    tr.innerHTML="<td>"+(deg>0?"L+":"L")+deg+"</td><td class='"+(h.hi?"hi":"dim")+"'>"+h.hi+"</td><td class='"+(h.lo?"lo":"dim")+"'>"+h.lo+"</td><td>"+tot+"</td><td>"+rate+"</td>";
    tb.appendChild(tr);
  });

  var dl=document.getElementById("dlog"); dl.innerHTML="";
  results.slice().reverse().forEach(function(r){
    var ht=r.hiT?r.hiT.toUTCString().slice(17,22)+"UTC":"--";
    var lt=r.loT?r.loT.toUTCString().slice(17,22)+"UTC":"--";
    var div=document.createElement("div"); div.className="drow";
    div.innerHTML="<div class='ddate'>"+r.ds+" -- ANCHOR "+r.aT.toFixed(1)+"C</div>"
      +"<div class='dline'>HIGH "+r.dHi.toFixed(1)+"C @ "+ht+" <span class='"+(r.hiHit?"ok":"no")+"'>"+(r.hiHit?"HIT":"MISS")+" ("+r.bHiD.toFixed(2)+"C)</span></div>"
      +"<div class='dline'>LOW  "+r.dLo.toFixed(1)+"C @ "+lt+" <span class='"+(r.loHit?"ok":"no")+"'>"+(r.loHit?"HIT":"MISS")+" ("+r.bLoD.toFixed(2)+"C)</span></div>";
    dl.appendChild(div);
  });

  document.getElementById("results").style.display = "block";
  setMsg("DONE -- " + n + " days", "#00cc33");
}
</script>

</body>
</html>