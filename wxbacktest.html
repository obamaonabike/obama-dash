<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>WX Backtest</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#050f05;color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:11px;min-height:100dvh;-webkit-text-size-adjust:100%}
.bar{display:flex;align-items:center;justify-content:space-between;padding:0 10px;height:24px;background:#070d07;font-size:10px;letter-spacing:2px;text-transform:uppercase;border-bottom:1px solid #0f2a0f}
.bar.bot{border-top:1px solid #0f2a0f;border-bottom:none;padding-bottom:env(safe-area-inset-bottom)}
a{color:#004a14;font-size:9px;letter-spacing:2px;text-decoration:none;margin-left:8px}
.content{padding:10px;overflow-y:auto}
.row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.lbl{font-size:9px;color:#006618;letter-spacing:1px;min-width:160px}
input{background:#030803;border:1px solid #0f2a0f;color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:10px;padding:4px 6px;width:90px}
button{background:#030803;border:1px solid #00cc33;color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:10px;letter-spacing:2px;padding:7px 20px;cursor:pointer;margin-top:8px;-webkit-appearance:none}
button:disabled{border-color:#0f2a0f;color:#006618}
#msg{font-size:9px;margin:6px 0;min-height:14px;letter-spacing:1px;word-break:break-all}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin:10px 0}
.card{background:#070d07;border:1px solid #0f2a0f;padding:8px}
.clbl{font-size:8px;color:#006618;letter-spacing:2px;margin-bottom:4px}
.cval{font-size:16px;letter-spacing:1px}
.csub{font-size:8px;color:#004a14;margin-top:2px}
.sec{font-size:9px;color:#006618;letter-spacing:3px;padding:8px 0 4px;border-bottom:1px solid #0f2a0f;margin-bottom:6px}
.note{font-size:8px;color:#004a14;margin-bottom:8px;line-height:1.6;letter-spacing:.3px}
table{width:100%;border-collapse:collapse;margin-bottom:12px;font-size:9px}
th{color:#004a14;padding:5px 4px;border-bottom:1px solid #0f2a0f;text-align:left;font-size:8px;letter-spacing:1px}
td{padding:4px;border-bottom:1px solid #0a1a0a}
.hi{color:#00ff41}.lo{color:#ff4444}.dim{color:#006618}.ok{color:#00cc33}.no{color:#444}
</style>
</head>
<body>
<div class="bar">
  <span style="letter-spacing:4px;color:#00cc33">WX BACKTEST</span>
  <div><a href="index.html">BTC</a><a href="backtest.html">BT</a><a href="weather.html">WX</a></div>
</div>
<div class="content">
  <div class="sec">// CONFIG</div>
  <div class="row"><span class="lbl">START DATE</span><input id="i-s" type="date" value="2025-10-01"></div>
  <div class="row"><span class="lbl">END DATE</span><input id="i-e" type="date" value="2026-02-20"></div>
  <div class="row"><span class="lbl">ANCHOR HOUR UTC</span><input id="i-anc" type="number" value="9" min="0" max="23"></div>
  <div class="row"><span class="lbl">PREDICT HI AT HOUR</span><input id="i-phi" type="number" value="14" min="0" max="23"></div>
  <div class="row"><span class="lbl">HTF RATIO</span><input id="i-rat" type="number" value="60" step="1" min="1"></div>
  <button id="btn" onclick="run()">RUN BACKTEST</button>
  <div id="msg" style="color:#006618">SOURCE: OPEN-METEO ARCHIVE (FREE, BACK TO 1940)</div>
  <div id="results" style="display:none">
    <div class="sec">// SUMMARY</div>
    <div class="note">Each fan angle projects a HIGH prediction at the configured hour. CORRECT = predicted integer bracket matches actual daily max. AVG HI TIME = when daily max actually occurs (UTC hr).</div>
    <div class="grid">
      <div class="card"><div class="clbl">DAYS TESTED</div><div class="cval" id="s-n">-</div></div>
      <div class="card"><div class="clbl">BEST ANGLE</div><div class="cval hi" id="s-ba">-</div><div class="csub">ANGLE / ACC</div></div>
      <div class="card"><div class="clbl">WITHIN 1C</div><div class="cval" id="s-w1">-</div><div class="csub">NEAREST LEVEL</div></div>
      <div class="card"><div class="clbl">AVG ERR</div><div class="cval" id="s-avg">-</div><div class="csub">NEAREST FAN</div></div>
      <div class="card"><div class="clbl">AVG HI HOUR</div><div class="cval" id="s-ht">-</div><div class="csub">UTC</div></div>
      <div class="card"><div class="clbl">DUAL BRACKET</div><div class="cval" id="s-db">-</div><div class="csub">FLOOR+CEIL</div></div>
    </div>
    <div class="sec">// ANGLE ACCURACY</div>
    <table>
      <thead><tr><th>ANGLE</th><th>CORRECT</th><th>ACC</th><th>WITHIN 1C</th><th>AVG ERR</th></tr></thead>
      <tbody id="atbl"></tbody>
    </table>
    <div class="sec">// MONTHLY BREAKDOWN</div>
    <table>
      <thead><tr><th>MONTH</th><th>DAYS</th><th>BEST ACC</th><th>AVG ERR</th><th>WITHIN 1C</th></tr></thead>
      <tbody id="mtbl"></tbody>
    </table>
    <div class="sec">// DAY LOG (MOST RECENT 30)</div>
    <table>
      <thead><tr><th>DATE</th><th>ANC</th><th>HI</th><th>ANGLE</th><th>PRED</th><th>ERR</th><th>OK</th></tr></thead>
      <tbody id="dtbl"></tbody>
    </table>
  </div>
</div>
<div class="bar bot"><span id="bst">READY</span></div>

<script type="text/javascript">
var ANGLES = [27,-27,45,-45,60,-60,72,-72,78,-78];

function pt(s) {
  if (!s) return new Date(NaN);
  if (s.length > 16) return new Date(s);
  return new Date(s + ":00Z");
}
function fan(aT, hrs, deg, ratio) {
  return aT + hrs * ratio * Math.tan(deg * Math.PI / 180);
}
function setMsg(s, col) {
  document.getElementById("msg").textContent = s;
  document.getElementById("msg").style.color = col || "#006618";
  document.getElementById("bst").textContent = s;
}
function pct(a,b){ return b>0?(a/b*100).toFixed(0)+"%":"--"; }

function run() {
  var start = document.getElementById("i-s").value;
  var end   = document.getElementById("i-e").value;
  var anc   = parseInt(document.getElementById("i-anc").value)||9;
  var phi   = parseInt(document.getElementById("i-phi").value)||14;
  var ratio = parseFloat(document.getElementById("i-rat").value)||60;

  if (!start || !end) { setMsg("Set start and end dates","#ff4444"); return; }

  document.getElementById("btn").disabled = true;
  document.getElementById("results").style.display = "none";
  setMsg("Fetching archive data from Open-Meteo...");

  // Archive API: hourly temps + daily max going back years
  var url = "https://archive-api.open-meteo.com/v1/archive"
    + "?latitude=51.5048&longitude=0.0495"
    + "&hourly=temperature_2m"
    + "&daily=temperature_2m_max"
    + "&temperature_unit=celsius&timezone=UTC"
    + "&start_date=" + start
    + "&end_date=" + end;

  fetch(url)
    .then(function(r){ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
    .then(function(d){
      setMsg("Analysing...");

      var ht  = (d.hourly && d.hourly.time) || [];
      var hv  = (d.hourly && d.hourly.temperature_2m) || [];
      var dt  = (d.daily  && d.daily.time) || [];
      var dv  = (d.daily  && d.daily.temperature_2m_max) || [];

      if (!ht.length) throw new Error("No hourly data returned");
      if (isNaN(pt(ht[0]).getTime())) throw new Error("Date parse failed: " + ht[0]);

      // Build hourly lookup
      var hr = [];
      for (var i=0; i<ht.length; i++) {
        if (hv[i]==null) continue;
        hr.push({ t: pt(ht[i]), v: hv[i] });
      }

      // Build daily max lookup
      var daily = {};
      for (var i=0; i<dt.length; i++) {
        if (dv[i]==null) continue;
        daily[dt[i]] = dv[i]; // key = "YYYY-MM-DD"
      }

      setMsg("Running " + dt.length + " days...");

      var results = [];
      var angData = {};
      ANGLES.forEach(function(a){ angData[a]={correct:0,w1:0,total:0,errSum:0}; });
      var monthly = {};

      dt.forEach(function(ds) {
        var actualHi = daily[ds];
        if (actualHi == null) return;

        // Parse date parts safely
        var parts = ds.split("-");
        var yr=parseInt(parts[0]),mo=parseInt(parts[1])-1,dy=parseInt(parts[2]);
        var ancTime = new Date(Date.UTC(yr,mo,dy,anc));
        var phiHrs  = phi - anc; if (phiHrs<=0) phiHrs+=24;

        // Anchor temp from hourly
        var ae = null;
        for (var i=0; i<hr.length; i++) {
          if (Math.abs(hr[i].t - ancTime) < 1800000) { ae=hr[i]; break; }
        }
        if (!ae) return;
        var aT = ae.v;

        var bestErr=Infinity, bestAngle=null, bestPred=null;

        ANGLES.forEach(function(deg){
          var p1 = fan(aT, phiHrs, deg, 1);
          var p2 = fan(aT, phiHrs/ratio, deg, ratio);
          var e1 = Math.abs(actualHi-p1), e2 = Math.abs(actualHi-p2);
          var pred = e1<e2?p1:p2;
          var err  = Math.min(e1,e2);

          var correct = Math.round(pred)===Math.round(actualHi);
          var w1 = err<=1.0;
          angData[deg].total++;
          angData[deg].errSum+=err;
          if(correct) angData[deg].correct++;
          if(w1) angData[deg].w1++;

          if(err<bestErr){bestErr=err;bestAngle=deg;bestPred=pred;}
        });

        // Monthly tracking
        var mkey = ds.slice(0,7);
        if (!monthly[mkey]) monthly[mkey]={n:0,correct:0,w1:0,errSum:0};
        var mc=Math.round(bestPred)===Math.round(actualHi);
        monthly[mkey].n++;
        monthly[mkey].errSum+=bestErr;
        if(mc) monthly[mkey].correct++;
        if(bestErr<=1.0) monthly[mkey].w1++;

        results.push({ ds:ds, aT:aT, actualHi:actualHi, bestErr:bestErr, bestAngle:bestAngle, bestPred:bestPred });
      });

      render(results, angData, monthly, anc, phi);
      document.getElementById("btn").disabled=false;
    })
    .catch(function(e){
      setMsg("ERROR: "+e.message,"#ff4444");
      document.getElementById("btn").disabled=false;
    });
}

function render(results, angData, monthly, anc, phi) {
  if (!results.length) { setMsg("No results","#ff4444"); return; }
  var n = results.length;

  // Best angle overall
  var bestAcc=0, bestAngle=null;
  ANGLES.forEach(function(a){
    var acc = angData[a].total?angData[a].correct/angData[a].total:0;
    if(acc>bestAcc){bestAcc=acc;bestAngle=a;}
  });

  var w1   = results.filter(function(r){return r.bestErr<=1.0;}).length;
  var avgE = results.reduce(function(a,r){return a+r.bestErr;},0)/n;

  // Dual bracket (floor+ceil of prediction)
  var dualHit = results.filter(function(r){
    var lo=Math.floor(r.bestPred), hi2=lo+1, act=Math.round(r.actualHi);
    return act===lo||act===hi2;
  }).length;

  document.getElementById("s-n").textContent   = n;
  document.getElementById("s-ba").textContent  = (bestAngle>0?"+":"")+bestAngle+" / "+pct(angData[bestAngle].correct,n);
  document.getElementById("s-w1").textContent  = pct(w1,n);
  document.getElementById("s-avg").textContent = avgE.toFixed(2)+"C";
  document.getElementById("s-ht").textContent  = phi+"H";
  document.getElementById("s-db").textContent  = pct(dualHit,n);

  // Angle table
  var at=document.getElementById("atbl"); at.innerHTML="";
  ANGLES.slice().sort(function(a,b){
    return (angData[b].correct/angData[b].total)-(angData[a].correct/angData[a].total);
  }).forEach(function(deg){
    var ad=angData[deg];
    var acc=ad.total?ad.correct/ad.total:0;
    var tr=document.createElement("tr");
    tr.innerHTML="<td>"+(deg>0?"+":"")+deg+"</td>"
      +"<td class='"+(ad.correct>0?"hi":"dim")+"'>"+ad.correct+"/"+ad.total+"</td>"
      +"<td class='"+(acc>=0.3?"hi":acc>=0.2?"ok":"dim")+"'>"+pct(ad.correct,ad.total)+"</td>"
      +"<td>"+pct(ad.w1,ad.total)+"</td>"
      +"<td class='dim'>"+(ad.total?ad.errSum/ad.total:0).toFixed(2)+"C</td>";
    at.appendChild(tr);
  });

  // Monthly table
  var mt=document.getElementById("mtbl"); mt.innerHTML="";
  Object.keys(monthly).sort().forEach(function(m){
    var mo=monthly[m];
    var tr=document.createElement("tr");
    tr.innerHTML="<td>"+m+"</td>"
      +"<td>"+mo.n+"</td>"
      +"<td class='"+(mo.correct/mo.n>=0.3?"hi":"ok")+"'>"+pct(mo.correct,mo.n)+"</td>"
      +"<td class='dim'>"+(mo.errSum/mo.n).toFixed(2)+"C</td>"
      +"<td>"+pct(mo.w1,mo.n)+"</td>";
    mt.appendChild(tr);
  });

  // Day log (last 30)
  var dt=document.getElementById("dtbl"); dt.innerHTML="";
  results.slice(-30).reverse().forEach(function(r){
    var correct=Math.round(r.bestPred)===Math.round(r.actualHi);
    var tr=document.createElement("tr");
    tr.innerHTML="<td>"+r.ds+"</td>"
      +"<td>"+r.aT.toFixed(1)+"</td>"
      +"<td class='hi'>"+r.actualHi.toFixed(1)+"("+Math.round(r.actualHi)+"C)</td>"
      +"<td class='dim'>"+(r.bestAngle>0?"+":"")+r.bestAngle+"</td>"
      +"<td>"+r.bestPred.toFixed(1)+"("+Math.round(r.bestPred)+"C)</td>"
      +"<td class='"+(r.bestErr<=0.5?"hi":r.bestErr<=1?"ok":"dim")+"'>"+r.bestErr.toFixed(2)+"C</td>"
      +"<td class='"+(correct?"ok":"no")+"'>"+(correct?"Y":"N")+"</td>";
    dt.appendChild(tr);
  });

  document.getElementById("results").style.display="block";
  setMsg("DONE -- "+n+" days | "+start+" to "+end,"#00cc33");
}

var start="", end="";
document.getElementById("i-s").addEventListener("change",function(){start=this.value;});
document.getElementById("i-e").addEventListener("change",function(){end=this.value;});
window.addEventListener("load",function(){
  start=document.getElementById("i-s").value;
  end=document.getElementById("i-e").value;
});
</script>

</body>
</html>