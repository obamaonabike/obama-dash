<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#070d07">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ObamaDash — Backtest</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{
  width:100%;height:100%;
  background:#030803;
  color:#00cc33;
  font-family:'Share Tech Mono',monospace;
  font-size:11px;
  overflow-x:hidden;
}
#app{
  display:flex;flex-direction:column;
  width:100%;height:100%;
  min-height:100dvh;
}
.bar{
  flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 10px;
  background:#070d07;
  color:#006618;
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
}
.bar-top{
  border-bottom:1px solid #0f2a0f;
  padding-top:env(safe-area-inset-top);
  min-height:calc(32px + env(safe-area-inset-top));
  align-items:flex-end;
  padding-bottom:6px;
}
.bar-bottom{
  border-top:1px solid #0f2a0f;
  padding-top:5px;
  padding-bottom:calc(env(safe-area-inset-bottom) + 5px);
  min-height:24px;
  height:auto;
  align-items:flex-start;
}
.bar-title{
  font-family:'Share Tech Mono',monospace;
  font-size:11px;letter-spacing:4px;
  color:#00cc33;
}
.nav-link{
  color:#004a14;font-size:9px;letter-spacing:2px;
  text-decoration:none;margin-left:8px;
}
.content{
  flex:1;overflow-y:auto;
  padding:12px 10px;
}

/* ── CONFIG PANEL ── */
.config-panel{
border:1px solid #0f2a0f;
padding:10px;
margin-bottom:12px;
background:#050f05;
}
.config-title{
color:#00cc33;letter-spacing:3px;font-size:10px;
margin-bottom:10px;border-bottom:1px solid #0f2a0f;padding-bottom:6px;
}
.config-row{
display:flex;align-items:center;justify-content:space-between;
margin-bottom:8px;
}
.config-label{color:#006618;font-size:10px;letter-spacing:1px;}
.config-input{
background:#030803;border:1px solid #0f2a0f;
color:#00cc33;font-family:‘Share Tech Mono’,monospace;
font-size:11px;padding:4px 6px;width:90px;text-align:right;
outline:none;
}
.config-input:focus{border-color:#00cc33;}

/* ── ORDER TYPE BUTTONS ── */
.order-btn{
background:#030803;border:1px solid #0f2a0f;
color:#006618;font-family:‘Share Tech Mono’,monospace;
font-size:9px;letter-spacing:2px;padding:4px 10px;cursor:pointer;
}
.order-btn.active{border-color:#00cc33;color:#00cc33;background:#001a06;}
.lvl-btn{
background:#030803;border:1px solid #0f2a0f;
color:#006618;font-family:‘Share Tech Mono’,monospace;
font-size:9px;letter-spacing:1px;padding:4px 8px;cursor:pointer;
}
.lvl-btn.active{border-color:#ffb300;color:#ffb300;background:#1a0f00;}

/* ── BUTTONS ── */
.run-btn{
width:100%;padding:10px;
background:#003a10;border:1px solid #00cc33;
color:#00cc33;font-family:‘Share Tech Mono’,monospace;
font-size:11px;letter-spacing:3px;cursor:pointer;
text-transform:uppercase;
transition:background 0.15s;
}
.run-btn:active{background:#00cc33;color:#030803;}
.run-btn:disabled{opacity:0.4;cursor:not-allowed;}

/* ── PROGRESS ── */
#progress-wrap{display:none;margin-bottom:12px;}
.progress-bar-bg{
width:100%;height:6px;background:#0f2a0f;
border:1px solid #0f2a0f;margin-top:6px;
}
.progress-bar-fill{
height:100%;background:#00cc33;width:0%;
transition:width 0.1s;
}
#progress-label{color:#006618;font-size:10px;letter-spacing:1px;margin-bottom:4px;}

/* ── RESULTS ── */
#results{display:none;}

.stat-grid{
display:grid;grid-template-columns:1fr 1fr;
gap:6px;margin-bottom:12px;
}
.stat-card{
border:1px solid #0f2a0f;background:#050f05;
padding:8px 10px;
}
.stat-card.full{grid-column:1/-1;}
.stat-label{color:#006618;font-size:9px;letter-spacing:2px;margin-bottom:4px;}
.stat-value{font-size:16px;letter-spacing:1px;color:#00cc33;}
.stat-value.green{color:#00ff41;}
.stat-value.red{color:#ff3131;}
.stat-value.amber{color:#ffb300;}
.stat-sub{color:#004a14;font-size:9px;margin-top:2px;}

/* ── TABLE ── */
.section-title{
color:#00cc33;letter-spacing:3px;font-size:10px;
margin-bottom:8px;margin-top:14px;
border-bottom:1px solid #0f2a0f;padding-bottom:6px;
}
table{width:100%;border-collapse:collapse;margin-bottom:14px;}
th{
color:#006618;font-size:9px;letter-spacing:1px;
text-align:left;padding:4px 6px;
border-bottom:1px solid #0f2a0f;
font-weight:normal;
}
td{
padding:5px 6px;font-size:10px;
border-bottom:1px solid #091409;color:#00aa28;
}
td.green{color:#00ff41;}
td.red{color:#ff3131;}
td.amber{color:#ffb300;}
td.dim{color:#004a14;}

/* ── TRADE LOG ── */
.trade-log-wrap{max-height:300px;overflow-y:auto;border:1px solid #0f2a0f;}
.trade-row{
display:flex;justify-content:space-between;align-items:center;
padding:4px 8px;border-bottom:1px solid #091409;font-size:9px;
}
.trade-row.win{border-left:2px solid #00ff41;}
.trade-row.loss{border-left:2px solid #ff3131;}
.trade-row.fee-loss{border-left:2px solid #ffb300;}

/* fee warning */
.fee-warn{
border:1px solid #ffb300;background:#1a1000;
padding:8px 10px;margin-bottom:12px;
color:#ffb300;font-size:10px;letter-spacing:1px;line-height:1.6;
display:none;
}
</style>

</head>
<body>
<div id="app">

  <div class="bar bar-top">
    <span class="bar-title">BACKTEST</span>
    <a href="index.html" class="nav-link">BTC</a>
    <span id="hdr-status" style="color:#006618;font-size:9px;letter-spacing:1px;">LTF FAN REJECTION</span>
  </div>

  <div class="content">

```
<div class="config-panel">
  <div class="config-title">// CONFIG</div>
  <div class="config-row">
    <span class="config-label">RISK PER TRADE ($)</span>
    <input class="config-input" id="cfg-risk" type="number" value="100" min="1">
  </div>
  <div class="config-row">
    <span class="config-label">REWARD RATIO</span>
    <input class="config-input" id="cfg-rr" type="number" value="0.3" step="0.05" min="0.1">
  </div>
  <div class="config-row">
    <span class="config-label">STOP DISTANCE ($)</span>
    <input class="config-input" id="cfg-stop" type="number" value="150" min="10">
  </div>
  <div class="config-row">
    <span class="config-label">ORDER TYPE</span>
    <div style="display:flex;gap:6px;">
      <button class="order-btn active" id="btn-maker" onclick="selectOrder('maker')">MAKER</button>
      <button class="order-btn" id="btn-taker" onclick="selectOrder('taker')">TAKER</button>
    </div>
  </div>
  <div class="config-row" id="fee-row" style="display:none;">
    <span class="config-label">CUSTOM FEE (%)</span>
    <input class="config-input" id="cfg-fee" type="number" value="0.02" step="0.005" min="0">
  </div>
  <div class="config-row">
    <span class="config-label">TOUCH TOLERANCE (%)</span>
    <input class="config-input" id="cfg-tol" type="number" value="0.08" step="0.01" min="0.01">
  </div>
  <div class="config-row">
    <span class="config-label">DAYS</span>
    <input class="config-input" id="cfg-days" type="number" value="30" min="1" max="60">
  </div>
  <div class="config-title" style="margin-top:10px;">// FAN LEVELS</div>
  <div id="level-toggles" style="display:flex;flex-wrap:wrap;gap:6px;padding-top:4px;">
    <button class="lvl-btn active" data-deg="27"  onclick="this.classList.toggle('active')">+27</button>
    <button class="lvl-btn active" data-deg="-27" onclick="this.classList.toggle('active')">-27</button>
    <button class="lvl-btn active" data-deg="45"  onclick="this.classList.toggle('active')">+45</button>
    <button class="lvl-btn active" data-deg="-45" onclick="this.classList.toggle('active')">-45</button>
    <button class="lvl-btn active" data-deg="60"  onclick="this.classList.toggle('active')">+60</button>
    <button class="lvl-btn active" data-deg="-60" onclick="this.classList.toggle('active')">-60</button>
    <button class="lvl-btn active" data-deg="72"  onclick="this.classList.toggle('active')">+72</button>
    <button class="lvl-btn active" data-deg="-72" onclick="this.classList.toggle('active')">-72</button>
    <button class="lvl-btn active" data-deg="78"  onclick="this.classList.toggle('active')">+78</button>
    <button class="lvl-btn active" data-deg="-78" onclick="this.classList.toggle('active')">-78</button>
  </div>
</div>

<button class="run-btn" id="run-btn" onclick="runBacktest()">▶ RUN BACKTEST</button>

<div id="progress-wrap">
  <div id="progress-label">FETCHING CANDLES...</div>
  <div class="progress-bar-bg"><div class="progress-bar-fill" id="progress-fill"></div></div>
</div>

<div class="fee-warn" id="fee-warn"></div>

<div id="results">

  <div class="stat-grid" id="stat-grid"></div>

  <div class="section-title">// BY LEVEL</div>
  <table id="level-table">
    <thead><tr>
      <th>LEVEL</th><th>TRADES</th><th>WIN%</th><th>NET PNL</th><th>AVG R</th>
    </tr></thead>
    <tbody id="level-tbody"></tbody>
  </table>

  <div class="section-title">// BY SESSION HOUR (UTC)</div>
  <table id="hour-table">
    <thead><tr>
      <th>HOUR</th><th>TRADES</th><th>WIN%</th><th>NET PNL</th>
    </tr></thead>
    <tbody id="hour-tbody"></tbody>
  </table>

  <div class="section-title">// TRADE LOG <span style="color:#004a14;font-size:9px">(LAST 100)</span></div>
  <div class="trade-log-wrap" id="trade-log"></div>

</div>
```

  </div>

  <div class="bar bar-bottom">
    <span id="bar-status">READY</span>
    <span id="bar-time">—</span>
  </div>
</div>

<script>
// ── UI CONTROLS ───────────────────────────────────────
let orderType = 'maker'; // maker=0.02%, taker=0.05%
const MAKER_FEE = 0.02;
const TAKER_FEE = 0.05;

function selectOrder(type){
  orderType = type;
  document.getElementById('btn-maker').classList.toggle('active', type==='maker');
  document.getElementById('btn-taker').classList.toggle('active', type==='taker');
  // Show custom fee row only if neither standard
  document.getElementById('cfg-fee').value = type==='maker' ? MAKER_FEE : TAKER_FEE;
}

function getActiveLevels(){
  const btns = document.querySelectorAll('.lvl-btn');
  btns.forEach(b=>{
    b.onclick = ()=>{ b.classList.toggle('active'); };
  });
  return Array.from(btns)
    .filter(b=>b.classList.contains('active'))
    .map(b=>parseInt(b.dataset.deg));
}

// ── CONSTANTS ─────────────────────────────────────────
const SYMBOL = 'BTCUSDT';
const ANGLES  = [27, -27, 45, -45, 60, -60, 72, -72, 78, -78];
const HTF_RATIO = 73.3458;

// ── MATH (identical to dashboard) ─────────────────────
function anglePrice(anchor, bars, deg, ratio){
  return anchor + bars * (ratio||1) * Math.tan(deg * Math.PI / 180);
}

// ── ANCHOR HELPERS ────────────────────────────────────
// Returns the 09:00 UTC anchor for a given timestamp
function getAnchor0900(ts){
  const d = new Date(ts);
  const a = new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate(), 9, 0, 0));
  if(a > d) a.setUTCDate(a.getUTCDate() - 1);
  return a;
}

// ── FETCH HELPERS ─────────────────────────────────────
async function fetchKlines(symbol, interval, startTime, endTime, limit=1000){
  const url = `https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}`
    + `&startTime=${startTime}&endTime=${endTime}&limit=${limit}`;
  const r = await fetch(url);
  const d = await r.json();
  return d.map(k=>({
    time: k[0]/1000,
    open: parseFloat(k[1]),
    high: parseFloat(k[2]),
    low:  parseFloat(k[3]),
    close:parseFloat(k[4])
  }));
}

async function fetchAllCandles(days, onProgress){
  const now   = Date.now();
  const start = now - days * 24 * 60 * 60 * 1000;
  let   candles = [];
  let   cur = start;
  const batchMs = 1000 * 60 * 1000; // 1000 minutes per batch

  while(cur < now){
    const end = Math.min(cur + batchMs, now);
    const batch = await fetchKlines(SYMBOL, '1m', cur, end);
    if(!batch.length) break;
    candles = candles.concat(batch);
    cur = batch[batch.length-1].time * 1000 + 60000;
    onProgress(Math.min(99, Math.round((cur - start) / (now - start) * 100)));
    await new Promise(r=>setTimeout(r,80)); // throttle
  }
  return candles;
}

// ── COMPUTE LTF FAN LEVELS AT A GIVEN CANDLE ──────────
// Returns array of {label, price, deg} for each level
function getLevelsAt(candle, anchorSec, anchorOpen, activeLevels){
  const bar = Math.floor((candle.time - anchorSec) / 60);
  const angles = activeLevels || ANGLES;
  const levels = [];
  levels.push({label:'LEQ', price: anchorOpen, deg:0});
  for(const deg of angles){
    const label = deg > 0 ? `L+${deg}` : `L${deg}`;
    levels.push({label, price: anglePrice(anchorOpen, bar, deg, 1), deg});
  }
  return levels;
}

// ── TRADE SIMULATION ──────────────────────────────────
function simulateTrade(candles, entryIdx, dir, entryPrice, stopDist, rrRatio, feeRate){
  const target = entryPrice + dir * stopDist * rrRatio;
  const stop   = entryPrice - dir * stopDist;
  const risk   = stopDist; // in $-per-btc terms, but we use fixed $ risk

  // Walk forward candles until tp/sl hit
  for(let i = entryIdx; i < Math.min(entryIdx + 200, candles.length); i++){
    const c = candles[i];
    if(dir === 1){ // long
      if(c.low  <= stop)  return 'LOSS';
      if(c.high >= target) return 'WIN';
    } else { // short
      if(c.high >= stop)  return 'LOSS';
      if(c.low  <= target) return 'WIN';
    }
  }
  return 'TIMEOUT'; // no result in 200 bars
}

// ── MAIN BACKTEST ──────────────────────────────────────
async function runBacktest(){
  const risk    = parseFloat(document.getElementById('cfg-risk').value);
  const rrRatio = parseFloat(document.getElementById('cfg-rr').value);
  const stopDist= parseFloat(document.getElementById('cfg-stop').value);
  const feeRate = (orderType==='maker'?MAKER_FEE:TAKER_FEE) / 100;
  const tolPct  = parseFloat(document.getElementById('cfg-tol').value) / 100;
  const days    = parseInt(document.getElementById('cfg-days').value);
  const activeLevels = Array.from(document.querySelectorAll('.lvl-btn.active')).map(b=>parseInt(b.dataset.deg));
  if(!activeLevels.length){ alert('SELECT AT LEAST ONE FAN LEVEL'); return; }

  const btn = document.getElementById('run-btn');
  btn.disabled = true;
  document.getElementById('results').style.display = 'none';
  document.getElementById('fee-warn').style.display = 'none';
  document.getElementById('progress-wrap').style.display = 'block';
  setProgress(0, 'FETCHING ' + days + ' DAYS OF M1 CANDLES...');

  let candles;
  try{
    candles = await fetchAllCandles(days, pct=>{
      setProgress(pct * 0.8, `FETCHING... ${pct}%`);
    });
  }catch(e){
    setProgress(0, 'FETCH ERROR — CHECK CONNECTION');
    btn.disabled = false;
    return;
  }

  setProgress(82, `PROCESSING ${candles.length.toLocaleString()} CANDLES...`);
  await new Promise(r=>setTimeout(r,30));

  // ── SIMULATE ──────────────────────────────────────────
  const trades     = [];
  const byLevel    = {};
  const byHour     = {};
  const debounce   = {}; // prevent multiple signals per level per session

  // Pre-fetch anchor opens per day
  // We'll derive them from the candle data directly
  const anchorOpens = {}; // key: "YYYY-MM-DD" => open price of 09:00 candle

  for(const c of candles){
    const anchor = getAnchor0900(c.time * 1000);
    const key    = anchor.toISOString().slice(0,10);
    if(!anchorOpens[key]){
      // Find the 09:00 candle open
      const anchorSec = anchor.getTime() / 1000;
      if(Math.abs(c.time - anchorSec) < 120){ // within 2 min of anchor
        anchorOpens[key] = c.open;
      }
    }
  }

  // Main loop
  for(let i = 2; i < candles.length - 10; i++){
    const c    = candles[i];
    const prev = candles[i-1];

    const anchor    = getAnchor0900(c.time * 1000);
    const anchorKey = anchor.toISOString().slice(0,10);
    const anchorOpen= anchorOpens[anchorKey];
    if(!anchorOpen) continue;

    const anchorSec = anchor.getTime() / 1000;
    const levels    = getLevelsAt(prev, anchorSec, anchorOpen, activeLevels);
    const hour      = new Date(c.time * 1000).getUTCHours();

    for(const lv of levels){
      if(lv.label === 'LEQ') continue; // skip EQ

      const tol     = lv.price * tolPct;
      const debKey  = `${anchorKey}_${lv.label}`;

      // ── LONG signal: prev candle wicked DOWN to level, closed ABOVE it
      const touchedBelow = prev.low <= lv.price + tol && prev.low >= lv.price - tol;
      const rejectedUp   = prev.close > lv.price && prev.open > prev.close - tol;
      if(touchedBelow && rejectedUp && !debounce[debKey]){
        debounce[debKey] = true;
        const entry  = c.open;
        const result = simulateTrade(candles, i+1, 1, entry, stopDist, rrRatio, feeRate);
        if(result !== 'TIMEOUT'){
          // Fee calc: position size = risk / stopDist, fees = posSize × price × feeRate × 2
          const posSize  = risk / stopDist;
          const feeCost  = posSize * entry * feeRate * 2;
          const grossPnl = result === 'WIN' ? risk * rrRatio : -risk;
          const netPnl   = grossPnl - feeCost;
          trades.push({
            time: c.time, level: lv.label, dir:'LONG',
            entry, result, grossPnl, feeCost, netPnl, hour, stopDist
          });
          if(!byLevel[lv.label]) byLevel[lv.label]={wins:0,losses:0,netPnl:0,trades:0};
          if(!byHour[hour])      byHour[hour]={wins:0,losses:0,netPnl:0,trades:0};
          recordResult(byLevel[lv.label], byHour[hour], result, netPnl);
        }
      }

      // ── SHORT signal: prev candle wicked UP to level, closed BELOW it
      const touchedAbove = prev.high >= lv.price - tol && prev.high <= lv.price + tol;
      const rejectedDown = prev.close < lv.price && prev.open < prev.close + tol;
      if(touchedAbove && rejectedDown && !debounce[debKey + '_S']){
        debounce[debKey + '_S'] = true;
        const entry  = c.open;
        const result = simulateTrade(candles, i+1, -1, entry, stopDist, rrRatio, feeRate);
        if(result !== 'TIMEOUT'){
          const posSize  = risk / stopDist;
          const feeCost  = posSize * entry * feeRate * 2;
          const grossPnl = result === 'WIN' ? risk * rrRatio : -risk;
          const netPnl   = grossPnl - feeCost;
          trades.push({
            time: c.time, level: lv.label, dir:'SHORT',
            entry, result, grossPnl, feeCost, netPnl, hour, stopDist
          });
          if(!byLevel[lv.label]) byLevel[lv.label]={wins:0,losses:0,netPnl:0,trades:0};
          if(!byHour[hour])      byHour[hour]={wins:0,losses:0,netPnl:0,trades:0};
          recordResult(byLevel[lv.label], byHour[hour], result, netPnl);
        }
      }
    }
  }

  setProgress(100, 'DONE');
  await new Promise(r=>setTimeout(r,200));
  document.getElementById('progress-wrap').style.display = 'none';

  renderResults(trades, byLevel, byHour, risk, 0.3, feeRate);
  btn.disabled = false;
}

function recordResult(lv, hr, result, netPnl){
  const win = result === 'WIN';
  lv.trades++; hr.trades++;
  if(win){ lv.wins++; hr.wins++; }
  else   { lv.losses++; hr.losses++; }
  lv.netPnl += netPnl;
  hr.netPnl += netPnl;
}

// ── RENDER ─────────────────────────────────────────────
function renderResults(trades, byLevel, byHour, risk, rrRatio, feeRate){
  const totalTrades = trades.length;
  if(!totalTrades){
    document.getElementById('stat-grid').innerHTML =
      '<div class="stat-card full"><div class="stat-label">RESULT</div><div class="stat-value amber">NO SIGNALS FOUND — TRY WIDER TOLERANCE</div></div>';
    document.getElementById('results').style.display = 'block';
    return;
  }

  const wins      = trades.filter(t=>t.result==='WIN').length;
  const winRate   = wins / totalTrades * 100;
  const totalNet  = trades.reduce((s,t)=>s+t.netPnl, 0);
  const totalGross= trades.reduce((s,t)=>s+t.grossPnl, 0);
  const totalFees = trades.reduce((s,t)=>s+t.feeCost, 0);
  const avgR      = totalNet / (totalTrades * risk);
  const breakEven = (1 / (1 + rrRatio)) * 100;

  // Max drawdown
  let peak = 0, trough = 0, maxDD = 0, runningPnl = 0;
  for(const t of trades){
    runningPnl += t.netPnl;
    if(runningPnl > peak) peak = runningPnl;
    const dd = peak - runningPnl;
    if(dd > maxDD) maxDD = dd;
  }

  // Max consecutive losses
  let maxConsecLoss = 0, consecLoss = 0;
  let maxConsecWin  = 0, consecWin  = 0;
  for(const t of trades){
    if(t.result === 'LOSS'){ consecLoss++; consecWin=0; }
    else                   { consecWin++;  consecLoss=0; }
    if(consecLoss > maxConsecLoss) maxConsecLoss = consecLoss;
    if(consecWin  > maxConsecWin)  maxConsecWin  = consecWin;
  }

  // Profit factor
  const grossWins   = trades.filter(t=>t.result==='WIN').reduce((s,t)=>s+t.grossPnl,0);
  const grossLosses = Math.abs(trades.filter(t=>t.result==='LOSS').reduce((s,t)=>s+t.grossPnl,0));
  const profitFactor= grossLosses ? (grossWins/grossLosses).toFixed(2) : '∞';

  // Fee warning
  if(totalFees > Math.abs(totalGross) * 0.3){
    const fw = document.getElementById('fee-warn');
    fw.style.display = 'block';
    fw.textContent = `⚠ FEES ($${totalFees.toFixed(0)}) = ${(totalFees/Math.abs(totalGross)*100).toFixed(0)}% OF GROSS PNL — CONSIDER MAKER ORDERS OR REDUCING POSITION SIZE`;
  }

  // Stat cards
  const sg = document.getElementById('stat-grid');
  sg.innerHTML = `
    ${statCard('WIN RATE', winRate.toFixed(1)+'%', winRate>=85?'green':winRate>=breakEven?'amber':'red',
        `BREAK-EVEN: ${breakEven.toFixed(1)}% &nbsp;|&nbsp; TARGET: 85.0%`)}
    ${statCard('TOTAL TRADES', totalTrades, '', `WINS: ${wins} &nbsp;/&nbsp; LOSSES: ${totalTrades-wins}`)}
    ${statCard('NET PNL', '$'+totalNet.toFixed(2), totalNet>0?'green':'red',
        `GROSS: $${totalGross.toFixed(2)}`)}
    ${statCard('TOTAL FEES', '$'+totalFees.toFixed(2), 'amber',
        `${(totalFees/Math.abs(totalGross||1)*100).toFixed(0)}% OF GROSS &nbsp;|&nbsp; ${orderType.toUpperCase()}`)}
    ${statCard('AVG R/TRADE', avgR.toFixed(3)+'R', avgR>0?'green':'red',
        `RISK: $${risk} &nbsp;|&nbsp; RR: ${rrRatio}:1`)}
    ${statCard('DAILY EDGE', '$'+(totalNet/30).toFixed(2)+'/day', totalNet>0?'green':'red',
        `TRADES/DAY: ${(totalTrades/30).toFixed(1)}`)}
    ${statCard('MAX DRAWDOWN', '$'+maxDD.toFixed(2), 'red',
        `${peak>0?(maxDD/peak*100).toFixed(1):0}% OF PEAK EQUITY`)}
    ${statCard('MAX CONSEC LOSS', maxConsecLoss, maxConsecLoss<=3?'green':maxConsecLoss<=6?'amber':'red',
        `MAX CONSEC WIN: ${maxConsecWin}`)}
    ${statCard('PROFIT FACTOR', profitFactor, parseFloat(profitFactor)>=2?'green':parseFloat(profitFactor)>=1.5?'amber':'red',
        `GROSS WINS: $${grossWins.toFixed(0)} / LOSSES: $${grossLosses.toFixed(0)}`)}
  `;

  // By level table
  const lb = document.getElementById('level-tbody');
  lb.innerHTML = '';
  const levelEntries = Object.entries(byLevel).sort((a,b)=>b[1].netPnl-a[1].netPnl);
  for(const [label, d] of levelEntries){
    const wr  = d.trades ? (d.wins/d.trades*100).toFixed(1) : '—';
    const avgr= d.trades ? (d.netPnl/(d.trades*risk)).toFixed(3) : '—';
    const wrClass = parseFloat(wr)>=85?'green':parseFloat(wr)>=breakEven?'':'red';
    const pnlClass= d.netPnl>0?'green':'red';
    lb.innerHTML += `<tr>
      <td class="amber">${label}</td>
      <td>${d.trades}</td>
      <td class="${wrClass}">${wr}%</td>
      <td class="${pnlClass}">$${d.netPnl.toFixed(0)}</td>
      <td class="${pnlClass}">${avgr}R</td>
    </tr>`;
  }

  // By hour table
  const hb = document.getElementById('hour-tbody');
  hb.innerHTML = '';
  const hourEntries = Object.entries(byHour).sort((a,b)=>b[1].netPnl-a[1].netPnl);
  for(const [hr, d] of hourEntries){
    const wr = d.trades ? (d.wins/d.trades*100).toFixed(1) : '—';
    const wrClass = parseFloat(wr)>=85?'green':parseFloat(wr)>=breakEven?'':'red';
    const pnlClass= d.netPnl>0?'green':'red';
    hb.innerHTML += `<tr>
      <td class="amber">${String(hr).padStart(2,'0')}:00 UTC</td>
      <td>${d.trades}</td>
      <td class="${wrClass}">${wr}%</td>
      <td class="${pnlClass}">$${d.netPnl.toFixed(0)}</td>
    </tr>`;
  }

  // Trade log (last 100 reversed)
  const tl = document.getElementById('trade-log');
  tl.innerHTML = '';
  const recent = [...trades].slice(-100).reverse();
  for(const t of recent){
    const dt    = new Date(t.time*1000).toUTCString().slice(5,17).toUpperCase();
    const cls   = t.netPnl > 0 ? 'win' : 'loss';
    const pnlTxt= (t.netPnl>0?'+':'') + '$'+t.netPnl.toFixed(2);
    const pnlCls= t.netPnl>0?'green':'red';
    tl.innerHTML += `<div class="trade-row ${cls}">
      <span style="color:#006618">${dt}</span>
      <span class="amber">${t.level}</span>
      <span style="color:#00aa28">${t.dir}</span>
      <span class="${pnlCls}">${pnlTxt}</span>
      <span style="color:#004a14">fee:$${t.feeCost.toFixed(2)}</span>
    </div>`;
  }

  document.getElementById('results').style.display = 'block';
  document.getElementById('bar-status').textContent = `${totalTrades} TRADES SIMULATED`;
  document.getElementById('bar-time').textContent = new Date().toUTCString().slice(5,22).toUpperCase()+' UTC';

  // Scroll to results
  document.getElementById('results').scrollIntoView({behavior:'smooth'});
}

function statCard(label, value, cls, sub=''){
  return `<div class="stat-card">
    <div class="stat-label">${label}</div>
    <div class="stat-value ${cls}">${value}</div>
    ${sub?`<div class="stat-sub">${sub}</div>`:''}
  </div>`;
}

function setProgress(pct, label){
  document.getElementById('progress-fill').style.width = pct+'%';
  document.getElementById('progress-label').textContent = label;
}
</script>

</body>
</html>