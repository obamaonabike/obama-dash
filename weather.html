<!DOCTYPE html>

<html lang="en" style="background:#050f05">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#070d07">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>ObamaDash - London Temp</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html { background:#050f05; height:100%; height:-webkit-fill-available; }
body { width:100%; height:100%; height:-webkit-fill-available; min-height:100dvh; overflow:hidden; background:#050f05; color:#00cc33; font-family:"Share Tech Mono",monospace; font-size:11px; letter-spacing:0.5px; cursor:crosshair; -webkit-text-size-adjust:100%; }
#app { display:flex; flex-direction:column; width:100%; height:100%; min-height:100dvh; background:#050f05; overflow:hidden; touch-action:none; }
.bar { flex-shrink:0; display:flex; align-items:center; justify-content:space-between; padding:0 10px; height:24px; background:#070d07; color:#006618; font-size:10px; letter-spacing:2px; text-transform:uppercase; }
.bar-top { border-bottom:1px solid #0f2a0f; padding-top:env(safe-area-inset-top); height:calc(24px + env(safe-area-inset-top)); }
.bar-bottom { border-top:1px solid #0f2a0f; padding-top:5px; padding-bottom:calc(env(safe-area-inset-bottom)+5px); height:auto; min-height:24px; align-items:flex-start; }
.bar-title { font-size:11px; letter-spacing:4px; color:#00cc33; white-space:nowrap; }
.nav-link { color:#004a14; font-family:"Share Tech Mono",monospace; font-size:9px; letter-spacing:2px; text-decoration:none; margin-left:8px; }
.price-display { color:#00cc33; font-size:11px; letter-spacing:1px; }
.status-dot { width:5px; height:5px; border-radius:50%; background:#00cc33; flex-shrink:0; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.2} }
.chart-controls { flex-shrink:0; display:flex; align-items:stretch; height:22px; background:#070d07; border-bottom:1px solid #0f2a0f; }
.tf-btn { background:#070d07; border:none; border-right:1px solid #0f2a0f; color:#003a10; font-family:"Share Tech Mono",monospace; font-size:10px; letter-spacing:2px; text-transform:uppercase; padding:0 12px; cursor:pointer; }
.tf-btn.active { color:#00cc33; background:#0a160a; border-bottom:1px solid #00cc33; }
.chart-shell { flex:1; min-height:0; display:flex; flex-direction:column; background:#050f05; }
.chart-body { flex:1; position:relative; min-height:0; overflow:hidden; background:#050f05; touch-action:none; }
#chart-container { width:100%; height:100%; background:#050f05; }
#err-box { display:none; position:absolute; top:10px; left:10px; right:10px; background:#1a0000; border:1px solid #cc0000; color:#ff4444; font-size:9px; padding:8px; letter-spacing:1px; z-index:99; word-break:break-all; }
</style>
</head>
<body>
<div id="app">
  <div class="bar bar-top">
    <span class="bar-title">WX LONDON</span>
    <div>
      <a href="index.html" class="nav-link">BTC</a>
      <a href="backtest.html" class="nav-link">BT</a>
      <a href="forwardtest.html" class="nav-link">FT</a>
      <a href="wxbacktest.html" class="nav-link">WXB</a>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <span class="price-display" id="hdr-temp">--</span>
      <div class="status-dot"></div>
    </div>
  </div>
  <div class="chart-controls">
    <button class="tf-btn active" id="btn-ltf-ratio" onclick="switchMode('LTF_RATIO')">M1 RATIO</button>
    <button class="tf-btn"        id="btn-ltf-both"  onclick="switchMode('LTF_BOTH')">M1 BOTH</button>
    <button class="tf-btn"        id="btn-htf"       onclick="switchMode('HTF')">HTF</button>
  </div>
  <div class="chart-shell">
    <div class="chart-body">
      <div id="chart-container"></div>
      <div id="err-box"></div>
    </div>
  </div>
  <div class="bar bar-bottom">
    <span id="bar-status">LOADING...</span>
    <span id="bar-time" style="font-size:9px;letter-spacing:1px;color:#004a14"></span>
  </div>
</div>
<script>
var TMR_KEY = "geHqAXyAgDTGlnyKJGK0wJX4RiBrpHeU";
var LAT = 51.5048, LON = 0.0495;
var CFG = { htfRatio: 60, refreshSec: 300 };
var chartMode = "LTF_RATIO";
var lwChart, candleSeries, chartLevels = {};
var m1Candles = [], h1Candles = [];
var htfAnchorTs, ltfAnchorTs, htfAnchorOpen, ltfAnchorOpen;

function getMidnightUTC() {
var n = new Date();
return new Date(Date.UTC(n.getUTCFullYear(), n.getUTCMonth(), n.getUTCDate(), 0, 0, 0));
}
function get0900UTC() {
var n = new Date();
var a = new Date(Date.UTC(n.getUTCFullYear(), n.getUTCMonth(), n.getUTCDate(), 9, 0, 0));
if (a > n) a.setUTCDate(a.getUTCDate() - 1);
return a;
}
function anglePrice(anchor, bars, deg, ratio) {
return anchor + bars * (ratio || 1) * Math.tan(deg * Math.PI / 180);
}
function getLevelDefs(type) {
var isRatio = type === “HTF_R”, h = type === “HTF”;
if (isRatio) return [
{label:“EQ”,deg:0,color:”#ffffff”,width:1},
{label:”+27”,deg:27,color:”#ffb300”,width:1},{label:”-27”,deg:-27,color:”#ff00ff”,width:1},
{label:”+45”,deg:45,color:”#ffb300”,width:1},{label:”-45”,deg:-45,color:”#ff00ff”,width:1},
{label:”+60”,deg:60,color:”#ffb300”,width:1},{label:”-60”,deg:-60,color:”#ff00ff”,width:1},
{label:”+72”,deg:72,color:”#ffdd00”,width:1},{label:”-72”,deg:-72,color:”#ffdd00”,width:1},
{label:”+78”,deg:78,color:”#ffdd00”,width:1},{label:”-78”,deg:-78,color:”#ffdd00”,width:1}
];
return [
{label:“EQ”,deg:0,color:h?”#ffffff”:”#aaaaaa”,width:1},
{label:”+27”,deg:27,color:h?”#00ff41”:”#00cc33”,width:1},{label:”-27”,deg:-27,color:h?”#ff3131”:”#cc2222”,width:1},
{label:”+45”,deg:45,color:h?”#00ff41”:”#00cc33”,width:1},{label:”-45”,deg:-45,color:h?”#ff3131”:”#cc2222”,width:1},
{label:”+60”,deg:60,color:h?”#00ff41”:”#00cc33”,width:1},{label:”-60”,deg:-60,color:h?”#ff3131”:”#cc2222”,width:1},
{label:”+72”,deg:72,color:h?”#ffb300”:”#dd9900”,width:1},{label:”-72”,deg:-72,color:h?”#ffb300”:”#dd9900”,width:1},
{label:”+78”,deg:78,color:h?”#ffb300”:”#dd9900”,width:1},{label:”-78”,deg:-78,color:h?”#ffb300”:”#dd9900”,width:1}
];
}
function buildChart() {
var container = document.getElementById(“chart-container”);
var body = container.parentElement;
function getH() { return body.getBoundingClientRect().height || window.innerHeight - 70; }
lwChart = LightweightCharts.createChart(container, {
width: container.clientWidth, height: getH(),
layout: { background:{color:”#050f05”}, textColor:”#006618”, fontSize:10 },
grid: { vertLines:{color:”#0c1a0c”,style:0}, horzLines:{color:”#0c1a0c”,style:0} },
crosshair: { mode:LightweightCharts.CrosshairMode.Normal, vertLine:{color:”#00ff4166”,width:1,style:3,labelBackgroundColor:”#051405”}, horzLine:{color:”#00ff4166”,width:1,style:3,labelBackgroundColor:”#051405”} },
rightPriceScale: { borderColor:”#0f2a0f”, textColor:”#006618”, scaleMargins:{top:0.08,bottom:0.08} },
timeScale: { borderColor:”#0f2a0f”, timeVisible:true, secondsVisible:false },
localization: { priceFormatter: function(p) { return p.toFixed(2) + “C”; } }
});
candleSeries = lwChart.addCandlestickSeries({
upColor:”#00ff41”, downColor:”#ff3131”,
borderUpColor:”#00ff41”, borderDownColor:”#ff3131”,
wickUpColor:”#00aa2a”, wickDownColor:”#aa1111”
});
var _rt;
function resize() { clearTimeout(_rt); *rt = setTimeout(function() { lwChart.applyOptions({width:container.clientWidth,height:getH()}); }, 80); }
window.addEventListener(“resize”, resize);
if (window.visualViewport) window.visualViewport.addEventListener(“resize”, resize);
}
function clearLevels() {
Object.values(chartLevels).forEach(function(s) { try { lwChart.removeSeries(s); } catch(e){} });
chartLevels = {};
}
function drawLevelSet(candles, anchorTs, anchorOpen, type, ratio) {
if (!anchorOpen || !candles.length) return;
var defs = getLevelDefs(type);
var anchorSec = anchorTs.getTime() / 1000;
var secPerBar = (type === “HTF” || type === “HTF_R”) ? 3600 : 60;
var filtered = candles.filter(function(c) { return c.time >= anchorSec; });
if (filtered.length < 2) return;
var last = filtered[filtered.length - 1];
var n = new Date();
var endSec = new Date(Date.UTC(n.getUTCFullYear(), n.getUTCMonth(), n.getUTCDate(), 23, 59, 0)).getTime() / 1000;
var future = [];
for (var t = last.time + 60; t <= endSec; t += 60) future.push(t);
defs.forEach(function(def) {
var data = filtered.map(function(c) {
return { time:c.time, value:anglePrice(anchorOpen, Math.floor((c.time-anchorSec)/secPerBar), def.deg, ratio||1) };
});
future.forEach(function(t) {
data.push({ time:t, value:anglePrice(anchorOpen, Math.floor((t-anchorSec)/secPerBar), def.deg, ratio||1) });
});
var prefix = type===“HTF_R”?“R”:type===“HTF”?“H”:“L”;
var s = lwChart.addLineSeries({ color:def.color, lineWidth:def.width, lineStyle:type===“LTF”?2:0, priceLineVisible:false, lastValueVisible:true, title:prefix+def.label, crosshairMarkerVisible:false });
s.setData(data);
chartLevels[type+”*”+def.label] = s;
});
}
function reloadLevels() {
clearLevels();
var c = chartMode === “HTF” ? h1Candles : m1Candles;
if (chartMode === “HTF”) {
drawLevelSet(c,htfAnchorTs,htfAnchorOpen,“HTF”,1);
drawLevelSet(c,htfAnchorTs,htfAnchorOpen,“HTF_R”,CFG.htfRatio);
drawLevelSet(c,ltfAnchorTs,ltfAnchorOpen,“LTF”);
} else if (chartMode === “LTF_RATIO”) {
drawLevelSet(c,htfAnchorTs,htfAnchorOpen,“HTF_R”,CFG.htfRatio);
drawLevelSet(c,ltfAnchorTs,ltfAnchorOpen,“LTF”);
} else {
drawLevelSet(c,htfAnchorTs,htfAnchorOpen,“HTF”,1);
drawLevelSet(c,htfAnchorTs,htfAnchorOpen,“HTF_R”,CFG.htfRatio);
drawLevelSet(c,ltfAnchorTs,ltfAnchorOpen,“LTF”);
}
}

// Open-Meteo: free, no key, reliable
// Returns 15min historical + hourly forecast
function fetchOpenMeteo() {
var today = new Date();
var threeDaysAgo = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()-3));
var tomorrow = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()+2));
var startStr = threeDaysAgo.toISOString().slice(0,10);
var endStr   = tomorrow.toISOString().slice(0,10);
var url = “https://api.open-meteo.com/v1/forecast?latitude=” + LAT + “&longitude=” + LON +
“&minutely_15=temperature_2m&hourly=temperature_2m&temperature_unit=celsius&timezone=UTC” +
“&start_date=” + startStr + “&end_date=” + endStr;
return fetch(url).then(function(r) {
if (!r.ok) throw new Error(“Open-Meteo “ + r.status);
return r.json();
});
}

// Tomorrow.io forecast: minutely next hour (to supplement recent 15min gap)
function fetchTmrForecast() {
var url = “https://api.tomorrow.io/v4/weather/forecast?location=” + LAT + “,” + LON +
“&fields=temperature&timesteps=1m,1h&units=metric&apikey=” + TMR_KEY;
return fetch(url).then(function(r) {
if (!r.ok) throw new Error(“TMR “ + r.status);
return r.json();
});
}

function om15ToM1(d) {
var times = d.minutely_15 && d.minutely_15.time;
var temps = d.minutely_15 && d.minutely_15.temperature_2m;
if (!times || !temps) return [];
var rows = [];
for (var i = 0; i < times.length; i++) {
if (temps[i] === null || temps[i] === undefined) continue;
rows.push({ ts: Math.floor(new Date(times[i] + “:00Z”).getTime()/1000), temp: temps[i] });
}
// Expand each 15min row to 15 x 1min candles
var out = [];
for (var i = 0; i < rows.length; i++) {
var o = i === 0 ? rows[i].temp : rows[i-1].temp;
var c = rows[i].temp;
for (var m = 0; m < 15; m++) {
var ts = rows[i].ts - (14-m)*60;
out.push({ time:ts, open:o, high:Math.max(o,c), low:Math.min(o,c), close:c });
}
}
return out;
}

function omToH1(d) {
var times = d.hourly && d.hourly.time;
var temps = d.hourly && d.hourly.temperature_2m;
if (!times || !temps) return [];
var rows = [];
for (var i = 0; i < times.length; i++) {
if (temps[i] === null || temps[i] === undefined) continue;
rows.push({ ts: Math.floor(new Date(times[i] + “:00Z”).getTime()/1000), temp: temps[i] });
}
return rows.map(function(r, i) {
var o = i===0 ? r.temp : rows[i-1].temp;
var c = r.temp;
return { time:r.ts, open:o, high:Math.max(o,c), low:Math.min(o,c), close:c };
});
}

function tmrToCandles(d, key) {
var rows = (d.timelines && d.timelines[key]) || [];
var mapped = rows.map(function(r) {
return { ts: Math.floor(new Date(r.time).getTime()/1000), temp: r.values.temperature };
});
return mapped.map(function(r,i) {
var o = i===0 ? r.temp : mapped[i-1].temp;
var c = r.temp;
return { time:r.ts, open:o, high:Math.max(o,c), low:Math.min(o,c), close:c };
});
}

function mergeCandles(a, b) {
var map = {};
a.forEach(function(c) { map[c.time] = c; });
b.forEach(function(c) { if (!map[c.time]) map[c.time] = c; });
return Object.values(map).sort(function(x,y) { return x.time-y.time; });
}

function findAnchorOpen(candles, anchorTs) {
var sec = anchorTs.getTime() / 1000;
var m = candles.find(function(c) { return Math.abs(c.time - sec) < 960; });
return m ? m.open : (candles.length ? candles[0].open : null);
}

function showErr(msg) {
var el = document.getElementById(“err-box”);
el.textContent = msg;
el.style.display = “block”;
setTimeout(function() { el.style.display = “none”; }, 8000);
}

function loadAll() {
setStatus(“FETCHING…”);
htfAnchorTs = getMidnightUTC();
ltfAnchorTs = get0900UTC();

var p1 = fetchOpenMeteo();
var p2 = fetchTmrForecast().catch(function(e) { showErr(“Forecast: “+e.message); return null; });

Promise.all([p1, p2]).then(function(results) {
var omData = results[0], tmrData = results[1];

```
var histM1 = om15ToM1(omData);
var histH1 = omToH1(omData);
var foreM1 = tmrData ? tmrToCandles(tmrData, "minutely") : [];
var foreH1 = tmrData ? tmrToCandles(tmrData, "hourly")   : [];

m1Candles = mergeCandles(histM1, foreM1);
h1Candles = mergeCandles(histH1, foreH1);

htfAnchorOpen = findAnchorOpen(h1Candles, htfAnchorTs);
ltfAnchorOpen = findAnchorOpen(m1Candles, ltfAnchorTs);

var now = Date.now()/1000;
var cur = null;
for (var i = m1Candles.length-1; i >= 0; i--) {
  if (m1Candles[i].time <= now) { cur = m1Candles[i]; break; }
}
if (cur) document.getElementById("hdr-temp").textContent = cur.close.toFixed(1) + "C";

var candles = chartMode === "HTF" ? h1Candles : m1Candles;
candleSeries.setData(candles);
reloadLevels();

var visible = candles.filter(function(c) { return c.time <= now; });
if (visible.length) {
  var last = visible[visible.length-1];
  lwChart.timeScale().setVisibleRange({
    from: last.time - (chartMode==="HTF" ? 3600*12 : 60*120),
    to:   last.time + (chartMode==="HTF" ? 3600*4  : 60*60)
  });
}
setStatus(tmrData ? "LIVE - OPEN-METEO + TMR" : "LIVE - OPEN-METEO");
```

}).catch(function(e) {
console.error(e);
setStatus(“ERROR”);
showErr(e.message);
});
}

function switchMode(mode) {
chartMode = mode;
[“ltf-ratio”,“ltf-both”,“htf”].forEach(function(id) {
var el = document.getElementById(“btn-”+id);
if (el) el.classList.remove(“active”);
});
var btnId = mode===“LTF_RATIO”?“ltf-ratio”:mode===“LTF_BOTH”?“ltf-both”:“htf”;
var el = document.getElementById(“btn-”+btnId);
if (el) el.classList.add(“active”);
var candles = mode === “HTF” ? h1Candles : m1Candles;
if (candles.length) { candleSeries.setData(candles); reloadLevels(); }
}

function setStatus(s) { document.getElementById(“bar-status”).textContent = s; }

window.addEventListener(“load”, function() {
buildChart();
requestAnimationFrame(function() { setTimeout(function() { window.dispatchEvent(new Event(“resize”)); }, 150); });
setInterval(function() {
document.getElementById(“bar-time”).textContent = new Date().toUTCString().slice(5,22).toUpperCase()+” UTC”;
}, 1000);
loadAll();
setInterval(loadAll, CFG.refreshSec * 1000);
});
</script>

</body>
</html>