<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>WX London</title>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;background:#050f05;overflow:hidden}
body{color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:11px;-webkit-text-size-adjust:100%;cursor:crosshair}
#app{display:flex;flex-direction:column;height:100%;min-height:100dvh}
.bar{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:0 10px;height:24px;background:#070d07;font-size:10px;letter-spacing:2px;text-transform:uppercase;border-bottom:1px solid #0f2a0f}
.bar.bot{border-top:1px solid #0f2a0f;border-bottom:none;padding-top:5px;padding-bottom:calc(env(safe-area-inset-bottom)+5px);height:auto}
.bar.top{padding-top:env(safe-area-inset-top);height:calc(24px + env(safe-area-inset-top))}
a{color:#004a14;font-size:9px;letter-spacing:2px;text-decoration:none;margin-left:8px}
.dot{width:5px;height:5px;border-radius:50%;background:#00cc33;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.2}}
.ctrl{flex-shrink:0;display:flex;height:22px;background:#070d07;border-bottom:1px solid #0f2a0f}
.tb{background:#070d07;border:none;border-right:1px solid #0f2a0f;color:#003a10;font-family:"Share Tech Mono",monospace;font-size:10px;letter-spacing:2px;padding:0 12px;cursor:pointer;-webkit-appearance:none}
.tb.on{color:#00cc33;background:#0a160a}
.shell{flex:1;min-height:0;position:relative;overflow:hidden}
#chart{width:100%;height:100%}
#err{display:none;position:absolute;top:8px;left:8px;right:8px;background:#1a0000;border:1px solid #cc0000;color:#ff4444;font-size:9px;padding:8px;z-index:99;word-break:break-all}
</style>
</head>
<body>
<div id="app">
  <div class="bar top">
    <span style="letter-spacing:4px;color:#00cc33">WX LONDON</span>
    <div><a href="index.html">BTC</a><a href="backtest.html">BT</a><a href="forwardtest.html">FT</a><a href="wxbacktest.html">WXB</a></div>
    <div style="display:flex;align-items:center;gap:8px"><span id="hdr">--</span><div class="dot"></div></div>
  </div>
  <div class="ctrl">
    <button class="tb on" id="b0" onclick="sw('LR')">M1 RATIO</button>
    <button class="tb" id="b1" onclick="sw('LB')">M1 BOTH</button>
    <button class="tb" id="b2" onclick="sw('H')">HTF</button>
  </div>
  <div class="shell">
    <div id="chart"></div>
    <div id="err"></div>
  </div>
  <div class="bar bot"><span id="st">LOADING...</span></div>
</div>
<script type="text/javascript">
var TMR = "geHqAXyAgDTGlnyKJGK0wJX4RiBrpHeU";
var LAT = 51.5048, LON = 0.0495;
var RATIO = 60;
var mode = "LR";
var chart, cs, lev = {};
var m1 = [], h1 = [];
var htfTs, ltfTs, htfO, ltfO;

// Safari-safe: “2026-02-26T00:00” needs seconds
function pt(s) {
if (!s) return new Date(NaN);
if (s.length > 16) return new Date(s);
return new Date(s + “:00Z”);
}

function midnight() {
var n = new Date();
return new Date(Date.UTC(n.getUTCFullYear(), n.getUTCMonth(), n.getUTCDate()));
}
function h9() {
var n = new Date();
var a = new Date(Date.UTC(n.getUTCFullYear(), n.getUTCMonth(), n.getUTCDate(), 9));
if (a > n) a.setUTCDate(a.getUTCDate() - 1);
return a;
}
function fv(anchor, bars, deg, ratio) {
return anchor + bars * (ratio||1) * Math.tan(deg * Math.PI / 180);
}

var LDEFS = {
HTF:  [{l:“EQ”,d:0,c:”#ffffff”},{l:”+27”,d:27,c:”#00ff41”},{l:”-27”,d:-27,c:”#ff3131”},{l:”+45”,d:45,c:”#00ff41”},{l:”-45”,d:-45,c:”#ff3131”},{l:”+60”,d:60,c:”#00ff41”},{l:”-60”,d:-60,c:”#ff3131”},{l:”+72”,d:72,c:”#ffb300”},{l:”-72”,d:-72,c:”#ffb300”},{l:”+78”,d:78,c:”#ffb300”},{l:”-78”,d:-78,c:”#ffb300”}],
HTF_R:[{l:“EQ”,d:0,c:”#ffffff”},{l:”+27”,d:27,c:”#ffb300”},{l:”-27”,d:-27,c:”#ff00ff”},{l:”+45”,d:45,c:”#ffb300”},{l:”-45”,d:-45,c:”#ff00ff”},{l:”+60”,d:60,c:”#ffb300”},{l:”-60”,d:-60,c:”#ff00ff”},{l:”+72”,d:72,c:”#ffdd00”},{l:”-72”,d:-72,c:”#ffdd00”},{l:”+78”,d:78,c:”#ffdd00”},{l:”-78”,d:-78,c:”#ffdd00”}],
LTF:  [{l:“EQ”,d:0,c:”#aaaaaa”},{l:”+27”,d:27,c:”#00cc33”},{l:”-27”,d:-27,c:”#cc2222”},{l:”+45”,d:45,c:”#00cc33”},{l:”-45”,d:-45,c:”#cc2222”},{l:”+60”,d:60,c:”#00cc33”},{l:”-60”,d:-60,c:”#cc2222”},{l:”+72”,d:72,c:”#dd9900”},{l:”-72”,d:-72,c:”#dd9900”},{l:”+78”,d:78,c:”#dd9900”},{l:”-78”,d:-78,c:”#dd9900”}]
};

function buildChart() {
var el = document.getElementById(“chart”);
var par = el.parentElement;
function gh() { return par.getBoundingClientRect().height || window.innerHeight - 70; }
chart = LightweightCharts.createChart(el, {
width:el.clientWidth, height:gh(),
layout:{background:{color:”#050f05”},textColor:”#006618”,fontSize:10},
grid:{vertLines:{color:”#0c1a0c”},horzLines:{color:”#0c1a0c”}},
crosshair:{mode:LightweightCharts.CrosshairMode.Normal,
vertLine:{color:”#00ff4166”,width:1,style:3,labelBackgroundColor:”#051405”},
horzLine:{color:”#00ff4166”,width:1,style:3,labelBackgroundColor:”#051405”}},
rightPriceScale:{borderColor:”#0f2a0f”,textColor:”#006618”,scaleMargins:{top:.08,bottom:.08}},
timeScale:{borderColor:”#0f2a0f”,timeVisible:true,secondsVisible:false},
localization:{priceFormatter:function(p){return p.toFixed(2)+“C”}}
});
cs = chart.addCandlestickSeries({upColor:”#00ff41”,downColor:”#ff3131”,borderUpColor:”#00ff41”,borderDownColor:”#ff3131”,wickUpColor:”#00aa2a”,wickDownColor:”#aa1111”});
var t;
function rs(){clearTimeout(t);t=setTimeout(function(){chart.applyOptions({width:el.clientWidth,height:gh()});},80);}
window.addEventListener(“resize”,rs);
if(window.visualViewport)window.visualViewport.addEventListener(“resize”,rs);
}

function clrLev() {
Object.values(lev).forEach(function(s){try{chart.removeSeries(s);}catch(e){}});
lev={};
}

function drawSet(candles, aTs, aOpen, type, ratio) {
if (!aOpen || candles.length < 2) return;
var defs = LDEFS[type] || [];
var aSec = aTs.getTime()/1000;
var spb = (type===“HTF”||type===“HTF_R”) ? 3600 : 60;
var filt = candles.filter(function(c){return c.time >= aSec;});
if (filt.length < 2) return;
var last = filt[filt.length-1];
var n = new Date();
var endSec = new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),23,59)).getTime()/1000;
var fut = [];
for (var t = last.time+60; t <= endSec; t+=60) fut.push(t);
defs.forEach(function(def){
var data = filt.map(function(c){return{time:c.time,value:fv(aOpen,Math.floor((c.time-aSec)/spb),def.d,ratio||1)};});
fut.forEach(function(t){data.push({time:t,value:fv(aOpen,Math.floor((t-aSec)/spb),def.d,ratio||1)});});
var pfx=type===“HTF_R”?“R”:type===“HTF”?“H”:“L”;
var s=chart.addLineSeries({color:def.c,lineWidth:1,lineStyle:type===“LTF”?2:0,priceLineVisible:false,lastValueVisible:true,title:pfx+def.l,crosshairMarkerVisible:false});
s.setData(data);
lev[type+”_”+def.l]=s;
});
}

function reload() {
clrLev();
var c = mode===“H” ? h1 : m1;
if (mode===“H”) {
drawSet(c,htfTs,htfO,“HTF”,1);
drawSet(c,htfTs,htfO,“HTF_R”,RATIO);
drawSet(c,ltfTs,ltfO,“LTF”,1);
} else if (mode===“LR”) {
drawSet(c,htfTs,htfO,“HTF_R”,RATIO);
drawSet(c,ltfTs,ltfO,“LTF”,1);
} else {
drawSet(c,htfTs,htfO,“HTF”,1);
drawSet(c,htfTs,htfO,“HTF_R”,RATIO);
drawSet(c,ltfTs,ltfO,“LTF”,1);
}
}

function omTo15(d) {
var times=(d.minutely_15&&d.minutely_15.time)||[];
var temps=(d.minutely_15&&d.minutely_15.temperature_2m)||[];
var rows=[];
for(var i=0;i<times.length;i++){
if(temps[i]==null)continue;
rows.push({ts:Math.floor(pt(times[i]).getTime()/1000),temp:temps[i]});
}
var out=[];
for(var i=0;i<rows.length;i++){
var o=i===0?rows[i].temp:rows[i-1].temp,c=rows[i].temp;
for(var m=0;m<15;m++) out.push({time:rows[i].ts-(14-m)*60,open:o,high:Math.max(o,c),low:Math.min(o,c),close:c});
}
return out;
}
function omToH1(d) {
var times=(d.hourly&&d.hourly.time)||[];
var temps=(d.hourly&&d.hourly.temperature_2m)||[];
var rows=[];
for(var i=0;i<times.length;i++){
if(temps[i]==null)continue;
rows.push({ts:Math.floor(pt(times[i]).getTime()/1000),temp:temps[i]});
}
return rows.map(function(r,i){var o=i===0?r.temp:rows[i-1].temp,c=r.temp;return{time:r.ts,open:o,high:Math.max(o,c),low:Math.min(o,c),close:c};});
}
function tmrTo(rows) {
return rows.map(function(r,i,a){var o=i===0?r.values.temperature:a[i-1].values.temperature,c=r.values.temperature;return{time:Math.floor(new Date(r.time).getTime()/1000),open:o,high:Math.max(o,c),low:Math.min(o,c),close:c};});
}
function merge(a,b){
var map={};
a.forEach(function(c){map[c.time]=c;});
b.forEach(function(c){if(!map[c.time])map[c.time]=c;});
return Object.values(map).sort(function(x,y){return x.time-y.time;});
}
function anchorOpen(candles,ts){
var sec=ts.getTime()/1000;
for(var i=0;i<candles.length;i++){if(Math.abs(candles[i].time-sec)<960)return candles[i].open;}
return candles.length?candles[0].open:null;
}
function showErr(s){var e=document.getElementById(“err”);e.textContent=s;e.style.display=“block”;setTimeout(function(){e.style.display=“none”;},10000);}

function load() {
document.getElementById(“st”).textContent = “FETCHING…”;
htfTs = midnight(); ltfTs = h9();

var omUrl = “https://api.open-meteo.com/v1/forecast?latitude=”+LAT+”&longitude=”+LON
+”&minutely_15=temperature_2m&hourly=temperature_2m”
+”&temperature_unit=celsius&timezone=UTC&past_days=3&forecast_days=2”;
var tmrUrl = “https://api.tomorrow.io/v4/weather/forecast?location=”+LAT+”,”+LON
+”&fields=temperature&timesteps=1m,1h&units=metric&apikey=”+TMR;

var p1 = fetch(omUrl).then(function(r){if(!r.ok)throw new Error(“OM “+r.status);return r.json();});
var p2 = fetch(tmrUrl).then(function(r){if(!r.ok)throw new Error(“TMR “+r.status);return r.json();}).catch(function(e){showErr(e.message);return null;});

Promise.all([p1,p2]).then(function(res){
var om=res[0],tmr=res[1];
var hm1=omTo15(om), hh1=omToH1(om);
var fm1=tmr&&tmr.timelines&&tmr.timelines.minutely?tmrTo(tmr.timelines.minutely):[];
var fh1=tmr&&tmr.timelines&&tmr.timelines.hourly?tmrTo(tmr.timelines.hourly):[];
m1=merge(hm1,fm1); h1=merge(hh1,fh1);
htfO=anchorOpen(h1,htfTs); ltfO=anchorOpen(m1,ltfTs);

```
var now=Date.now()/1000;
for(var i=m1.length-1;i>=0;i--){if(m1[i].time<=now){document.getElementById("hdr").textContent=m1[i].close.toFixed(1)+"C";break;}}

var c=mode==="H"?h1:m1;
cs.setData(c); reload();

var vis=c.filter(function(x){return x.time<=now;});
if(vis.length){var last=vis[vis.length-1];chart.timeScale().setVisibleRange({from:last.time-(mode==="H"?43200:7200),to:last.time+(mode==="H"?14400:3600)});}
document.getElementById("st").textContent=tmr?"LIVE OM+TMR":"LIVE OPEN-METEO";
```

}).catch(function(e){document.getElementById(“st”).textContent=“ERROR”;showErr(e.message);});
}

function sw(m) {
mode=m;
[“b0”,“b1”,“b2”].forEach(function(id){var el=document.getElementById(id);if(el)el.classList.remove(“on”);});
var idx=m===“LR”?“b0”:m===“LB”?“b1”:“b2”;
document.getElementById(idx).classList.add(“on”);
var c=m===“H”?h1:m1;
if(c.length){cs.setData(c);reload();}
}

window.onerror=function(msg,src,line){document.getElementById(“st”).textContent=“ERR L”+line+”: “+msg;return false;};

window.addEventListener(“load”,function(){
buildChart();
setTimeout(function(){window.dispatchEvent(new Event(“resize”));},100);
setInterval(load, 300000);
load();
});
</script>

</body>
</html>