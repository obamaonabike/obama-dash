<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>WX London</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#050f05;color:#00cc33;font-family:"Share Tech Mono",monospace;font-size:11px;min-height:100dvh;-webkit-text-size-adjust:100%}
.bar{display:flex;align-items:center;justify-content:space-between;padding:0 10px;height:24px;background:#070d07;font-size:10px;letter-spacing:2px;text-transform:uppercase;border-bottom:1px solid #0f2a0f}
.bar.bot{border-top:1px solid #0f2a0f;border-bottom:none;padding-bottom:env(safe-area-inset-bottom)}
a{color:#004a14;font-size:9px;letter-spacing:2px;text-decoration:none;margin-left:8px}
.dot{width:6px;height:6px;border-radius:50%;background:#00cc33;display:inline-block;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.2}}
.content{padding:12px;overflow-y:auto}
.sec{font-size:9px;color:#006618;letter-spacing:3px;padding:10px 0 4px;border-bottom:1px solid #0f2a0f;margin-bottom:8px;text-transform:uppercase}
.big{font-size:52px;letter-spacing:2px;color:#00ff41;line-height:1;margin:8px 0}
.sub{font-size:10px;color:#006618;letter-spacing:2px;margin-bottom:4px}
.brackets{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:10px 0}
.bkt{background:#070d07;border:2px solid #0f2a0f;padding:14px 10px;text-align:center}
.bkt.hot{border-color:#00cc33;background:#030f03}
.bkt-val{font-size:28px;color:#00ff41;letter-spacing:1px}
.bkt-lbl{font-size:8px;color:#006618;letter-spacing:2px;margin-top:4px}
.bkt.hot .bkt-lbl{color:#00cc33}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:8px 0}
.card{background:#070d07;border:1px solid #0f2a0f;padding:10px}
.clbl{font-size:8px;color:#006618;letter-spacing:2px;margin-bottom:4px}
.cval{font-size:18px;letter-spacing:1px}
.csub{font-size:8px;color:#004a14;margin-top:2px}
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin:8px 0}
table{width:100%;border-collapse:collapse;margin-bottom:10px;font-size:9px}
th{color:#004a14;padding:4px;border-bottom:1px solid #0f2a0f;text-align:left;font-size:8px;letter-spacing:1px}
td{padding:4px;border-bottom:1px solid #0a1a0a}
.hi{color:#00ff41}.ok{color:#00cc33}.dim{color:#006618}.no{color:#444}
.err{color:#ff4444;font-size:9px;margin:8px 0;word-break:break-all}
#cur-temp{font-size:13px;color:#00cc33;letter-spacing:1px}
</style>
</head>
<body>
<div class="bar">
  <span style="letter-spacing:4px;color:#00cc33">WX LONDON</span>
  <div><a href="index.html">BTC</a><a href="backtest.html">BT</a><a href="wxbacktest.html">WXB</a><a href="wxbacktest2.html">WXB2</a><a href="wxbacktest3.html">WXB3</a></div>
  <div style="display:flex;align-items:center;gap:6px"><span id="cur-temp">--</span><div class="dot"></div></div>
</div>
<div class="content">

  <div class="sec">// TODAY'S PREDICTION</div>
  <div class="sub" id="anchor-lbl">ANCHOR @ 09:00 UTC: --</div>
  <div class="big" id="pred-hi">--</div>
  <div class="sub">PREDICTED DAILY HIGH (C) - +27 FAN @ 13H UTC</div>
  <div id="err-msg" class="err" style="display:none"></div>

  <div class="sec">// BET THESE BRACKETS</div>
  <div class="sub" style="margin-bottom:8px;font-size:8px;color:#004a14">DUAL BRACKET STRATEGY - 83% HIT RATE OVER 143 DAYS</div>
  <div class="brackets">
    <div class="bkt hot" id="bkt-lo">
      <div class="bkt-val" id="bkt-lo-val">--</div>
      <div class="bkt-lbl">FLOOR BRACKET</div>
    </div>
    <div class="bkt hot" id="bkt-hi">
      <div class="bkt-val" id="bkt-hi-val">--</div>
      <div class="bkt-lbl">CEIL BRACKET</div>
    </div>
  </div>

  <div class="sec">// CONFIDENCE</div>
  <div class="grid2">
    <div class="card">
      <div class="clbl">AVG ERROR</div>
      <div class="cval" id="avg-err">0.56C</div>
      <div class="csub">143 DAY BACKTEST</div>
    </div>
    <div class="card">
      <div class="clbl">WITHIN 1C</div>
      <div class="cval hi">87%</div>
      <div class="csub">OCT 25 - FEB 26</div>
    </div>
    <div class="card">
      <div class="clbl">THIS MONTH</div>
      <div class="cval hi" id="mo-acc">65%</div>
      <div class="csub">EXACT BRACKET</div>
    </div>
    <div class="card">
      <div class="clbl">DUAL BRACKET</div>
      <div class="cval hi">83%</div>
      <div class="csub">HIT RATE</div>
    </div>
  </div>

  <div class="sec">// RECENT DAYS</div>
  <table>
    <thead><tr><th>DATE</th><th>ANC</th><th>ACTUAL HI</th><th>PRED</th><th>ERR</th><th>OK</th></tr></thead>
    <tbody id="recent-tbl"></tbody>
  </table>

  <div class="sec">// SETTINGS</div>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
    <span style="font-size:9px;color:#006618;letter-spacing:1px;min-width:160px">PREDICT HI AT HOUR</span>
    <input id="cfg-phi" type="number" value="13" min="0" max="23" style="background:#030803;border:1px solid #0f2a0f;color:#00cc33;font-family:'Share Tech Mono',monospace;font-size:10px;padding:4px 6px;width:60px">
  </div>
  <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
    <span style="font-size:9px;color:#006618;letter-spacing:1px;min-width:160px">HTF RATIO</span>
    <input id="cfg-ratio" type="number" value="60" min="1" style="background:#030803;border:1px solid #0f2a0f;color:#00cc33;font-family:'Share Tech Mono',monospace;font-size:10px;padding:4px 6px;width:60px">
  </div>
  <button onclick="load()" style="background:#030803;border:1px solid #00cc33;color:#00cc33;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;padding:6px 16px;cursor:pointer;-webkit-appearance:none;margin-bottom:10px">REFRESH</button>

</div>
<div class="bar bot"><span id="bst">LOADING...</span></div>

<script type="text/javascript">
var ANGLES = [27,-27,45,-45,60,-60,72,-72,78,-78];

function pt(s) {
  if (!s) return new Date(NaN);
  if (s.length > 16) return new Date(s);
  return new Date(s + ":00Z");
}
function fan(aT, hrs, deg, ratio) {
  return aT + hrs * ratio * Math.tan(deg * Math.PI / 180);
}
function setStatus(s){ document.getElementById("bst").textContent = s; }
function showErr(s){ var e=document.getElementById("err-msg"); e.textContent=s; e.style.display="block"; }

function load() {
  var phi   = parseInt(document.getElementById("cfg-phi").value) || 13;
  var ratio = parseFloat(document.getElementById("cfg-ratio").value) || 60;
  var ANC   = 9;

  setStatus("FETCHING...");
  document.getElementById("err-msg").style.display = "none";

  // Forecast for current temp + recent history for recent-days table
  var fcastUrl = "https://api.open-meteo.com/v1/forecast"
    + "?latitude=51.5048&longitude=0.0495"
    + "&hourly=temperature_2m"
    + "&daily=temperature_2m_max"
    + "&temperature_unit=celsius&timezone=UTC"
    + "&past_days=14&forecast_days=1";

  // Archive for monthly stats (last 90 days)
  var now = new Date();
  var mo  = now.toISOString().slice(0,7);
  var archStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth()-3, 1)).toISOString().slice(0,10);
  var archEnd   = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()-1)).toISOString().slice(0,10);

  fetch(fcastUrl)
    .then(function(r){ if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
    .then(function(d){
      var ht = (d.hourly&&d.hourly.time)||[];
      var hv = (d.hourly&&d.hourly.temperature_2m)||[];
      var dt = (d.daily&&d.daily.time)||[];
      var dv = (d.daily&&d.daily.temperature_2m_max)||[];

      if (!ht.length) throw new Error("No data");

      // Current temp (latest non-null hourly)
      var curTemp = null;
      for (var i=hv.length-1;i>=0;i--){ if(hv[i]!=null){curTemp=hv[i];break;} }
      if (curTemp!=null) document.getElementById("cur-temp").textContent = curTemp.toFixed(1)+"C";

      // Build hourly lookup
      var hr=[];
      for(var i=0;i<ht.length;i++){ if(hv[i]!=null) hr.push({t:pt(ht[i]),v:hv[i]}); }

      // Today's anchor temp
      var today = new Date();
      var ancTime = new Date(Date.UTC(today.getUTCFullYear(),today.getUTCMonth(),today.getUTCDate(),ANC));
      var ae = null;
      for(var i=0;i<hr.length;i++){ if(Math.abs(hr[i].t-ancTime)<1800000){ae=hr[i];break;} }

      if (!ae) { showErr("Anchor temp not yet available (before 09:00 UTC)"); setStatus("WAITING FOR ANCHOR"); return; }

      var aT   = ae.v;
      var phiH = phi - ANC; if(phiH<=0) phiH+=24;

      // Best prediction (nearest fan to what we expect - use +27 as primary, find best vs recent avg)
      var bestErr=Infinity, bestPred=null, bestAngle=null;
      ANGLES.forEach(function(deg){
        var p1=fan(aT,phiH,deg,1), p2=fan(aT,phiH/ratio,deg,ratio);
        // We don't know actual yet - just show +27 prediction as primary
        if(deg===27){
          bestPred = Math.abs(p1-aT) < Math.abs(p2-aT) ? p2 : p1;
          bestAngle = 27;
        }
      });

      // Use +27 fan with ratio (this was best over 143 days)
      var pred27 = fan(aT, phiH/ratio, 27, ratio);
      var pred27s = fan(aT, phiH, 27, 1);
      // Pick the one that's more reasonable (closer to anchor)
      var pred = pred27;

      document.getElementById("anchor-lbl").textContent = "ANCHOR @ 0"+ANC+":00 UTC: "+aT.toFixed(1)+"C";
      document.getElementById("pred-hi").textContent    = pred.toFixed(1)+"C";

      var lo = Math.floor(pred), hi2 = lo+1;
      document.getElementById("bkt-lo-val").textContent = lo+"C";
      document.getElementById("bkt-hi-val").textContent = hi2+"C";

      // Recent days table
      var tbody = document.getElementById("recent-tbl");
      tbody.innerHTML = "";
      var daily = {};
      for(var i=0;i<dt.length;i++){ if(dv[i]!=null) daily[dt[i]]=dv[i]; }

      var shown=0;
      for(var i=dt.length-1;i>=0&&shown<10;i--){
        var ds=dt[i], actualHi=daily[ds];
        if(actualHi==null) continue;
        var parts=ds.split("-");
        var ancT2=new Date(Date.UTC(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]),ANC));
        // skip today
        if(Math.abs(ancT2-ancTime)<60000) continue;
        var ae2=null;
        for(var j=0;j<hr.length;j++){ if(Math.abs(hr[j].t-ancT2)<1800000){ae2=hr[j];break;} }
        if(!ae2) continue;
        var aT2=ae2.v;
        var p=fan(aT2,phiH/ratio,27,ratio);
        var err=Math.abs(actualHi-p);
        var correct=Math.round(p)===Math.round(actualHi);
        var tr=document.createElement("tr");
        tr.innerHTML="<td>"+ds+"</td>"
          +"<td>"+aT2.toFixed(1)+"</td>"
          +"<td class='hi'>"+actualHi.toFixed(1)+"("+Math.round(actualHi)+"C)</td>"
          +"<td>"+p.toFixed(1)+"("+Math.round(p)+"C)</td>"
          +"<td class='"+(err<=0.5?"hi":err<=1?"ok":"dim")+"'>"+err.toFixed(2)+"C</td>"
          +"<td class='"+(correct?"ok":"no")+"'>"+(correct?"Y":"N")+"</td>";
        tbody.appendChild(tr);
        shown++;
      }

      setStatus("UPDATED "+new Date().toUTCString().slice(5,22).toUpperCase()+" UTC");
    })
    .catch(function(e){
      showErr("ERROR: "+e.message);
      setStatus("ERROR");
    });
}

window.addEventListener("load", function(){
  load();
  setInterval(load, 300000); // refresh every 5min
});
</script>

</body>
</html>